<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LXJ5Q7LKKE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-LXJ5Q7LKKE');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hero Score  Tracking</title>
    <link rel="icon" type="image/png" href="icons/favicon.webp">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style">
    <link rel="stylesheet" href="./styles.css">
    <script src="/js/config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="title-container">
        <h1 class="title-header">
            <a href="index.html" class="home-link">
                <i class="fas fa-home"></i>
            </a>
            Hero Score Tracking
            <span class="tournament-badge">Main 62</span>
        </h1>
    </div>
    <div id="search-container" style="display: flex; align-items: center;">
        <button class="button-group button-group--yellow" id="my-favorites-group">
            <span class="button-label">My Favorites</span>
            <i class="fa-regular fa-star"></i>
        </button>
        <input type="text" id="hero-search-box" class="search-box" placeholder="Search Heroes">
        <span class="clear-search"></span>
    </div>
    <div class="small-text">
        <span id="timestamp">2025-07-29 00:54 UTC</span>
        | Status: live
        <span class="info-text"> | Most recent score first</span>
    </div>
    <div class="table-container" style="display: flex; flex-direction: column; flex: 1; justify-content: flex-start;">
        <table id="heroesTable">
    <tr>
        <th class="rank-column" data-sort="rank">
            <div class="sort-arrows"><span class="sort-arrow up"></span><span class="sort-arrow down"></span></div>
        </th>
        <th class="hero-column" style="text-align: left; min-width: max-content;">Hero</th>
        <th class="rank-column" data-sort="views">
            Views <div class="sort-arrows"><span class="sort-arrow up"></span><span class="sort-arrow down"></span></div>
        </th>
        <th class="rank-column" data-sort="posts">
            Posts <div class="sort-arrows"><span class="sort-arrow up"></span><span class="sort-arrow down"></span></div>
        </th>
        <th data-sort="4htrend">
            4h Trend <div class="sort-arrows"><span class="sort-arrow up"></span><span class="sort-arrow down"></span></div>
        </th>
        <th data-sort="8htrend">
            8h Trend <div class="sort-arrows"><span class="sort-arrow up"></span><span class="sort-arrow down"></span></div>
        </th>
        <!-- Timestamp columns will be added dynamically -->
    </tr>
</table>
    <div class="hash-comparison" style="margin-top: 20px;">
        <h3>Score Distribution Hashes</h3>
        <table id="hashTable">
            <tr>
                <th>Timestamp</th>
                <th>Hashed Scores</th>
                <th>Changed From Previous</th>
            </tr>

        <tr>
            <td>2025-07-28 14:54:24.203388+00:00</td>
            <td>1809024182339520871</td>
            <td class="initial">Initial</td>
        </tr>
    
        <tr>
            <td>2025-07-28 15:54:19.079781+00:00</td>
            <td>6101928080721129388</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 16:54:10.604622+00:00</td>
            <td>5135593327759256458</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 17:24:12.208107+00:00</td>
            <td>7956317753880136455</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 17:54:20.769767+00:00</td>
            <td>1612223159537579561</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 18:24:12.685424+00:00</td>
            <td>8272211647056589146</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 18:54:13.574590+00:00</td>
            <td>1506439668364926574</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 19:24:10.729377+00:00</td>
            <td>2421013581356566860</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 19:54:10.110889+00:00</td>
            <td>2421013581356566860</td>
            <td class="no-change">No Change</td>
        </tr>
    
        <tr>
            <td>2025-07-28 20:24:18.165525+00:00</td>
            <td>1838039086181615225</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 20:54:08.049349+00:00</td>
            <td>7974664610637133326</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 21:24:12.552340+00:00</td>
            <td>6101928080721129388</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 21:54:10.942192+00:00</td>
            <td>225354678866350720</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 22:24:11.404001+00:00</td>
            <td>6356268863914403075</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 22:54:11.774462+00:00</td>
            <td>6517953619477702055</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 23:24:11.107215+00:00</td>
            <td>9050886695914382167</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-28 23:54:12.767651+00:00</td>
            <td>1302614914805512450</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-29 00:24:08.738359+00:00</td>
            <td>2157147142352565066</td>
            <td class="changed">Changed</td>
        </tr>
    
        <tr>
            <td>2025-07-29 00:54:12.387309+00:00</td>
            <td>7248500506616156940</td>
            <td class="changed">Changed</td>
        </tr>
    
    </table>
    </div>
    <style>
        .hash-comparison {
            margin: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        .changed {
            color: #27ae60;
            font-weight: bold;
        }
        .no-change {
            color: #e74c3c;
        }
        .initial {
            color: #3498db;
        }
    </style>

    </div>
    <script>
    
        const API_CONFIG = {
    BASE_URL: 'https://api-v2.fantasy.top',
    API_KEY: 'cbc57228-5495-47b0-ae2f-b43ba6d5a9b6',
    TOURNAMENT_NUMBER: 62
};

const supabaseUrl = 'https://hhcuqhvmzwmehdsaamhn.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoY3VxaHZtendtZWhkc2FhbWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzIwMTIsImV4cCI6MjA1MDU0ODAxMn0.xJNGoFLnpnmQGLj8RY_4VLmefPmFzuOyiVHLvFtPkkE';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// Fetch API heroes
async function fetchApiHeroes() {
    const response = await fetch(
        `${API_CONFIG.BASE_URL}/hero/stats?pagination.page=1&pagination.limit=200&order_by.fantasy_score=desc&tournament_number=${API_CONFIG.TOURNAMENT_NUMBER}&search=%25%25&tactic_only=false`,
        {
            headers: {
                'accept': 'application/json',
                'x-api-key': API_CONFIG.API_KEY
            }
        }
    );
    if (!response.ok) throw new Error('API fetch failed');
    const result = await response.json();
    return result.data || [];
}

// Fetch Supabase scores
async function fetchSupabaseScores() {
    const { data, error } = await supabaseClient
        .from('vwtournament_score_tracking_current')
        .select('hero_handle, start_datetime, fan_score');
    if (error) throw new Error('Supabase fetch failed');
    return data || [];
}

// Merge API and Supabase data
function mergeHeroScores(apiHeroes, supabaseScores) {
    // Map: hero_handle -> {timestamp: fan_score}
    const scoreMap = {};
    for (const row of supabaseScores) {
        if (!scoreMap[row.hero_handle]) scoreMap[row.hero_handle] = {};
        scoreMap[row.hero_handle][row.start_datetime] = row.fan_score;
    }
    // All unique timestamps, sorted
    let allTimestamps = Array.from(
        new Set(supabaseScores.map(row => row.start_datetime))
    ).sort();
    // Reverse for most recent left, oldest right
    allTimestamps = allTimestamps.reverse();
    // Attach scores to each hero
    const merged = apiHeroes.map(hero => {
        const handle = hero.handle;
        const scores = scoreMap[handle] || {};
        return { ...hero, scores };
    });
    return { merged, allTimestamps };
}

// Render the table
function renderHeroMatrixTable(heroes, timestamps) {
    const table = document.getElementById('heroesTable');
    if (!table) return;

    // Update header: keep first 6 columns, then add timestamps
    const headerRow = table.rows[0];
    while (headerRow.cells.length > 6) headerRow.deleteCell(6);
    timestamps.forEach(ts => {
        const th = document.createElement('th');
        th.textContent = ts.replace('T', ' ').slice(5, 16);
        headerRow.appendChild(th);
    });

    // Remove all rows except header
    while (table.rows.length > 1) table.deleteRow(1);

    // Add a row for each hero
    for (const hero of heroes) {
        const row = table.insertRow();

        // Rank
        const rankCell = row.insertCell();
        rankCell.className = "frozen-columns";
        rankCell.textContent = hero.current_rank ?? '';

        // Hero info
        const heroCell = row.insertCell();
        heroCell.className = "hero-column frozen-columns";
        heroCell.innerHTML = `
            <img src="${hero.profile_image_url_https || ''}" class="hero-image" alt="${hero.name || hero.handle}">
            <span>${hero.name || hero.handle}</span>
            <a href="https://x.com/${hero.handle}" target="_blank" style="margin-left:6px; color:#888; font-size:0.9em; vertical-align:middle;">
                <i class="fab fa-x-twitter"></i>
            </a>
        `;

        // Views
        const viewsCell = row.insertCell();
        viewsCell.className = "frozen-columns";
        let formattedViews = '';
        if (typeof hero.views === 'number') {
            if (hero.views >= 1_000_000) formattedViews = (hero.views / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
            else if (hero.views >= 1_000) formattedViews = (hero.views / 1_000).toFixed(0) + 'K';
            else formattedViews = hero.views.toString();
        } else {
            formattedViews = hero.views ?? '';
        }
        viewsCell.textContent = formattedViews;

        // Posts
        const postsCell = row.insertCell();
        postsCell.className = "frozen-columns";
        postsCell.textContent = hero.tweet_count ?? '';

        // Trend columns (optional, blank)
        row.insertCell();
        row.insertCell();

        // Matrix: fan_score for each timestamp
        for (const ts of timestamps) {
            const cell = row.insertCell();
            const score = hero.scores[ts];
            cell.textContent = score !== undefined ? score : '';
        }
    }
}

// Orchestrate everything on DOMContentLoaded
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const [apiHeroes, supabaseScores] = await Promise.all([
            fetchApiHeroes(),
            fetchSupabaseScores()
        ]);
        const { merged, allTimestamps } = mergeHeroScores(apiHeroes, supabaseScores);
        renderHeroMatrixTable(merged, allTimestamps);
    } catch (e) {
        console.error(e);
    }
});
    </script>
    <script src="/js/timeUtils.js" defer></script>
</body>
</html>
