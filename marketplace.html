<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LXJ5Q7LKKE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-LXJ5Q7LKKE');
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://pbs.twimg.com">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FantasySheets | Marketplace</title>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style">
    <link rel="stylesheet" href="../styles.css?v=8e4c2f">
    <link rel="icon" type="image/png" href="../icons/favicon.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .rarity-legendary { color: #ffd700; }
        .rarity-epic { color: #9400d3; }
        .rarity-rare { color: #0080ff; }
        .rarity-common { color: #808080; }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .sortable i {
            margin-left: 5px;
            opacity: 0.3;
        }
        .sortable.desc i {
            opacity: 1;
            transform: rotate(180deg);
        }
        .sortable.asc i {
            opacity: 1;
        }
        
        /* Tooltip styles */
        .listed-count {
            position: relative;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .seller-icon {
            color: #808080;
            cursor: pointer;
            font-size: 0.75em;
        }
        .seller-icon.active {
            color: #1DA1F2; /* Blue color when active */
        }
        .seller-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.95);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            width: 200px;
            display: none;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 10px; /* Add space between tooltip and icon */
        }
        /* Fix column width */
        .marketplace-table th, .marketplace-table td {
            width: auto;
            white-space: nowrap;
        }
        .marketplace-table th:nth-child(8),
        .marketplace-table th:nth-child(12),
        .marketplace-table th:nth-child(16),
        .marketplace-table th:nth-child(20) {
            width: 60px; /* Set a fixed width for the Listed columns */
        }
        /* Make tooltip stay visible */
        .seller-icon:hover ~ .seller-tooltip {
            display: block;
        }
        .seller-tooltip {
            pointer-events: auto; /* Enable interactions */
        }
        .seller-tooltip:hover {
            display: block; /* Stay visible when hovering over the tooltip itself */
        }
        .seller-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .seller-pfp {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .seller-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .seller-twitter {
            color: #1DA1F2;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }
        .seller-twitter:hover {
            text-decoration: underline;
        }
        .seller-id {
            font-size: 0.8em;
            color: #aaa;
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .copy-icon {
            cursor: pointer;
            color: #808080;
            transition: color 0.2s;
        }
        .copy-icon:hover {
            color: #1DA1F2;
        }
        .copy-feedback {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .copy-feedback.show {
            opacity: 1;
        }
        .rarity-divider {
            width: 0.1px !important; /* Force override with !important */
            min-width: 0.1px !important; /* Ensure min-width doesn't override */
            max-width: 0.1px !important; /* Ensure max-width doesn't override */
        }

        .rarity-divider-legendary, 
        .rarity-divider-epic, 
        .rarity-divider-rare, 
        .rarity-divider-common {
            width: 0.1px !important;
            min-width: 0.1px !important;
            max-width: 0.1px !important;
        }

        /* Make sure table cell widths respect our settings */
        .marketplace-table th.rarity-divider,
        .marketplace-table td.rarity-divider {
            width: 0.1px !important;
            min-width: 0.1px !important;
            max-width: 0.1px !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
        
        /* Search box styles */
        .search-container {
            margin-bottom: 15px;
            position: relative;
            max-width: 250px; /* Set a predefined width */
        }
        
        .search-input {
            width: 100%;
            padding: 7.5px 15px; /* Reduced by 25% from 10px */
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(30, 30, 30, 0.6);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
            height: 36px; /* Explicitly set height (reduced from typical ~48px) */
        }
        
        .search-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 2px rgba(29, 161, 242, 0.2);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }
        
        /* Global floors styling */
        .global-floors {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .floor-card {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .floor-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        .floor-legendary {
            background: linear-gradient(135deg, rgba(251, 231, 255, 0.15), rgba(251, 231, 255, 0.05));
            border: 1px solid rgba(251, 231, 255, 0.3);
        }
        .floor-epic {
            background: linear-gradient(135deg, rgba(241, 163, 253, 0.15), rgba(241, 163, 253, 0.05));
            border: 1px solid rgba(241, 163, 253, 0.3);
        }
        .floor-rare {
            background: linear-gradient(135deg, rgba(0, 255, 223, 0.15), rgba(0, 255, 223, 0.05));
            border: 1px solid rgba(0, 255, 223, 0.3);
        }
        .floor-common {
            background: linear-gradient(135deg, rgba(147, 255, 1, 0.15), rgba(147, 255, 1, 0.05));
            border: 1px solid rgba(147, 255, 1, 0.3);
        }
        .floor-title {
            font-size: 0.9em;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .floor-legendary .floor-title { color: #FBE7FF; }
        .floor-epic .floor-title { color: #F1A3FD; }
        .floor-rare .floor-title { color: #00FFDF; }
        .floor-common .floor-title { color: #93FF01; }
        .floor-value {
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .floor-value::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            background-image: url('../icons/eth.webp');
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .export-button {
            position: absolute;
            top: 0;
            right: 0;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .export-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .filter-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: #fff;
            font-size: 0.9em;
        }

        .filter-options {
            display: flex;
            gap: 8px;
        }

        .filter-option {
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
            font-size: 0.9em;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 30, 30, 0.6);
        }

        .filter-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .filter-option.active {
            border-color: currentColor;
            background: rgba(255, 255, 255, 0.15);
        }

        /* Style for rare and common options */
        .filter-option-rare {
            color: #00FFDF; /* Rare color */
        }

        .filter-option-common {
            color: #93FF01; /* Common color */
        }

        .filter-option-clear {
            color: #aaa;
            font-size: 0.8em;
            padding: 6px 8px;
        }
    </style>
</head>
<body>
    <div id="marketplace-container"></div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://hhcuqhvmzwmehdsaamhn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoY3VxaHZtendtZWhkc2FhbWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzIwMTIsImV4cCI6MjA1MDU0ODAxMn0.xJNGoFLnpnmQGLj8RY_4VLmefPmFzuOyiVHLvFtPkkE';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Function to toggle tooltip visibility
        function toggleTooltip(icon) {
            // Close all other open tooltips
            document.querySelectorAll('.seller-icon.active').forEach(activeIcon => {
                if (activeIcon !== icon) {
                    activeIcon.classList.remove('active');
                    activeIcon.nextElementSibling.style.display = 'none';
                }
            });
            
            // Toggle this tooltip
            const tooltip = icon.nextElementSibling;
            const isVisible = tooltip.style.display === 'block';
            
            icon.classList.toggle('active', !isVisible);
            tooltip.style.display = isVisible ? 'none' : 'block';
            
            // Close tooltip when clicking outside
            if (!isVisible) {
                const closeTooltip = function(e) {
                    if (!tooltip.contains(e.target) && e.target !== icon) {
                        icon.classList.remove('active');
                        tooltip.style.display = 'none';
                        document.removeEventListener('click', closeTooltip);
                    }
                };
                
                // Use setTimeout to avoid immediate triggering
                setTimeout(() => {
                    document.addEventListener('click', closeTooltip);
                }, 0);
            }
        }

        // Load data when page loads
        window.onload = loadMarketplaceData;

        // Helper function to format values
        function formatValue(value) {
            if (value === '-' || value === '' || value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return num >= 0.1 ? num.toFixed(2) : num.toFixed(3);
        }

        // Calculate and display global floors
        function updateGlobalFloors(heroesArray) {
            // Initialize with high values
            let lowestLegendary = Infinity;
            let lowestEpic = Infinity;
            let lowestRare = Infinity;
            let lowestCommon = Infinity;
            
            // Find the lowest floor for each rarity
            heroesArray.forEach(hero => {
                // Check legendary floor
                if (hero.legendary.floor !== '-') {
                    const legendaryFloor = parseFloat(hero.legendary.floor);
                    if (!isNaN(legendaryFloor) && legendaryFloor < lowestLegendary) {
                        lowestLegendary = legendaryFloor;
                    }
                }
                
                // Check epic floor
                if (hero.epic.floor !== '-') {
                    const epicFloor = parseFloat(hero.epic.floor);
                    if (!isNaN(epicFloor) && epicFloor < lowestEpic) {
                        lowestEpic = epicFloor;
                    }
                }
                
                // Check rare floor
                if (hero.rare.floor !== '-') {
                    const rareFloor = parseFloat(hero.rare.floor);
                    if (!isNaN(rareFloor) && rareFloor < lowestRare) {
                        lowestRare = rareFloor;
                    }
                }
                
                // Check common floor
                if (hero.common.floor !== '-') {
                    const commonFloor = parseFloat(hero.common.floor);
                    if (!isNaN(commonFloor) && commonFloor < lowestCommon) {
                        lowestCommon = commonFloor;
                    }
                }
            });
            
            // Update the UI with the lowest floors
            document.getElementById('legendary-floor').textContent = lowestLegendary === Infinity ? '-' : formatValue(lowestLegendary);
            document.getElementById('epic-floor').textContent = lowestEpic === Infinity ? '-' : formatValue(lowestEpic);
            document.getElementById('rare-floor').textContent = lowestRare === Infinity ? '-' : formatValue(lowestRare);
            document.getElementById('common-floor').textContent = lowestCommon === Infinity ? '-' : formatValue(lowestCommon);
        }

        // Fetch and display marketplace data
        async function loadMarketplaceData() {
            try {
                const { data, error } = await supabaseClient
                    .from('marketplace')
                    .select('hero_handle, hero_name, hero_pfp_url, inflation_degree, stars, score, rarity, floor, highest_bid, listed_count, db_updated,score_24hr,seller_id,seller_name,seller_handle,seller_pfp_url,seller_port_value')
                    .order('score', { ascending: false });

                if (error) throw error;

                // Update the UI with the max db_updated value
                const minDbUpdated = data.reduce((min, item) => {
                    return item.db_updated < min ? item.db_updated : min;
                }, data[0]?.db_updated || 'N/A');

                // Calculate time ago
                const timeAgo = minDbUpdated !== 'N/A' ? Math.floor((new Date() - new Date(minDbUpdated)) / 60000) : 'N/A';

                // Check if the element exists before updating
                const dbUpdatedElement = document.getElementById('db-updated');
                if (dbUpdatedElement) {
                    dbUpdatedElement.innerText = formatDate(minDbUpdated);
                } else {
                    console.warn('Element with ID "db-updated" not found.');
                }

                // Create a pivot table structure by hero
                const pivotedData = data.reduce((acc, item) => {
                    if (!acc[item.hero_handle]) {
                        acc[item.hero_handle] = {
                            hero_handle: item.hero_handle,
                            hero_name: item.hero_name,
                            hero_pfp_url: item.hero_pfp_url,
                            inflation_degree: item.inflation_degree,
                            score: item.score,
                            score_24hr: item.score_24hr,
                            stars: item.stars,
                            legendary: { floor: '-', highest_bid: '-', listed_count: '-', seller_info: null },
                            epic: { floor: '-', highest_bid: '-', listed_count: '-', seller_info: null },
                            rare: { floor: '-', highest_bid: '-', listed_count: '-', seller_info: null },
                            common: { floor: '-', highest_bid: '-', listed_count: '-', seller_info: null }
                        };
                    }
                    
                    // Update the rarity data based on the item's rarity
                    const rarityKey = item.rarity.toLowerCase();
                    acc[item.hero_handle][rarityKey] = {
                        floor: Number(item.floor).toFixed(4),
                        highest_bid: item.highest_bid || '-',
                        listed_count: item.listed_count || '-',
                        seller_info: item.listed_count && item.listed_count > 0 ? {
                            name: item.seller_name,
                            handle: item.seller_handle,
                            pfp_url: item.seller_pfp_url,
                            seller_id: item.seller_id,
                            seller_port_value: item.seller_port_value
                        } : null
                    };
                    
                    return acc;
                }, {});

                // Convert the pivoted data back to an array for rendering
                const heroesArray = Object.values(pivotedData);

                // No need to sort here since data is already sorted from the query
                const container = document.getElementById('marketplace-container');
                container.innerHTML = `
                    <style>
                        .marketplace-container {
                            position: relative;
                            padding-top: 40px;  /* Space for export button */
                            max-width: 80%;
                            margin: 0 auto;  /* Center the container */
                            width: 100%;
                        }
                        .export-button {
                            position: absolute;
                            top: 0;
                            right: 0;
                            padding: 8px 16px;
                            background: transparent;
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 4px;
                            color: #fff;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }
                        .export-button:hover {
                            background: rgba(255, 255, 255, 0.1);
                        }
                        .marketplace-table {
                            border-collapse: separate;
                            border-spacing: 0;
                            width: 100%;
                            border: none;
                            position: relative;
                            min-width: min-content;  /* Ensures table doesn't shrink below content width */
                        }
                        .marketplace-table tbody {
                            display: block;
                            max-height: calc(80vh - 80px); /* Adjust for header height */
                            overflow-y: auto;
                            scrollbar-width: thin;
                            scrollbar-color: rgba(155, 155, 155, 0.5) transparent;
                        }
                        .marketplace-table thead {
                            display: table;
                            width: calc(100% - 6px);
                            table-layout: fixed;
                        }
                        .marketplace-table tbody tr {
                            display: table;
                            width: 100%;
                            table-layout: fixed;
                        }
                        /* Make hero column twice as wide */
                        .marketplace-table th:first-child,
                        .marketplace-table td:first-child {
                            width: 200px;  /* Adjust this value based on your needs */
                        }
                        .marketplace-table tbody tr:hover {
                            background-color: rgba(255, 255, 255, 0.05) !important;  /* Use !important to override rarity section backgrounds */
                        }
                        .marketplace-table tbody::-webkit-scrollbar {
                            width: 6px;
                        }
                        .marketplace-table tbody::-webkit-scrollbar-track {
                            background: transparent;
                        }
                        .marketplace-table tbody::-webkit-scrollbar-thumb {
                            background-color: rgba(155, 155, 155, 0.5);
                            border-radius: 3px;
                        }
                        .marketplace-table thead {
                            position: sticky;
                            top: 0;
                            z-index: 1;
                            background-color: rgb(13, 17, 23);
                        }
                        .marketplace-table thead::after {
                            content: '';
                            position: absolute;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            height: 1px;
                            background: rgba(255, 255, 255, 0.1);
                        }
                        .marketplace-table thead tr:nth-child(2) {
                            position: sticky;
                            top: 37px;
                            background-color: rgb(13, 17, 23);
                        }
                        .hero-cell {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .hero-cell img {
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            object-fit: cover;
                        }
                        .rarity-section-legendary { background-color: rgba(251, 231, 255, 0.1); }
                        .rarity-section-epic { background-color: rgba(241, 163, 253, 0.1); }
                        .rarity-section-rare { background-color: rgba(0, 255, 223, 0.1); }
                        .rarity-section-common { background-color: rgba(147, 255, 1, 0.1); }
                        
                        .rarity-divider-legendary { background-color: rgba(251, 231, 255, 0.05); }
                        .rarity-divider-epic { background-color: rgba(241, 163, 253, 0.05); }
                        .rarity-divider-rare { background-color: rgba(0, 255, 223, 0.05); }
                        .rarity-divider-common { background-color: rgba(147, 255, 1, 0.05); }
                        
                        .rarity-header-legendary { color: #FBE7FF; }
                        .rarity-header-epic { color: #F1A3FD; }
                        .rarity-header-rare { color: #00FFDF; }
                        .rarity-header-common { color: #93FF01; }
                        
                        .rarity-divider {
                            width: 0.1px !important; /* Force override with !important */
                            min-width: 0.1px !important; /* Ensure min-width doesn't override */
                            max-width: 0.1px !important; /* Ensure max-width doesn't override */
                        }

                        .rarity-divider-legendary, 
                        .rarity-divider-epic, 
                        .rarity-divider-rare, 
                        .rarity-divider-common {
                            width: 0.1px !important;
                            min-width: 0.1px !important;
                            max-width: 0.1px !important;
                        }

                        /* Make sure table cell widths respect our settings */
                        .marketplace-table th.rarity-divider,
                        .marketplace-table td.rarity-divider {
                            width: 0.1px !important;
                            min-width: 0.1px !important;
                            max-width: 0.1px !important;
                            padding-left: 0 !important;
                            padding-right: 0 !important;
                        }
                        .marketplace-table td, .marketplace-table th {
                            border: none;
                            padding: 8px;
                        }
                    </style>
                    <div class="marketplace-container">
                        <div class="export-container" style="text-align: right;">
                            <button class="export-button" onclick="exportToCSV()">
                                <i class="fas fa-file-export"></i>
                                Export CSV
                            </button>
                            <span id="db-updated" style="display: block; font-size: 0.8em; color: grey; margin-top: 5px; text-align: right;">${minDbUpdated !== 'N/A' ? formatDate(minDbUpdated) : 'N/A'} UTC (${timeAgo} min ago)</span>
                        </div>
                        
                        <div class="global-floors">
                            <div class="floor-card floor-legendary">
                                <div class="floor-title">Legendary</div>
                                <div class="floor-value" id="legendary-floor">-</div>
                            </div>
                            <div class="floor-card floor-epic">
                                <div class="floor-title">Epic</div>
                                <div class="floor-value" id="epic-floor">-</div>
                            </div>
                            <div class="floor-card floor-rare">
                                <div class="floor-title">Rare</div>
                                <div class="floor-value" id="rare-floor">-</div>
                            </div>
                            <div class="floor-card floor-common">
                                <div class="floor-title">Common</div>
                                <div class="floor-value" id="common-floor">-</div>
                            </div>
                        </div>
                        
                        <div class="search-container">
                            <input type="text" class="search-input" id="hero-search" placeholder="Search hero...">
                            <i class="fas fa-search search-icon"></i>
                        </div>

                        <div class="filter-container">
                            <div class="filter-label">Bid Floor Spread:</div>
                            <div class="filter-options">
                                <div class="filter-option filter-option-rare" id="rare-spread-filter" data-rarity="rare">Rare</div>
                                <div class="filter-option filter-option-common" id="common-spread-filter" data-rarity="common">Common</div>
                                <div class="filter-option filter-option-clear" id="clear-spread-filter">Clear</div>
                            </div>
                        </div>
                        
                        <table class="marketplace-table">
                            <thead>
                                <tr>
                                    <th>Hero</th>
                                    <th class="sortable" data-sort="score">Score <i class="fas fa-sort-up"></i></th>
                                    <th class="sortable" data-sort="score_24hr">Score 24hr <i class="fas fa-sort-up"></i></th>
                                    <th class="sortable" data-sort="stars">Stars <i class="fas fa-sort-up"></i></th>
                                    <th class="sortable" data-sort="inflation">Inflation <i class="fas fa-sort-up"></i></th>
                                    <th class="rarity-divider rarity-divider-legendary"></th>
                                    <th colspan="3" class="rarity-header-legendary">Legendary</th>
                                    <th class="rarity-divider rarity-divider-epic"></th>
                                    <th colspan="3" class="rarity-header-epic">Epic</th>
                                    <th class="rarity-divider rarity-divider-rare"></th>
                                    <th colspan="3" class="rarity-header-rare">Rare</th>
                                    <th class="rarity-divider rarity-divider-common"></th>
                                    <th colspan="3" class="rarity-header-common">Common</th>
                                </tr>
                                <tr>
                                    <th colspan="5"></th>
                                    <th class="rarity-divider"></th>
                                    <th>Floor</th>
                                    <th>Bid</th>
                                    <th>Listed</th>
                                    <th class="rarity-divider"></th>
                                    <th>Floor</th>
                                    <th>Bid</th>
                                    <th>Listed</th>
                                    <th class="rarity-divider"></th>
                                    <th>Floor</th>
                                    <th>Bid</th>
                                    <th>Listed</th>
                                    <th class="rarity-divider"></th>
                                    <th>Floor</th>
                                    <th>Bid</th>
                                    <th>Listed</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${heroesArray.map(item => `
                                <tr>
                                    <td>
                                        <div class="hero-cell">
                                            <img src="${item.hero_pfp_url}" alt="Hero Profile">
                                            <span data-hero-name="${item.hero_name}">${item.hero_handle}</span>
                                        </div>
                                    </td>
                                    <td>${Math.round(item.score)}</td>
                                    <td>${Math.round(item.score_24hr)}</td>
                                    <td>${item.stars}</td>
                                    <td>${item.inflation_degree}</td>
                                    <td class="rarity-divider rarity-divider-legendary"></td>
                                    <td class="rarity-section-legendary">${formatValue(item.legendary.floor)}</td>
                                    <td class="rarity-section-legendary">${formatValue(item.legendary.highest_bid)}</td>
                                    <td class="rarity-section-legendary">
                                        <div class="listed-count">
                                            ${item.legendary.listed_count}
                                            ${item.legendary.seller_info ? `
                                                <i class="fas fa-user seller-icon" onclick="toggleTooltip(this)"></i>
                                                <div class="seller-tooltip">
                                                    <div class="seller-info">
                                                        <img src="${item.legendary.seller_info.pfp_url}" alt="Seller" class="seller-pfp" onerror="this.onerror=null; this.src='../icons/fan.webp';">
                                                        <span class="seller-name">${item.legendary.seller_info.name}</span>
                                                        <a href="https://x.com/${item.legendary.seller_info.handle}" target="_blank" class="seller-twitter">
                                                            <i class="fab fa-x-twitter"></i> @${item.legendary.seller_info.handle}
                                                        </a>
                                                        ${item.legendary.seller_info.seller_id ? `
                                                            <div class="seller-id">
                                                                ${shortenId(item.legendary.seller_info.seller_id)}
                                                                <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${item.legendary.seller_info.seller_id}', event)"></i>
                                                            </div>
                                                        ` : ''}
                                                        <div class="seller-port-value">
                                                            Portfolio: ${format_eth(item.legendary.seller_info.seller_port_value)} <img src="../icons/eth.webp" alt="ETH Icon" style="width: 16px; height: 16px; vertical-align: middle;">
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </td>
                                    <td class="rarity-divider rarity-divider-epic"></td>
                                    <td class="rarity-section-epic">${formatValue(item.epic.floor)}</td>
                                    <td class="rarity-section-epic">${formatValue(item.epic.highest_bid)}</td>
                                    <td class="rarity-section-epic">
                                        <div class="listed-count">
                                            ${item.epic.listed_count}
                                            ${item.epic.seller_info ? `
                                                <i class="fas fa-user seller-icon" onclick="toggleTooltip(this)"></i>
                                                <div class="seller-tooltip">
                                                    <div class="seller-info">
                                                        <img src="${item.epic.seller_info.pfp_url}" alt="Seller" class="seller-pfp" onerror="this.onerror=null; this.src='../icons/fan.webp';">
                                                        <span class="seller-name">${item.epic.seller_info.name}</span>
                                                        <a href="https://x.com/${item.epic.seller_info.handle}" target="_blank" class="seller-twitter">
                                                            <i class="fab fa-x-twitter"></i> @${item.epic.seller_info.handle}
                                                        </a>
                                                        ${item.epic.seller_info.seller_id ? `
                                                            <div class="seller-id">
                                                                ${shortenId(item.epic.seller_info.seller_id)}
                                                                <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${item.epic.seller_info.seller_id}', event)"></i>
                                                            </div>
                                                        ` : ''}
                                                        <div class="seller-port-value">
                                                            Portfolio: ${format_eth(item.epic.seller_info.seller_port_value)} <img src="../icons/eth.webp" alt="ETH Icon" style="width: 16px; height: 16px; vertical-align: middle;">
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </td>
                                    <td class="rarity-divider rarity-divider-rare"></td>
                                    <td class="rarity-section-rare">${formatValue(item.rare.floor)}</td>
                                    <td class="rarity-section-rare">${formatValue(item.rare.highest_bid)}</td>
                                    <td class="rarity-section-rare">
                                        <div class="listed-count">
                                            ${item.rare.listed_count}
                                            ${item.rare.seller_info ? `
                                                <i class="fas fa-user seller-icon" onclick="toggleTooltip(this)"></i>
                                                <div class="seller-tooltip">
                                                    <div class="seller-info">
                                                        <img src="${item.rare.seller_info.pfp_url}" alt="Seller" class="seller-pfp" onerror="this.onerror=null; this.src='../icons/fan.webp';">
                                                        <span class="seller-name">${item.rare.seller_info.name}</span>
                                                        <a href="https://x.com/${item.rare.seller_info.handle}" target="_blank" class="seller-twitter">
                                                            <i class="fab fa-x-twitter"></i> @${item.rare.seller_info.handle}
                                                        </a>
                                                        ${item.rare.seller_info.seller_id ? `
                                                            <div class="seller-id">
                                                                ${shortenId(item.rare.seller_info.seller_id)}
                                                                <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${item.rare.seller_info.seller_id}', event)"></i>
                                                            </div>
                                                        ` : ''}
                                                        <div class="seller-port-value">
                                                            Portfolio: ${format_eth(item.rare.seller_info.seller_port_value)} <img src="../icons/eth.webp" alt="ETH Icon" style="width: 16px; height: 16px; vertical-align: middle;">
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </td>
                                    <td class="rarity-divider rarity-divider-common"></td>
                                    <td class="rarity-section-common">${formatValue(item.common.floor)}</td>
                                    <td class="rarity-section-common">${formatValue(item.common.highest_bid)}</td>
                                    <td class="rarity-section-common">
                                        <div class="listed-count">
                                            ${item.common.listed_count}
                                            ${item.common.seller_info ? `
                                                <i class="fas fa-user seller-icon" onclick="toggleTooltip(this)"></i>
                                                <div class="seller-tooltip">
                                                    <div class="seller-info">
                                                        <img src="${item.common.seller_info.pfp_url}" alt="Seller" class="seller-pfp" onerror="this.onerror=null; this.src='../icons/fan.webp';">
                                                        <span class="seller-name">${item.common.seller_info.name}</span>
                                                        <a href="https://x.com/${item.common.seller_info.handle}" target="_blank" class="seller-twitter">
                                                            <i class="fab fa-x-twitter"></i> @${item.common.seller_info.handle}
                                                        </a>
                                                        ${item.common.seller_info.seller_id ? `
                                                            <div class="seller-id">
                                                                ${shortenId(item.common.seller_info.seller_id)}
                                                                <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${item.common.seller_info.seller_id}', event)"></i>
                                                            </div>
                                                        ` : ''}
                                                        <div class="seller-port-value">
                                                            Portfolio: ${format_eth(item.common.seller_info.seller_port_value)} <img src="../icons/eth.webp" alt="ETH Icon" style="width: 16px; height: 16px; vertical-align: middle;">
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div id="no-results" class="no-results" style="display: none;">No heroes found matching your search.</div>
                    </div>
                `;

                // Move this call here, after the HTML is generated
                updateGlobalFloors(heroesArray);

                // Add the export function
                window.exportToCSV = function() {
                    // Convert the raw data to CSV format
                    const csvRows = [];
                    const headers = ['Hero Handle', 'Hero Name', 'Score', 'Score 24hr', 'Stars', 'Inflation Degree', 'Rarity', 'Floor', 'Highest Bid', 'Listed Count', 'Seller ID'];
                    csvRows.push(headers.join(','));

                    heroesArray.forEach(item => {
                        const row = [
                            item.hero_handle,
                            item.hero_name,
                            item.score,
                            item.score_24hr,
                            item.stars,
                            item.inflation_degree,
                            'Legendary',
                            item.legendary.floor,
                            item.legendary.highest_bid || '',
                            item.legendary.listed_count || '',
                            item.legendary.seller_info ? item.legendary.seller_info.seller_id : ''
                        ].map(value => `"${value}"`);
                        csvRows.push(row.join(','));

                        const epicRow = [
                            item.hero_handle,
                            item.hero_name,
                            item.score,
                            item.score_24hr,
                            item.stars,
                            item.inflation_degree,
                            'Epic',
                            item.epic.floor,
                            item.epic.highest_bid || '',
                            item.epic.listed_count || '',
                            item.epic.seller_info ? item.epic.seller_info.seller_id : ''
                        ].map(value => `"${value}"`);
                        csvRows.push(epicRow.join(','));

                        const rareRow = [
                            item.hero_handle,
                            item.hero_name,
                            item.score,
                            item.score_24hr,
                            item.stars,
                            item.inflation_degree,
                            'Rare',
                            item.rare.floor,
                            item.rare.highest_bid || '',
                            item.rare.listed_count || '',
                            item.rare.seller_info ? item.rare.seller_info.seller_id : ''
                        ].map(value => `"${value}"`);
                        csvRows.push(rareRow.join(','));

                        const commonRow = [
                            item.hero_handle,
                            item.hero_name,
                            item.score,
                            item.score_24hr,
                            item.stars,
                            item.inflation_degree,
                            'Common',
                            item.common.floor,
                            item.common.highest_bid || '',
                            item.common.listed_count || '',
                            item.common.seller_info ? item.common.seller_info.seller_id : ''
                        ].map(value => `"${value}"`);
                        csvRows.push(commonRow.join(','));
                    });

                    // Create and trigger download
                    const csvString = csvRows.join('\n');
                    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    if (navigator.msSaveBlob) { // IE 10+
                        navigator.msSaveBlob(blob, 'marketplace_data.csv');
                    } else {
                        link.href = URL.createObjectURL(blob);
                        link.download = 'marketplace_data.csv';
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                };

                // New function to format the date
                function formatDate(date) {
                    if (!date) return 'N/A'; // Return 'N/A' if date is undefined
                    const utcDate = new Date(date); // Create a Date object from the timestamp
                    const year = utcDate.getUTCFullYear();
                    const month = String(utcDate.getUTCMonth() + 1).padStart(2, '0'); // Months are zero-based
                    const day = String(utcDate.getUTCDate()).padStart(2, '0');
                    const hours = String(utcDate.getUTCHours()).padStart(2, '0');
                    const minutes = String(utcDate.getUTCMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day} ${hours}:${minutes}`;
                }

                // Sorting functionality
                function initializeSorting() {
                    const headers = document.querySelectorAll('.sortable');
                    headers.forEach(header => {
                        header.addEventListener('click', () => {
                            const sortKey = header.dataset.sort;
                            const tbody = document.querySelector('.marketplace-table tbody');
                            const rows = Array.from(tbody.querySelectorAll('tr'));
                            
                            // Remove sorting classes from all headers
                            headers.forEach(h => {
                                if (h !== header) h.classList.remove('asc', 'desc');
                            });
                            
                            // Determine sorting direction
                            const isAsc = header.classList.contains('asc');
                            const isDesc = header.classList.contains('desc');
                            
                            // Clear both classes first
                            header.classList.remove('asc', 'desc');
                            
                            // If it wasn't sorted before or was ascending, make it descending (high to low)
                            // If it was descending, make it ascending (low to high)
                            if (!isDesc) {
                                header.classList.add('desc');
                            } else {
                                header.classList.add('asc');
                            }
                            
                            // Get the new state after toggling
                            const isDescending = header.classList.contains('desc');
                            
                            // Sort the rows
                            rows.sort((a, b) => {
                                let aVal, bVal;
                                
                                switch(sortKey) {
                                    case 'score':
                                        aVal = parseFloat(a.children[1].textContent);
                                        bVal = parseFloat(b.children[1].textContent);
                                        break;
                                    case 'score_24hr':
                                        aVal = parseFloat(a.children[2].textContent);
                                        bVal = parseFloat(b.children[2].textContent);
                                        break;
                                    case 'stars':
                                        aVal = parseFloat(a.children[3].textContent);
                                        bVal = parseFloat(b.children[3].textContent);
                                        break;
                                    case 'inflation':
                                        aVal = parseFloat(a.children[4].textContent);
                                        bVal = parseFloat(b.children[4].textContent);
                                        break;
                                }
                                
                                if (isNaN(aVal)) aVal = isDescending ? -Infinity : Infinity;
                                if (isNaN(bVal)) bVal = isDescending ? -Infinity : Infinity;
                                
                                // For descending order (high to low), we want b - a
                                // For ascending order (low to high), we want a - b
                                return isDescending ? bVal - aVal : aVal - bVal;
                            });
                            
                            // Reorder the rows
                            rows.forEach(row => tbody.appendChild(row));
                        });
                    });
                }

                // Add search functionality
                function initializeSearch() {
                    const searchInput = document.getElementById('hero-search');
                    const tableRows = document.querySelectorAll('.marketplace-table tbody tr');
                    const noResultsMessage = document.getElementById('no-results');
                    
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase().trim();
                        let visibleCount = 0;
                        
                        tableRows.forEach(row => {
                            const heroCell = row.querySelector('.hero-cell');
                            const heroHandle = heroCell.querySelector('span').textContent.toLowerCase();
                            const heroName = heroCell.querySelector('span').getAttribute('data-hero-name').toLowerCase();
                            
                            if (heroHandle.includes(searchTerm) || heroName.includes(searchTerm)) {
                                row.style.display = '';
                                visibleCount++;
                            } else {
                                row.style.display = 'none';
                            }
                        });
                        
                        // Show/hide no results message
                        noResultsMessage.style.display = visibleCount === 0 ? 'block' : 'none';
                    });
                }

                // Call initializeSearch after the table is created
                initializeSearch();
                
                // Call initializeSorting after the table is created
                initializeSorting();

                // Add bid floor spread sorting functionality
                function initializeBidFloorSpreadSorting() {
                    const rareSpreadFilter = document.getElementById('rare-spread-filter');
                    const commonSpreadFilter = document.getElementById('common-spread-filter');
                    const clearSpreadFilter = document.getElementById('clear-spread-filter');
                    const tbody = document.querySelector('.marketplace-table tbody');
                    
                    // Function to calculate spread and sort
                    function sortBySpread(rarity) {
                        const rows = Array.from(tbody.querySelectorAll('tr'));
                        
                        // Calculate spread for each row
                        rows.forEach(row => {
                            let floorCell, bidCell;
                            
                            if (rarity === 'rare') {
                                floorCell = row.querySelector('.rarity-section-rare:nth-child(15)'); // Rare floor cell
                                bidCell = row.querySelector('.rarity-section-rare:nth-child(16)');   // Rare bid cell
                            } else if (rarity === 'common') {
                                floorCell = row.querySelector('.rarity-section-common:nth-child(19)'); // Common floor cell
                                bidCell = row.querySelector('.rarity-section-common:nth-child(20)');   // Common bid cell
                            }
                            
                            const floorValue = floorCell ? parseFloat(floorCell.textContent) : NaN;
                            const bidValue = bidCell ? parseFloat(bidCell.textContent) : NaN;
                            
                            // Calculate spread only if both values are valid numbers
                            if (!isNaN(floorValue) && !isNaN(bidValue) && floorValue !== '-' && bidValue !== '-') {
                                row.dataset[`${rarity}Spread`] = (floorValue - bidValue).toFixed(4);
                            } else {
                                row.dataset[`${rarity}Spread`] = '-999'; // Use a very negative value for rows without valid spread
                            }
                        });
                        
                        // Sort rows by spread (descending)
                        rows.sort((a, b) => {
                            const aSpread = parseFloat(a.dataset[`${rarity}Spread`]);
                            const bSpread = parseFloat(b.dataset[`${rarity}Spread`]);
                            return bSpread - aSpread; // Descending order
                        });
                        
                        // Reorder the rows
                        rows.forEach(row => tbody.appendChild(row));
                    }
                    
                    // Function to clear all filters
                    function clearFilters() {
                        rareSpreadFilter.classList.remove('active');
                        commonSpreadFilter.classList.remove('active');
                        
                        // Reset to default sort (by score)
                        const scoreHeader = document.querySelector('.sortable[data-sort="score"]');
                        if (scoreHeader) {
                            scoreHeader.classList.add('desc');
                            scoreHeader.classList.remove('asc');
                            
                            const rows = Array.from(tbody.querySelectorAll('tr'));
                            rows.sort((a, b) => {
                                const aScore = parseFloat(a.children[1].textContent);
                                const bScore = parseFloat(b.children[1].textContent);
                                return bScore - aScore; // Descending order by score
                            });
                            
                            rows.forEach(row => tbody.appendChild(row));
                        }
                    }
                    
                    // Add event listeners to toggle buttons
                    rareSpreadFilter.addEventListener('click', function() {
                        const isActive = this.classList.contains('active');
                        
                        // Clear all active states first
                        rareSpreadFilter.classList.remove('active');
                        commonSpreadFilter.classList.remove('active');
                        
                        // If it wasn't active before, make it active and sort
                        if (!isActive) {
                            this.classList.add('active');
                            sortBySpread('rare');
                        } else {
                            // If it was already active, just deactivate (clear filters)
                            clearFilters();
                        }
                    });
                    
                    commonSpreadFilter.addEventListener('click', function() {
                        const isActive = this.classList.contains('active');
                        
                        // Clear all active states first
                        rareSpreadFilter.classList.remove('active');
                        commonSpreadFilter.classList.remove('active');
                        
                        // If it wasn't active before, make it active and sort
                        if (!isActive) {
                            this.classList.add('active');
                            sortBySpread('common');
                        } else {
                            // If it was already active, just deactivate (clear filters)
                            clearFilters();
                        }
                    });
                    
                    // Add event listener for clear button
                    clearSpreadFilter.addEventListener('click', clearFilters);
                }

                // Call the function after the table is created
                initializeBidFloorSpreadSorting();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('marketplace-container').innerHTML = 'Error loading marketplace data';
            }
        }

        // Add this function to the script section
        function copyToClipboard(text, event) {
            navigator.clipboard.writeText(text).then(() => {
                // Show feedback
                const feedback = document.createElement('div');
                feedback.className = 'copy-feedback';
                feedback.textContent = 'Copied!';
                
                // Position near the click
                feedback.style.left = `${event.clientX}px`;
                feedback.style.top = `${event.clientY - 30}px`;
                
                document.body.appendChild(feedback);
                
                // Show the feedback
                setTimeout(() => feedback.classList.add('show'), 10);
                
                // Remove after animation
                setTimeout(() => {
                    feedback.classList.remove('show');
                    setTimeout(() => document.body.removeChild(feedback), 300);
                }, 1500);
            });
            
            // Stop event propagation to prevent tooltip from closing
            event.stopPropagation();
        }

        // Add this helper function to shorten IDs
        function shortenId(id) {
            if (!id) return '';
            if (id.length <= 8) return id;
            return `${id.substring(0, 5)}...${id.substring(id.length - 3)}`;
        }

        function format_eth(value) {
            if (value === null || value === undefined || isNaN(value)) return '-'; // Handle invalid values

            const num = parseFloat(value);
            if (num > 10) {
                return num.toFixed(0); // Format as ## for values greater than 10
            } else if (num > 1) {
                return num.toFixed(1); // Format as #.# for values greater than 1
            } else {
                return num.toFixed(2); // Format as #.## for values less than or equal to 1
            }
        }
    </script>
</body>
</html>
