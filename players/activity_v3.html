<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Activity Dashboard</title>
    
    <!-- AG Grid CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/styles/ag-grid.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/styles/ag-theme-alpine.min.css">
    
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #0099ff;
            --background-color: #000000;
            --container-bg: #121212;
            --text-color: #ffffff;
            --border-color: #333333;
            --header-bg: #1a1a1a;
            --cell-bg: #0a0a0a;
            --alt-row-bg: #0f0f0f;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        header {
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .grid-container {
            height: 70vh;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Simple, clean dark theme for AG Grid */
        .ag-theme-alpine {
            --ag-background-color: var(--cell-bg);
            --ag-header-background-color: var(--header-bg);
            --ag-odd-row-background-color: var(--cell-bg);
            --ag-even-row-background-color: var(--alt-row-bg);
            --ag-header-foreground-color: var(--text-color);
            --ag-foreground-color: var(--text-color);
            --ag-border-color: var(--border-color);
            --ag-row-border-color: var(--border-color);
        }
        
        /* Override core elements to ensure dark theme */
        .ag-root-wrapper {
            background-color: black !important;
        }
        
        .ag-header {
            background-color: var(--header-bg) !important;
            color: white !important;
        }
        
        .ag-header-cell {
            background-color: var(--header-bg) !important;
            color: white !important;
            border-right: 1px solid var(--border-color) !important;
        }
        
        .ag-cell {
            background-color: transparent !important;
            color: white !important;
            border-right: 1px solid var(--border-color) !important;
        }
        
        .ag-row-odd {
            background-color: var(--cell-bg) !important;
        }
        
        .ag-row-even {
            background-color: var(--alt-row-bg) !important;
        }
        
        .ag-floating-filter-body input,
        .ag-floating-filter-button {
            background-color: var(--header-bg) !important;
            color: white !important;
            border: 1px solid var(--border-color) !important;
        }
        
        .ag-menu {
            background-color: var(--header-bg) !important;
            color: white !important;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: rgba(220, 53, 69, 0.2);
            color: #ff6b6b;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid #b71c1c;
        }
        
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            background-color: var(--header-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .filter-input::placeholder {
            color: #aaaaaa;
        }
        
        .refresh-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .refresh-btn:hover {
            background-color: #0077cc;
            box-shadow: 0 0 8px rgba(0, 153, 255, 0.5);
        }
        
        footer {
            margin-top: 30px;
            text-align: center;
            font-size: 14px;
            color: #aaaaaa;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }
        
        /* Link styling */
        a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .grid-container {
                height: 60vh;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .filter-input {
                min-width: 100%;
            }
            
            .container {
                padding: 15px;
            }
        }
        
        /* Add these styles to fix pagination and scrolling */
        .ag-theme-alpine .ag-paging-panel {
            background-color: var(--header-bg) !important;
            color: var(--text-color) !important;
            border-top: 1px solid var(--border-color) !important;
            padding: 8px;
        }
        
        .ag-theme-alpine .ag-paging-button {
            color: var(--text-color) !important;
        }
        
        .ag-theme-alpine .ag-paging-button-wrapper {
            color: var(--text-color) !important;
        }
        
        .ag-theme-alpine .ag-paging-description {
            color: var(--text-color) !important;
        }
        
        /* Fix scrollbar styling */
        .ag-theme-alpine ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .ag-theme-alpine ::-webkit-scrollbar-track {
            background: var(--cell-bg);
        }
        
        .ag-theme-alpine ::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 4px;
        }
        
        /* Ensure the grid container has proper height calculation */
        .grid-container {
            height: 70vh;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Make sure rows display properly */
        .ag-center-cols-container {
            min-height: 100px;
        }
        
        /* Add these styles to your stylesheet */
        .custom-pagination {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }

        .page-size-selector {
            background-color: var(--header-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            margin-right: 10px;
        }

        /* Add these styles for the toggle filter */
        .toggle-filter {
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-right: 15px;
        }

        .toggle-btn {
            background-color: var(--header-bg);
            color: var(--text-color);
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .toggle-btn:not(:last-child) {
            border-right: 1px solid var(--border-color);
        }

        .toggle-btn:hover {
            background-color: #252525;
        }

        .toggle-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Add these styles for the avatar */
        .avatar-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .player-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }

        /* Add styles for the required player message */
        .required-player-message {
            color: #ff6b6b;
            font-size: 14px;
            margin-top: 5px;
            margin-bottom: 10px;
            padding: 5px 0;
        }

        /* Add styles for the player dropdown */
        .player-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 90%; /* Reduced from 100% */
            max-width: 320px; /* Add maximum width */
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* Add these styles for the player search dropdown */
        .player-search-container {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .player-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 90%; /* Reduced from 100% */
            max-width: 320px; /* Add maximum width */
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .player-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        .player-item:hover {
            background-color: var(--header-bg);
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-item-info {
            margin-left: 10px;
        }

        .player-item-name {
            color: var(--text-color);
            font-weight: 500;
            font-size: 0.9em; /* Reduced font size */
        }

        .player-item-handle {
            color: #aaaaaa;
            font-size: 0.85em;
        }

        .player-search-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border-color);
        }

        /* Ensure scrollbar in dropdown matches theme */
        .player-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .player-dropdown::-webkit-scrollbar-track {
            background: var(--cell-bg);
        }

        .player-dropdown::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 4px;
        }

        /* Increase row height for hero cards */
        .ag-row-with-cards {
            height: auto !important;
            min-height: 100px; /* Increased from 80px */
        }

        /* Add styles for the cards modal */
        .cards-modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .cards-modal {
            background-color: var(--container-bg);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .cards-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .cards-modal-header h3 {
            color: var(--primary-color);
            margin: 0;
        }

        .close-modal-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
        }

        .cards-modal-content {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 70px);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .card-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card-item img {
            width: 80px;
            height: 110px;
            border-radius: 5px;
            object-fit: cover;
            border: 2px solid var(--border-color);
            margin-bottom: 5px;
        }

        .card-info {
            text-align: center;
            font-size: 12px;
        }

        .card-id {
            color: var(--text-color);
            margin-bottom: 2px;
        }

        .card-rarity {
            color: var(--primary-color);
            text-transform: capitalize;
        }

        .view-all-cards-btn:hover {
            background-color: #0077cc !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Player Activity Dashboard</h1>
            <p>Track player minting activity and hero details</p>
        </header>
        
        <div id="errorMessage" class="error-message">
            An error occurred while loading data. Please try again later.
        </div>
        
        <div class="filter-bar">
            <div class="toggle-filter">
                <button class="toggle-btn active" data-filter="all">All</button>
                <button class="toggle-btn" data-filter="mints">Mints</button>
                <button class="toggle-btn" data-filter="packs">Packs</button>
            </div>
            <div class="player-search-container">
                <input type="text" id="playerFilter" class="filter-input" placeholder="Filter by player...">
                <div id="playerDropdown" class="player-dropdown">
                    <!-- Player suggestions will be added here dynamically -->
                </div>
            </div>
            <button id="refreshBtn" class="refresh-btn">Refresh Data</button>
        </div>
        
        <!-- Make sure your grid container has the correct class -->
        <div id="myGrid" class="ag-theme-alpine-dark grid-container"></div>
        
        <footer>
            <p>&copy; 2025 Fantasy Top Analysis</p>
        </footer>
    </div>
    
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- AG Grid JS -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/dist/ag-grid-community.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Custom JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase configuration
            const supabaseUrl = 'https://hhcuqhvmzwmehdsaamhn.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoY3VxaHZtendtZWhkc2FhbWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzIwMTIsImV4cCI6MjA1MDU0ODAxMn0.xJNGoFLnpnmQGLj8RY_4VLmefPmFzuOyiVHLvFtPkkE';
            
            // Fix: Create the Supabase client correctly
            const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
            
            // References to DOM elements
            const gridDiv = document.querySelector('#myGrid');
            const loadingOverlay = document.querySelector('#loadingOverlay');
            const errorMessage = document.querySelector('#errorMessage');
            const playerFilterInput = document.querySelector('#playerFilter');
            const toggleButtons = document.querySelectorAll('.toggle-btn');
            const refreshButton = document.querySelector('#refreshBtn');
            let activeFilterType = 'all'; // Default filter

            // Add this after your DOM references
            const requiredPlayerMessage = document.createElement('div');
            requiredPlayerMessage.className = 'required-player-message';
            requiredPlayerMessage.style.display = 'none';
            requiredPlayerMessage.textContent = 'You must enter a player';
            document.querySelector('.filter-bar').appendChild(requiredPlayerMessage);

            // Set the default player in the filter
            playerFilterInput.value = "OttoSuwenNFT";

            // Add these variables after your existing DOM references
            const playerDropdown = document.querySelector('#playerDropdown');
            let players = []; // Will store all players
            let isLoadingPlayers = false;

            // Add this function to fetch all players
            async function fetchPlayers() {
                if (players.length > 0 || isLoadingPlayers) return;
                
                isLoadingPlayers = true;
                
                try {
                    const { data, error } = await supabaseClient
                        .from('players')
                        .select('player_address, player_name, player_pfp_url, player_handle')
                        .order('player_name', { ascending: true });
                        
                    if (error) {
                        throw new Error(error.message);
                    }
                    
                    players = data || [];
                    
                } catch (error) {
                    console.error('Error fetching players:', error);
                } finally {
                    isLoadingPlayers = false;
                }
            }

            // Call this function early to start loading players
            fetchPlayers();

            // Modify the player filter input event to show matching players
            playerFilterInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                
                if (!query) {
                    requiredPlayerMessage.style.display = 'block';
                    playerDropdown.style.display = 'none';
                    return;
                } else {
                    requiredPlayerMessage.style.display = 'none';
                }
                
                // Filter players based on input
                const matchedPlayers = players.filter(player => {
                    const name = (player.player_name || '').toLowerCase();
                    const handle = (player.player_handle || '').toLowerCase();
                    return name.includes(query) || handle.includes(query);
                }).slice(0, 10); // Limit to 10 results
                
                // Display matching players
                renderPlayerDropdown(matchedPlayers);
            });

            // Add click event for document to close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!playerFilterInput.contains(event.target) && !playerDropdown.contains(event.target)) {
                    playerDropdown.style.display = 'none';
                }
            });

            // Add a click event to playerFilterInput to show dropdown on click
            playerFilterInput.addEventListener('click', function() {
                if (players.length === 0) {
                    fetchPlayers(); // Make sure we have players data
                }
                
                // Always show dropdown when clicking in the input
                const query = this.value.trim().toLowerCase();
                
                // Get first 10 players, filtered if there's a query
                let matchedPlayers;
                if (query) {
                    matchedPlayers = players.filter(player => {
                        const name = (player.player_name || '').toLowerCase();
                        const handle = (player.player_handle || '').toLowerCase();
                        return name.includes(query) || handle.includes(query);
                    }).slice(0, 10);
                } else {
                    // If no query, just show first 10 players
                    matchedPlayers = players.slice(0, 10);
                }
                
                renderPlayerDropdown(matchedPlayers);
            });

            // Function to render the player dropdown
            function renderPlayerDropdown(matchedPlayers) {
                // Clear previous results
                playerDropdown.innerHTML = '';
                
                if (matchedPlayers.length === 0) {
                    playerDropdown.style.display = 'none';
                    return;
                }
                
                // Create HTML for each player
                matchedPlayers.forEach(player => {
                    const playerElement = document.createElement('div');
                    playerElement.className = 'player-item';
                    
                    const imgUrl = player.player_pfp_url || 'https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png';
                    
                    playerElement.innerHTML = `
                        <img src="${imgUrl}" alt="Avatar" class="player-search-avatar">
                        <div class="player-item-info">
                            <div class="player-item-name">${player.player_name || 'Unknown'}</div>
                            <div class="player-item-handle">@${player.player_handle || ''}</div>
                        </div>
                    `;
                    
                    // Add click event to select this player
                    playerElement.addEventListener('click', function() {
                        playerFilterInput.value = player.player_handle;
                        playerDropdown.style.display = 'none';
                        loadData(); // Load data for selected player
                    });
                    
                    playerDropdown.appendChild(playerElement);
                });
                
                // Show the dropdown
                playerDropdown.style.display = 'block';
            }

            // Modify loadData to handle the case when a player is selected
            async function loadData() {
                // Check if player filter is empty
                if (!playerFilterInput.value.trim()) {
                    requiredPlayerMessage.style.display = 'block';
                    showError('You must enter a player handle to view data');
                    return;
                } else {
                    requiredPlayerMessage.style.display = 'none';
                    hideError();
                }
                
                showLoading(true);
                
                try {
                    const { data, error } = await supabaseClient
                        .from('player_mints')
                        .select('player_address, player_name, player_handle, player_pfp_url, tx_hash, timestamp, price, cards,hero_details')
                        .eq('player_handle', playerFilterInput.value.trim());
                        
                    if (error) {
                        throw new Error(error.message);
                    }
                    
                    if (data.length === 0) {
                        showError(`No data found for player: ${playerFilterInput.value}`);
                    } else {
                        gridOptions.api.setRowData(data);
                        gridOptions.api.sizeColumnsToFit();
                    }
                    
                } catch (error) {
                    console.error('Error fetching data:', error);
                    showError(error.message);
                } finally {
                    showLoading(false);
                }
            }

            // Add a click event to playerFilterInput to show dropdown on focus
            playerFilterInput.addEventListener('focus', function() {
                if (players.length === 0) {
                    fetchPlayers(); // Make sure we have players data
                }
                
                const query = this.value.trim().toLowerCase();
                if (query) {
                    const matchedPlayers = players.filter(player => {
                        const name = (player.player_name || '').toLowerCase();
                        const handle = (player.player_handle || '').toLowerCase();
                        return name.includes(query) || handle.includes(query);
                    }).slice(0, 10);
                    
                    renderPlayerDropdown(matchedPlayers);
                }
            });

            // Grid Options
            const gridOptions = {
                // Enable features
                defaultColDef: {
                    flex: 1,
                    minWidth: 100,
                    filter: true,
                    sortable: true,
                    resizable: true,
                    cellClass: 'dark-cell',
                    headerClass: 'dark-header'
                },
                
                // Column Definitions - keep your existing column definitions
                columnDefs: [
                    {
                        headerName: '', 
                        field: 'player_pfp_url',
                        width: 60,
                        flex: 0,
                        filter: false,
                        sortable: false,
                        cellRenderer: params => {
                            const imgUrl = params.value || '/icons/fan.webp';
                            return `<div class="avatar-container">
                                <img src="${imgUrl}" alt="Avatar" class="player-avatar" 
                                     onerror="this.onerror=null; this.src='/icons/fan.webp';">
                            </div>`;
                        }
                    },
                    { headerName: 'Player Name', field: 'player_name', filter: 'agTextColumnFilter' },
                    { headerName: 'Handle', field: 'player_handle', filter: 'agTextColumnFilter', hide: true },
                    { 
                        headerName: 'Address', 
                        field: 'player_address',
                        hide: true,
                        cellRenderer: params => {
                            const address = params.value;
                            if (!address) return '';
                            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                        }
                    },
                    { 
                        headerName: 'Time', 
                        field: 'timestamp', 
                        filter: 'agDateColumnFilter',
                        sort: 'desc',
                        cellRenderer: params => {
                            if (!params.value) return '';
                            
                            const timestamp = new Date(params.value);
                            const now = new Date();
                            const diffMs = now - timestamp;
                            const diffMins = Math.floor(diffMs / 60000);
                            const diffHours = Math.floor(diffMs / 3600000);
                            const diffDays = Math.floor(diffMs / 86400000);
                            
                            // Format as relative time
                            if (diffDays > 0) {
                                return `${diffDays}d ago`;
                            } else if (diffHours > 0) {
                                return `${diffHours}h ago`;
                            } else if (diffMins > 0) {
                                return `${diffMins}m ago`;
                            } else {
                                return 'Just now';
                            }
                        }
                    },
                    { 
                        headerName: 'Price', 
                        field: 'price',
                        filter: 'agNumberColumnFilter',
                        cellRenderer: params => {
                            if (params.value === null || params.value === undefined) return '';
                            
                            // Get the transaction hash from the row data
                            const txHash = params.data.tx_hash;
                            const blastLink = txHash ? 
                                `<a href="https://blastscan.io/tx/${txHash}" target="_blank" title="View on BlastScan" style="margin-left: 5px;">
                                    <img src="/icons/blast.webp" alt="BlastScan" style="width: 11px; height: 11px; vertical-align: middle; cursor: pointer;">
                                </a>` : '';
                                
                            // Special handling for zero price (mints)
                            if (params.value === 0) {
                                return blastLink; // Only show blast link for mints
                            } else {
                                // For non-zero prices (packs), show price with ETH icon and blast link
                                return `${params.value.toFixed(3)} <svg width="16" height="16" viewBox="0 0 256 417" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid"><path fill="#8A92B2" d="M127.961 0l-2.795 9.5v275.668l2.795 2.79 127.962-75.638z"></path><path fill="#62688F" d="M127.962 0L0 212.32l127.962 75.639V154.158z"></path><path fill="#454A75" d="M127.961 312.187l-1.575 1.92v98.199l1.575 4.6L256 236.587z"></path><path fill="#62688F" d="M127.962 416.905v-104.72L0 236.585z"></path><path fill="#8A92B2" d="M127.961 287.958l127.96-75.637-127.96-58.162z"></path><path fill="#62688F" d="M0 212.32l127.96 75.638v-133.8z"></path></svg>${blastLink}`;
                            }
                        }
                    },
                    { 
                        headerName: 'Cards', 
                        field: 'cards',
                        width: 80,
                        flex: 0,
                        filter: 'agNumberColumnFilter',
                        cellStyle: {
                            'text-align': 'center'
                        },
                        cellRenderer: params => {
                            if (params.value === null || params.value === undefined) return '';
                            
                            // Ensure the value is within 1-99 range for display
                            const cardCount = Math.min(Math.max(1, params.value), 99);
                            
                            return `<span style="font-weight: 500;">${cardCount}</span>`;
                        }
                    },
                    { 
                        headerName: 'Hero Cards', 
                        field: 'hero_details',
                        flex: 2,
                        minWidth: 250,
                        valueFormatter: params => {
                            if (!params.value) return 'N/A';
                            
                            // Handle object by converting it to a string representation
                            if (typeof params.value === 'object') {
                                return JSON.stringify(params.value);
                            }
                            
                            // If it's already a string, return it directly
                            return params.value;
                        },
                        cellRenderer: params => {
                            const details = params.value;
                            if (!details) return 'N/A';
                            
                            try {
                                // Parse hero_details from JSON if it's a string
                                const heroCards = typeof details === 'string' ? JSON.parse(details) : details;
                                
                                if (!Array.isArray(heroCards) || heroCards.length === 0) {
                                    return 'No cards';
                                }
                                
                                // Determine if we need to show "View All" button (more than 15 cards)
                                const showViewAllButton = heroCards.length > 15;
                                const cardsToShow = showViewAllButton ? heroCards.slice(0, 15) : heroCards;
                                
                                // Create card images HTML with natural wrapping
                                let imagesHTML = '<div style="display: flex; flex-wrap: wrap; gap: 3px; width: 100%;">';
                                
                                cardsToShow.forEach(card => {
                                    const rarity = card.hero_rarity || 'common';
                                    const heroId = card.hero_id || '';
                                    const heroHandle = card.hero_handle || '';
                                    const heroStars = card.hero_stars || '';
                                    
                                    // Primary URL (v2) - uses hero_handle and hero_stars
                                    const imagePathV2 = `https://fantasy-top-cards.s3.eu-north-1.amazonaws.com/v2/${rarity}/${heroId}_${heroStars}.png`;
                                    
                                    // Fallback URL (v1) - uses hero_id and hero_stars
                                    const imagePathV1 = `https://fantasy-top-cards.s3.eu-north-1.amazonaws.com/v1/${rarity.toLowerCase()}/${heroHandle}_${heroStars}.png`;
                                    
                                    imagesHTML += `
                                        <div style="flex: 0 0 auto; margin-bottom: 2px; margin-right: 2px;">
                                            <img 
                                                src="${imagePathV2}" 
                                                alt="${rarity} card" 
                                                style="width: 22px; height: 30px; border-radius: 2px; object-fit: cover;"
                                                onerror="if(this.src !== '${imagePathV1}') { this.src='${imagePathV1}'; } else { this.src='https://fantasy-top-cards.s3.eu-north-1.amazonaws.com/v2/card_placeholder.png'; this.style.opacity='0.7'; }"
                                                title="ID: ${card.token_id || 'N/A'}, Rarity: ${rarity}"
                                            />
                                        </div>
                                    `;
                                });
                                
                                if (showViewAllButton) {
                                    // IMPORTANT: Use a unique identifier for each cell to prevent conflicts
                                    const uniqueId = 'btn_' + Math.random().toString(36).substr(2, 9);
                                    
                                    imagesHTML += `
                                        <div style="margin-left: 5px; display: flex; align-items: center;">
                                            <button 
                                                id="${uniqueId}"
                                                class="view-all-cards-btn" 
                                                style="background-color: var(--primary-color); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">
                                                View All (${heroCards.length})
                                            </button>
                                        </div>
                                    `;
                                    
                                    // Use requestAnimationFrame to ensure the DOM is ready
                                    window.requestAnimationFrame(() => {
                                        const button = document.getElementById(uniqueId);
                                        if (button) {
                                            // Store cards data directly in a function closure instead of as an attribute
                                            button.addEventListener('click', (e) => {
                                                e.stopPropagation();
                                                showCardsModal(heroCards);
                                            });
                                        }
                                    });
                                }
                                
                                imagesHTML += '</div>';
                                return imagesHTML;
                                
                            } catch (e) {
                                console.error('Error rendering hero cards:', e);
                                return 'Error displaying cards';
                            }
                        }
                    }
                ],
                
                // Pagination settings
                pagination: true,
                paginationPageSize: 25,
                
                // Scrolling behavior
                alwaysShowVerticalScroll: true,
                suppressScrollOnNewData: false,
                
                // Layout settings
                domLayout: 'normal',
                
                // Row settings
                rowSelection: 'single',
                rowHeight: 50, // Increased from 40
                headerHeight: 40,
                
                // Other settings
                animateRows: true,
                suppressDragLeaveHidesColumns: true,
                
                // External filter settings
                isExternalFilterPresent: () => {
                    return true; // Always return true since we handle filtering in externalFilter
                },
                doesExternalFilterPass: externalFilter,
                
                // Events
                onGridReady: onGridReady
            };
            
            // Initialize AG Grid
            const grid = new agGrid.Grid(gridDiv, gridOptions);
            
            // Grid Ready Event Handler
            function onGridReady(params) {
                // Fetch data on initial load
                loadData();
                
                // REPLACE the current setRowClass implementation with getRowClass
                gridOptions.getRowClass = function(params) {
                    if (params.data && params.data.hero_details) {
                        try {
                            const heroCards = typeof params.data.hero_details === 'string' 
                                ? JSON.parse(params.data.hero_details) 
                                : params.data.hero_details;
                            
                            if (Array.isArray(heroCards) && heroCards.length > 5) {
                                return 'ag-row-with-cards';
                            }
                        } catch (e) {}
                    }
                    return '';
                };
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    setTimeout(() => {
                        gridOptions.api.sizeColumnsToFit();
                    }, 100);
                });
            }
            
            // Toggle Filter Functionality
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Update active button styling
                    toggleButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Set the filter type
                    activeFilterType = this.getAttribute('data-filter');
                    
                    // Apply filters
                    applyFilters();
                });
            });
            
            // Combined filter function
            function applyFilters() {
                const playerText = playerFilterInput.value;
                
                gridOptions.api.setFilterModel(null); // Clear existing filters
                
                // Force refresh
                gridOptions.api.onFilterChanged();
            }
            
            // External filter function
            function externalFilter(node) {
                if (!node.data) return false;
                
                // Always require a player handle
                const playerText = playerFilterInput.value.toLowerCase().trim();
                if (!playerText) return false;
                
                // First check if it matches the player criteria
                const playerName = String(node.data.player_name || '').toLowerCase();
                const playerHandle = String(node.data.player_handle || '').toLowerCase();
                const playerAddress = String(node.data.player_address || '').toLowerCase();
                
                const matchesPlayer = playerHandle.includes(playerText) || 
                                      playerName.includes(playerText) || 
                                      playerAddress.includes(playerText);
                                      
                if (!matchesPlayer) return false;
                
                // Then check the toggle filter
                if (activeFilterType === 'mints') {
                    return node.data.price === 0;
                } else if (activeFilterType === 'packs') {
                    return node.data.price !== 0;
                }
                
                return true; // For "All" filter
            }
            
            // Refresh Button
            refreshButton.addEventListener('click', loadData);
            
            // Utility Functions
            function showLoading(show) {
                loadingOverlay.style.display = show ? 'flex' : 'none';
            }
            
            function showError(message) {
                errorMessage.textContent = message || 'An error occurred while loading data. Please try again later.';
                errorMessage.style.display = 'block';
            }
            
            function hideError() {
                errorMessage.style.display = 'none';
            }
            
            // Create Pagination Component
            function createPaginationComp() {
                function CustomPaginationComp() {}
                
                CustomPaginationComp.prototype.init = function(params) {
                    this.eGui = document.createElement('div');
                    this.eGui.classList.add('custom-pagination');
                    
                    // Create page size selector
                    const pageSizeSelector = document.createElement('select');
                    pageSizeSelector.classList.add('page-size-selector');
                    
                    const pageSizes = [10, 25, 50, 100];
                    pageSizes.forEach(size => {
                        const option = document.createElement('option');
                        option.value = size;
                        option.text = size + ' rows';
                        if (size === params.paginationProxy.paginationPageSize) {
                            option.selected = true;
                        }
                        pageSizeSelector.appendChild(option);
                    });
                    
                    // Handle page size change
                    pageSizeSelector.addEventListener('change', function() {
                        params.api.paginationSetPageSize(Number(this.value));
                    });
                    
                    // Add to DOM
                    this.eGui.appendChild(pageSizeSelector);
                };
                
                CustomPaginationComp.prototype.getGui = function() {
                    return this.eGui;
                };
                
                return CustomPaginationComp;
            }

            // Add this at the end of your DOMContentLoaded event function

            // Create modal container element
            const modalContainer = document.createElement('div');
            modalContainer.className = 'cards-modal-container';
            modalContainer.style.display = 'none';
            document.body.appendChild(modalContainer);

            // Function to show the modal with all cards
            function showCardsModal(cards) {
                // Create modal content
                modalContainer.innerHTML = `
                    <div class="cards-modal">
                        <div class="cards-modal-header">
                            <h3>All Cards (${cards.length})</h3>
                            <button class="close-modal-btn">&times;</button>
                        </div>
                        <div class="cards-modal-content">
                            <div class="cards-grid">
                                ${cards.map(card => {
                                    const rarity = card.hero_rarity || 'common';
                                    const heroId = card.hero_id || '';
                                    const heroHandle = card.hero_handle || '';
                                    const heroStars = card.hero_stars || '';
                                    
                                    // Primary URL (v2) - uses hero_handle and hero_stars
                                    const imagePathV2 = `https://fantasy-top-cards.s3.eu-north-1.amazonaws.com/v2/${rarity}/${heroHandle}_${heroStars}.png`;
                                    
                                    // Fallback URL (v1) - uses hero_id and hero_stars
                                    const imagePathV1 = `https://fantasy-top-cards.s3.eu-north-1.amazonaws.com/v1/${rarity.toLowerCase()}/${heroId}_${heroStars}.png`;
                                    
                                    return `
                                        <div class="card-item">
                                            <img 
                                                src="${imagePathV2}" 
                                                alt="${rarity} card" 
                                                onerror="if(this.src !== '${imagePathV1}') { this.src='${imagePathV1}'; } else { this.src='https://fantasy-top-cards.s3.eu-north-1.amazonaws.com/v2/card_placeholder.png'; this.style.opacity='0.7'; }"
                                                title="ID: ${card.token_id || 'N/A'}, Rarity: ${rarity}"
                                            >
                                            <div class="card-info">
                                                <div class="card-id">ID: ${card.token_id || 'N/A'}</div>
                                                <div class="card-rarity">${rarity}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                // Show the modal
                modalContainer.style.display = 'flex';
                
                // Add event listener to close button
                document.querySelector('.close-modal-btn').addEventListener('click', function() {
                    modalContainer.style.display = 'none';
                });
                
                // Close modal when clicking outside
                modalContainer.addEventListener('click', function(e) {
                    if (e.target === modalContainer) {
                        modalContainer.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>