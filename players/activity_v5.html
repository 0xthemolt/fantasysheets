<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Prevent unload event listeners that block bfcache -->
    <script>
        // Store page state in sessionStorage for back/forward cache support
        window.addEventListener('pagehide', function() {
            if (mintsTable) {
                sessionStorage.setItem('tableState', JSON.stringify({
                    playerHandle: document.getElementById('playerSelect').value,
                    typeFilter: document.querySelector('.toggle-btn.active')?.getAttribute('data-filter') || 'all',
                    heroFilter: document.getElementById('heroSelect')?.value || ''
                }));
            }
        });
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://pbs.twimg.com">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FantasySheets | Player Activity</title>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style">
    <link rel="stylesheet" href="../styles.css?v=8e4c2f">
    <link rel="icon" type="image/png" href="../icons/favicon.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css">
    
    <!-- jQuery (required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
    
    <!-- Select2 for better dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
        }
        
        /* Custom DataTables controls layout */
        .table-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            gap: 10px;
        }
        
        .length-container {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            margin-right: 20px;
            min-width: 120px; /* Reduced width */
        }
        
        .dataTables_info {
            flex: 1 1 auto;
            margin: 0;
            font-size: 0.8em;
            white-space: nowrap;
            color: #888;
            padding: 8px 0;
        }
        
        .dataTables_paginate {
            flex: 0 0 auto;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        /* Make length selector more compact */
        .dataTables_length {
            display: flex;
            align-items: center;
            font-size: 0.85em;
            white-space: nowrap;
        }
        
        .dataTables_length label {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 0;
        }
        
        .dataTables_length select {
            width: 60px; /* Fixed width */
            margin: 0 5px;
            padding: 4px;
            height: 30px;
        }
        
        /* Ensure pagination buttons don't shrink too much */
        .dataTables_paginate .paginate_button {
            min-width: 28px;
            height: 28px;
            padding: 0 !important;
            margin: 0 2px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Media queries for small screens */
        @media (max-width: 767px) {
            .table-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .length-container {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .dataTables_info {
                width: 100%;
                margin-bottom: 10px;
                text-align: left;
            }
            
            .dataTables_paginate {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Filter styling */
        .type-filter, .hero-filter {
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .filter-label {
            font-weight: 500;
            color: #fff;
        }
        
        .toggle-container {
            display: flex;
            background-color: #222;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .toggle-btn {
            background-color: transparent;
            border: none;
            color: #fff;
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        
        .toggle-btn:hover {
            background-color: #333;
        }
        
        .toggle-btn.active {
            background-color: #3498db;
        }
        
        .container {
            max-width: 1200px; /* Increased by 15% from 1200px */
            margin: 0 auto;
            padding: 20px;
        }
        
        .player-selector {
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffffff;
            position: relative;
        }
        
        /* Custom select with player avatar */
        .custom-select-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .select-with-avatar {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            width: 100%;
        }
        
        .player-avatar-select {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            position: absolute;
            left: 10px;
            z-index: 1;
        }
        
        /* Select2 custom styling for dark theme */
        .select2-container {
            min-width: 330px;
            max-width: 100%;
        }
        
        .select2-container--default .select2-selection--single {
            background-color: #333;
            border: 1px solid #444;
            border-radius: 4px;
            height: 38px;
            padding: 4px 8px 4px 50px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9em;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #fff;
            line-height: 28px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9em;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }
        
        .select2-dropdown {
            background-color: #222;
            border: 1px solid #444;
        }
        
        .select2-container--default .select2-results__option {
            padding: 8px 12px;
            color: #fff;
        }
        
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #3498db;
        }
        
        .select2-container--default .select2-search--dropdown .select2-search__field {
            background-color: #333;
            color: #fff;
            border: 1px solid #444;
            padding: 8px;
            font-size: 0.9em;
        }
        
        .select2-results__option {
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }
        
        /* Custom scrollbar for Select2 dropdown */
        .select2-results__options::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .select2-results__options::-webkit-scrollbar-track {
            background: #222;
        }
        
        .select2-results__options::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        
        .select2-results__options::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .player-option {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-option-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .player-option-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #333;
            color: #ffffff;
            font-size: 14px;
            min-width: 250px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="6"><path d="M0 0h12L6 6z" fill="%23ffffff"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 30px;
        }
        
        option {
            background-color: #333;
            color: #ffffff;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* DataTables customization for dark theme */
        .dataTables_wrapper {
            padding: 10px 0;
            font-size: 14px;
            color: #ffffff;
        }
        
        .dataTables_length, .dataTables_filter {
            color: #888888;
            margin-top: 15px;
        }
        
        .dataTables_length select {
            background-color: #333;
            color: #888888;
            border: 1px solid #444;
            padding: 5px;
            border-radius: 4px;
            width: 50px; /* Adjusted width to better fit content */
        }
        
        .dataTables_filter input {
            background-color: #333;
            color: #ffffff;
            border: 1px solid #444;
            padding: 5px 10px;
            border-radius: 4px;
            width: 150px;
        }
        
        .dataTables_length {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dataTables_length label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dataTables_filter label {
            display: flex;
            align-items: center;
        }
        
        table.dataTable {
            border-collapse: collapse;
            width: 100%;
            min-width: 800px; /* Set minimum width */
            margin: 20px 0;
            color: #ffffff;
        }
        
        table.dataTable thead th {
            background-color: #333;
            color: #ffffff;
            font-weight: bold;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #444;
        }
        
        /* Fixed column widths */
        .type-column { width: 80px; max-width: 80px; }
        .time-column { width: 120px; max-width: 120px; }
        .price-column { width: 100px; max-width: 100px; }
        .cards-column { width: 120px; max-width: 120px; }
        .hero-column { width: 350px; max-width: 350px; }
        
        table.dataTable tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid #444;
            vertical-align: middle;
            background-color: #222 !important; /* Force consistent background */
        }
        
        table.dataTable tbody tr {
            background-color: #222 !important; /* Force consistent background */
        }
        
        table.dataTable tbody tr:hover {
            background-color: #333 !important;
        }
        
        /* Fix for alternating row colors */
        table.dataTable.stripe tbody tr.odd, 
        table.dataTable.display tbody tr.odd {
            background-color: #222 !important;
        }
        
        table.dataTable.stripe tbody tr.even, 
        table.dataTable.display tbody tr.even {
            background-color: #222 !important;
        }
        
        .dataTables_info {
            margin-top: 15px;
            color: #888888;
            font-size: 0.85em;
        }
        
        .dataTables_paginate {
            margin-top: 15px;
            color: #888888 !important;
        }
        
        .dataTables_paginate .paginate_button {
            padding: 6px 12px;
            margin: 0 3px;
            border-radius: 4px;
            cursor: pointer;
            color: #888888 !important;
            background-color: #222 !important;
            border: none !important;
            transition: all 0.2s ease;
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .dataTables_paginate .paginate_button.current {
            background-color: #3498db !important;
            color: white !important;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
        }
        
        .dataTables_paginate .paginate_button:hover {
            background-color: #333 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .dataTables_paginate .paginate_button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .dataTables_paginate .paginate_button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Additional overrides to ensure styles are applied */
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: #888888 !important;
            background-color: #222 !important;
            border: none !important;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            color: white !important;
            background-color: #333 !important;
            border: none !important;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.current, 
        .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
            color: white !important;
            border: none !important;
            background: #3498db !important;
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .timestamp-cell {
            white-space: nowrap;
            background-color: #222 !important; /* Force consistent background */
        }
        
        .price-cell {
            font-weight: bold;
            white-space: nowrap;
        }
        
        /* Type column styling */
        .type-cell {
            text-align: center;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .type-mint {
            background-color: #F72BBC;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .type-pack {
            background-color: #F99810;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .type-levelup {
            background-color: #98FB00;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-sell {
            background-color: #A855F7;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-buy {
            background-color: #22C55E;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-burn {
            background-color: #FF1F4B;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Match toggle button colors to table type colors */
        .toggle-btn[data-filter="mint"].active {
            background-color: #F72BBC;
        }
        
        .toggle-btn[data-filter="pack"].active {
            background-color: #F99810;
        }
        
        .toggle-btn[data-filter="level up"].active {
            background-color: #98FB00;
        }
        
        .toggle-btn[data-filter="all"].active {
            background-color: #3498db;
        }

        .toggle-btn[data-filter="sell"].active {
            background-color: #A855F7;
        }

        .toggle-btn[data-filter="buy"].active {
            background-color: #22C55E;
        }   
        
        .toggle-btn[data-filter="burn"].active {
            background-color: #FF1F4B;
        }   
        
        /* Vertically align ETH icon with price */
        .price-with-icon {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .price-with-icon svg {
            vertical-align: middle;
            margin-top: -2px;
        }
        
        .cards-cell {
            text-align: center;
            font-weight: bold;
        }
        
        .hero-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }
        
        .hero-card {
            width: 32px;
            height: 46px;
            border-radius: 2px;
            object-fit: cover;
        }
        
        /* Match select-with-avatar styles for hero-select-dropdown */
        .hero-select-dropdown .select2-container--default .select2-selection--single {
            background-color: #333;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 4px 8px 4px 50px;
            height: 38px;
        }
        
        .hero-select-dropdown .select2-selection__rendered {
            color: #fff;
            line-height: 28px;
        }
        
        .hero-select-dropdown .select2-selection__arrow {
            background-color: #444;
        }
        
        .hero-select-dropdown .select2-results__option {
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }

        /* Add these styles for level-up cards */
        .level-up-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .level-up-card-container {
            display: flex;
            align-items: center;
            border-radius: 4px;
            padding: 4px 8px;
        }

        /* Add skip card styling */
        .level-up-card-container.skip-card {
            background-color: rgba(241, 196, 15, 0.1); /* Gold color for skip cards */
            border: 1px solid rgba(241, 196, 15, 0.2);
        }

        .level-up-arrow {
            margin: 0 8px; /* Increased margin for better spacing */
            color: #888;
            font-weight: 900; /* Increased from bold to 900 for thicker arrow */
            font-size: 20px; /* Increased from 16px for larger arrow */
        }

        /* Add spacing between the duplicate "from" cards */
        .level-up-card-before + .level-up-card-before {
            margin-left: 2px;
        }

        .skip-label {
            color: gold;
            font-weight: bold;
            margin-left: 10px;
            font-size: 14px;
        }

    </style>
</head>
<body>
    <div class="title-container" style="display: flex; align-items: flex-end; justify-content: center;">
        <h1 class="title-header" style="margin: 0;">
            <a href="../index.html" class="home-link">
                <i class="fas fa-home"></i>
            </a>
            FantasySheets Player Activity
        </h1>
        <div class="info-div">
            <i class="fas fa-info-circle" style="margin-left: 4px; cursor: help;" title="View player minting activity and card details"></i>
        </div>
    </div>
    
    <div class="container">
        <div class="player-selector">
            <label for="playerSelect">Select Player:</label>
            <div class="select-with-avatar">
                <img id="selectedPlayerAvatar" src="/icons/ft_logo.webp" onerror="this.src='/icons/ft_logo.webp'" class="player-avatar-select" alt="Player avatar">
                <select id="playerSelect" style="padding-left: 50px;" class="js-example-basic-single">
                    <option value="">Loading players...</option>
                </select>
            </div>
        </div>
        
        <div class="type-filter">
            <div class="filter-label">Filter Type:</div>
            <div class="toggle-container">
                <button class="toggle-btn active" data-filter="all">All</button>
                <button class="toggle-btn" data-filter="mint">Mint</button>
                <button class="toggle-btn" data-filter="pack">Pack</button>
                <button class="toggle-btn" data-filter="level up">Level Up</button>
                <button class="toggle-btn" data-filter="buy">Buy</button>
                <button class="toggle-btn" data-filter="sell">Sell</button>
                <button class="toggle-btn" data-filter="burn">Burn</button>
            </div>
        </div>
        
        <div class="hero-filter">
            <div class="filter-label">Filter Hero:</div>
            <select id="heroSelect" class="js-example-basic-single">
                <option value="">All Heroes</option>
                <!-- Hero options will be populated dynamically -->
            </select>
        </div>
        
        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
        </div>
        
        <table id="mintsTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Time</th>
                    <th>Price</th>
                    <th>Cards</th>
                    <th>Hero Cards</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be populated by DataTables -->
            </tbody>
        </table>
    </div>
<script>
    const supabaseUrl = 'https://hhcuqhvmzwmehdsaamhn.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoY3VxaHZtendtZWhkc2FhbWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzIwMTIsImV4cCI6MjA1MDU0ODAxMn0.xJNGoFLnpnmQGLj8RY_4VLmefPmFzuOyiVHLvFtPkkE';
    
    // Initialize the Supabase client
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    
    // Default player handle
    const DEFAULT_PLAYER = 'OttoSuwenNFT';
    
    // DataTable instance
    let mintsTable;
    
    // Function to fetch all players
    async function fetchPlayers() {
        try {
            const { data, error } = await supabaseClient
                .from('players')
                .select('player_address, player_name, player_pfp_url, player_handle, fan_pts')
                .order('fan_pts', { ascending: false });
                
            if (error) {
                console.error('Error fetching players:', error);
                return [];
            }
            
            return data || [];
        } catch (error) {
            console.error('Error in fetchPlayers:', error);
            return [];
        }
    }
    
    // Function to fetch player mints for a specific player
    async function fetchPlayerMints(playerHandle) {
        if (!playerHandle) {
            console.error('No player handle provided');
            return [];
        }
        
        try {
            const { data, error } = await supabaseClient
                .from('player_mints')
                .select('type, player_address, player_name, player_handle, player_pfp_url, tx_hash, timestamp, price, cards, hero_details')
                .eq('player_handle', playerHandle);
                
            if (error) {
                console.error('Error fetching player mints:', error);
                return [];
            }
            
            return data || [];
        } catch (error) {
            console.error('Error in fetchPlayerMints:', error);
            return [];
        }
    }
    
    // Format timestamp as relative time with BlastScan link
    function formatTimestamp(timestamp, txHash) {
        if (!timestamp) return 'N/A';
        
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        let timeText;
        if (diffDays > 0) {
            timeText = `${diffDays}d ago`;
        } else if (diffHours > 0) {
            timeText = `${diffHours}h ago`;
        } else if (diffMins > 0) {
            timeText = `${diffMins}m ago`;
        } else {
            timeText = 'Just now';
        }
        
        // Add BlastScan link if txHash is available
        if (txHash) {
            return `<a href="https://blastscan.io/tx/${txHash}" target="_blank" title="View on BlastScan" style="color: #ffffff; text-decoration: none;">${timeText}</a>`;
        } else {
            return timeText;
        }
    }
    
    // Format price with ETH symbol
    function formatPrice(price) {
        if (price === null || price === undefined || price === 0) return '';
        
        // ETH SVG icon
        const ethIcon = '<svg width="16" height="16" viewBox="0 0 256 417" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid"><path fill="#8A92B2" d="M127.961 0l-2.795 9.5v275.668l2.795 2.79 127.962-75.638z"></path><path fill="#62688F" d="M127.962 0L0 212.32l127.962 75.639V154.158z"></path><path fill="#454A75" d="M127.961 312.187l-1.575 1.92v98.199l1.575 4.6L256 236.587z"></path><path fill="#62688F" d="M127.962 416.905v-104.72L0 236.585z"></path><path fill="#8A92B2" d="M127.961 287.958l127.96-75.637-127.96-58.162z"></path><path fill="#62688F" d="M0 212.32l127.96 75.638v-133.8z"></path></svg>';
        
        // Format price with 4 decimal places and ETH icon in a flex container for vertical alignment
        return `<div class="price-with-icon"><span>${price.toFixed(4)}</span>${ethIcon}</div>`;
    }
    
    // Memoize hero card rendering to avoid repeated DOM creation
    const heroCardCache = new Map();

    // Update the renderHeroCards function:
    function renderHeroCards(heroDetails, type) {
        if (!heroDetails) return 'No cards';
        
        try {
            // Safely handle heroDetails whether it's a string or object
            const heroData = (() => {
                if (typeof heroDetails === 'string') {
                    try {
                        return JSON.parse(heroDetails);
                    } catch (e) {
                        console.error('Invalid JSON in heroDetails:', e);
                        return null;
                    }
                }
                return heroDetails;
            })();

            if (!heroData) return 'Error: Invalid card data';
            
            // For regular card rendering
            const getImagePath = (card) => {
                const rarity = card.hero_rarity || 'common';
                const heroId = card.hero_id || '';
                const heroStars = card.hero_stars || '';
                const version = card.hero_is_deleted ? 'v1' : 'v2';
                
                return `https://fantasy-top-cards.s3.eu-north-1.amazonaws.com/${version}/${rarity}/${heroId}_${heroStars}.png`;
            };

            // Special rendering for level up and burn cards
            if (type && (type.toLowerCase() === 'level up' || type.toLowerCase() === 'burn')) {
                let html = '<div class="level-up-cards">';
                
                if (type.toLowerCase() === 'level up') {
                    // For level up, handle array structure
                    const card = Array.isArray(heroData) ? heroData[0] : heroData;
                    if (!card) return 'Invalid card data';
                    
                    const fromRarity = card.from_rarity || 'common';
                    const toRarity = card.hero_rarity || 'common';
                    const heroId = card.hero_id || '';
                    const heroStars = card.hero_stars || '';
                    const heroHandle = card.hero_handle || '';
                    const isSkip = Boolean(card.is_skip);
                    const version = card.hero_is_deleted ? 'v1' : 'v2';
                    
                    // Create container with conditional class for skip cards
                    html += `
                        <div class="level-up-card-container${isSkip ? ' skip-card' : ''}" 
                             title="${isSkip ? 'Skip Level Up - ' : ''}Handle: @${heroHandle}">
                            <!-- First and Second "from" cards -->
                            ${[1, 2].map(() => `
                                <img 
                                    src="https://fantasy-top-cards.s3.eu-north-1.amazonaws.com/${version}/${fromRarity}/${heroId}_${heroStars}.png" 
                                    alt="${fromRarity} card" 
                                    class="hero-card level-up-card-before"
                                    data-hero-handle="${heroHandle}"
                                    title="ID: ${card.token_id || 'N/A'}, Rarity: ${fromRarity}, Handle: @${heroHandle}"
                                />
                            `).join('')}
                            <div class="level-up-arrow">→</div>
                            <!-- "to" card -->
                            <img 
                                src="https://fantasy-top-cards.s3.eu-north-1.amazonaws.com/${version}/${toRarity}/${heroId}_${heroStars}.png" 
                                alt="${toRarity} card" 
                                class="hero-card level-up-card-after"
                                data-hero-handle="${heroHandle}"
                                title="ID: ${card.token_id || 'N/A'}, Rarity: ${toRarity}, Handle: @${heroHandle}"
                            />
                            ${isSkip ? '<div class="skip-label">Skip</div>' : ''}
                        </div>
                    `;
                } else if (type.toLowerCase() === 'burn') {
                    // For burn, handle array of objects with from and to arrays
                    const burnData = Array.isArray(heroData) ? heroData[0] : heroData;
                    
                    if (burnData && burnData.from && burnData.to) {
                        const fromCards = burnData.from;
                        const toCard = burnData.to[0]; // Get first card from to array
                        
                        if (fromCards.length === 2 && toCard) {
                            html += `
                                <div class="level-up-card-container burn-card">
                                    <!-- Two different "from" cards -->
                                    ${fromCards.map(card => `
                                        <img 
                                            src="${getImagePath(card)}" 
                                            alt="${card.hero_rarity} card" 
                                            class="hero-card level-up-card-before"
                                            data-hero-handle="${card.hero_hande || ''}"
                                            title="ID: ${card.token_id || 'N/A'}, Rarity: ${card.hero_rarity}, Handle: @${card.hero_hande || ''}"
                                        />
                                    `).join('')}
                                    <div class="level-up-arrow">→</div>
                                    <!-- "to" card -->
                                    <img 
                                        src="${getImagePath(toCard)}" 
                                        alt="${toCard.hero_rarity} card" 
                                        class="hero-card level-up-card-after"
                                        data-hero-handle="${toCard.hero_hande || ''}"
                                        title="ID: ${toCard.token_id || 'N/A'}, Rarity: ${toCard.hero_rarity}, Handle: @${toCard.hero_hande || ''}"
                                    />
                                </div>
                            `;
                        }
                    }
                }
                
                html += '</div>';
                return html;
            }
            
            // Regular rendering for non-level-up cards (existing array handling code)
            let html = '<div class="hero-cards">';
            
            // Show first 10 cards
            const cardsToShow = heroData.slice(0, 10);
            
            cardsToShow.forEach(card => {
                const rarity = card.hero_rarity || 'common';
                const heroHandle = card.hero_handle || card.hero_hande || '';
                
                html += `
                    <img 
                        src="${getImagePath(card)}" 
                        alt="${rarity} card" 
                        class="hero-card"
                        loading="lazy"
                        title="ID: ${card.token_id || 'N/A'}, Rarity: ${rarity}, Handle: @${heroHandle}"
                        data-hero-handle="${heroHandle}"
                    />
                `;
            });
            
            // If there are more cards, show count
            if (heroData.length > 10) {
                html += `<span style="margin-left: 5px; align-self: center;">+${heroData.length - 10} more</span>`;
            }
            
            html += '</div>';
            
            return html;
        } catch (e) {
            console.error('Error rendering hero cards:', e, {
                type: type,
                heroDetails: heroDetails
            });
            return 'Error displaying cards';
        }
    }
    
    // Initialize DataTable
    function initializeDataTable(data) {
        // Destroy existing table if it exists
        if (mintsTable) {
            mintsTable.destroy();
        }
        
        // Populate hero filter with unique hero handles from data
        populateHeroFilter(data);
        
        // Initialize DataTable
        mintsTable = new DataTable('#mintsTable', {
            data: data,
            dom: 'rt<"table-controls"<"length-container"l>ip>',
            columns: [
                { 
                    data: 'type',
                    className: 'type-cell type-column',
                    render: function(data, type, row) {
                        // First check the 'type' field from database
                        if (data === 'level up') {
                            return '<span class="type-levelup">Level Up</span>';
                        } else if (data === 'mint') {
                            return '<span class="type-mint">Mint</span>';
                        } else if (data === 'pack') {
                            return '<span class="type-pack">Pack</span>';
                        } else if (data === 'sell') {           
                            return '<span class="type-sell">Sell</span>';
                        } else if (data === 'buy') {
                            return '<span class="type-buy">Buy</span>';
                        } else if (data === 'burn') {
                            return '<span class="type-burn">Burn</span>';
                        } else if (data === 'transfer') 

                        
                        // Fallback to old method for backward compatibility
                        if (row.price === null || row.price === undefined || row.price === 0) {
                            return '<span class="type-mint">Mint</span>';
                        } else {
                            return '<span class="type-pack">Pack</span>';
                        }
                    },
                    // Add a custom search function for type filtering
                    search: function(data, searchText) {
                        if (searchText === 'mint') {
                            return data === 'mint' || (data === null || data === undefined || data === 0);
                        } else if (searchText === 'pack') {
                            return data === 'pack' || (data !== null && data !== undefined && data !== 0);
                        } else if (searchText === 'levelup') {
                            return data === 'level up';
                        }
                        return true; // 'all' or any other value
                    }
                },
                { 
                    data: 'timestamp',
                    className: 'timestamp-cell time-column',
                    render: function(data, type, row) {
                        // For sorting and filtering, use the raw timestamp
                        if (type === 'sort' || type === 'type') {
                            return data;
                        }
                        // For display, use the formatted timestamp
                        return formatTimestamp(data, row.tx_hash);
                    }
                },
                { 
                    data: 'price',
                    className: 'price-cell price-column',
                    render: function(data) {
                        if (data === null || data === undefined || data === 0) return '';
                        return `<div class="price-with-icon" style="justify-content: flex-end;">${formatPrice(data)}</div>`;
                    }
                },
                { 
                    data: 'cards',
                    className: 'cards-cell cards-column',
                    render: function(data) {
                        if (data === null || data === undefined) return 'N/A';
                        return `<div style="text-align: center;">${data}</div>`;
                    }
                },
                { 
                    data: 'hero_details',
                    className: 'hero-column',
                    render: function(data, type, row) {
                        // Ensure data is properly parsed if it's a string
                        let parsedData = data;
                        if (typeof data === 'string') {
                            try {
                                parsedData = JSON.parse(data);
                            } catch (e) {
                                console.error('Error parsing hero_details:', e);
                            }
                        }
                        return renderHeroCards(parsedData, row.type);
                    }
                }
            ],
            order: [[1, 'desc']], // Sort by timestamp descending
            pageLength: 10,      // Show 100 records per page
            lengthMenu: [10, 25, 50],
            responsive: true,
            language: {
                search: "",
                searchPlaceholder: "Search hero",
                lengthMenu: "_MENU_ records",
                info: "_START_ to _END_ of _TOTAL_ records",
                infoEmpty: "Showing 0 to 0 of 0 entries",
                infoFiltered: "(_MAX_ total entries)",
                paginate: {
                    first: "«",
                    last: "»",
                    next: "›",
                    previous: "‹"
                }
            },
            // Custom search function for hero handles
            search: {
                caseInsensitive: true,
                smart: true,
                regex: false,
                // Custom search function that only searches hero_details for hero handles
                callback: function(settings, searchData, index, rowData) {
                    const searchTerm = settings.oPreviousSearch.sSearch;
                    if (!searchTerm) return true;
                    
                    // Only search hero_details column for hero handles
                    const result = searchHeroHandles(rowData.hero_details, searchTerm);
                    
                    // For debugging - log the search results
                    if (searchTerm && searchTerm.length > 2 && rowData.hero_details) {
                        try {
                            const heroCards = typeof rowData.hero_details === 'string' ? 
                                JSON.parse(rowData.hero_details) : rowData.hero_details;
                            if (Array.isArray(heroCards) && heroCards.length > 0) {
                                const handles = heroCards.map(card => card.hero_handle || card.hero_hande || 'unknown').join(', ');
                                console.debug(`Search '${searchTerm}' in [${handles}]: ${result ? 'MATCH' : 'no match'}`);
                            }
                        } catch (e) {}
                    }
                    
                    return result;
                }
            },
            // Default sort order - most recent first
            order: [[1, 'desc']]
        });
    }
    
    // Populate player dropdown with Select2 and search functionality
    async function populatePlayerDropdown() {
        const playerSelect = document.getElementById('playerSelect');
        const selectedPlayerAvatar = document.getElementById('selectedPlayerAvatar');
        const allPlayers = await fetchPlayers();
        
        if (allPlayers.length === 0) {
            playerSelect.innerHTML = '<option value="">No players found</option>';
            return;
        }
        
        // Get top 10 players by fan_pts (already sorted in fetchPlayers)
        const topPlayers = allPlayers.slice(0, 10);
        
        // Find default player in all players
        let defaultPlayer = allPlayers.find(p => p.player_handle === DEFAULT_PLAYER);
        let defaultPlayerFound = !!defaultPlayer;
        let defaultPlayerAvatar = defaultPlayer?.player_pfp_url || '/icons/ft_logo.webp';
        
        // Prepare options
        let options = '';
        
        // Add default player if not in top 10
        if (defaultPlayerFound && !topPlayers.some(p => p.player_handle === DEFAULT_PLAYER)) {
            const playerAvatar = defaultPlayer.player_pfp_url || '/icons/ft_logo.webp';
            options += `<option value="${defaultPlayer.player_handle}" data-avatar="${playerAvatar}" selected>
                ${defaultPlayer.player_name || 'Unknown'} (@${defaultPlayer.player_handle || ''})
            </option>`;
        }
        
        // Add top players
        topPlayers.forEach(player => {
            const isDefault = player.player_handle === DEFAULT_PLAYER;
            const playerAvatar = player.player_pfp_url || '/icons/ft_logo.webp';
            
            options += `<option value="${player.player_handle}" data-avatar="${playerAvatar}" ${isDefault ? 'selected' : ''}>
                ${player.player_name || 'Unknown'} (@${player.player_handle || ''})
            </option>`;
        });
        
        // If default player not found anywhere, add it
        if (!defaultPlayerFound) {
            options = `<option value="${DEFAULT_PLAYER}" data-avatar="/icons/ft_logo.webp" selected>@${DEFAULT_PLAYER}</option>` + options;
        } else {
            // Set the default player avatar
            selectedPlayerAvatar.src = defaultPlayerAvatar;
        }
        
        playerSelect.innerHTML = options;
        
        // Initialize Select2 with custom template for options
        $(playerSelect).select2({
            dropdownParent: $('.select-with-avatar').parent(),
            placeholder: 'Search for a player...',
            allowClear: false,
            templateResult: formatPlayerOption,
            templateSelection: formatPlayerSelection,
            dropdownCssClass: 'player-select-dropdown',
            data: allPlayers.map(player => ({
                id: player.player_handle,
                text: `${player.player_name || 'Unknown'} (@${player.player_handle || ''})`,
                avatar: player.player_pfp_url || '/icons/ft_logo.webp',
                player: player
            })),
            escapeMarkup: function(markup) {
                return markup;
            }
        });
        
        // Add custom styles for player dropdown
        $('<style>').text(`
            .player-select-dropdown {
                background-color: #222 !important;
                border: 1px solid #444 !important;
            }
            
            .player-select-dropdown .select2-results__options {
                background-color: #222 !important;
                color: #fff !important;
            }
            
            .player-select-dropdown .select2-results__option {
                color: #fff !important;
                padding: 8px 12px !important;
            }
            
            .player-select-dropdown .select2-results__option--highlighted {
                background-color: #333 !important;
            }
            
            .player-select-dropdown .select2-results__option--selected {
                background-color: #3498db !important;
            }
            
            .player-select-dropdown .select2-search__field {
                background-color: #333 !important;
                color: #fff !important;
                border: 1px solid #444 !important;
            }
            
            .player-select-dropdown .select2-results__options::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            
            .player-select-dropdown .select2-results__options::-webkit-scrollbar-track {
                background: #222;
            }
            
            .player-select-dropdown .select2-results__options::-webkit-scrollbar-thumb {
                background: #444;
                border-radius: 4px;
            }
            
            .player-select-dropdown .select2-results__options::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
        `).appendTo('head');
        
        // Update avatar when selection changes
        $(playerSelect).on('change', function() {
            const data = $(this).select2('data')[0];
            if (data && data.avatar) {
                selectedPlayerAvatar.src = data.avatar;
            }
            loadPlayerData(this.value);
        });
    }
    
    // Format player option for Select2 dropdown
    function formatPlayerOption(player) {
        if (!player.id) return player.text;
        
        // Truncate player text if too long
        let displayText = player.text;
        if (displayText.length > 25) {
            const parts = displayText.split('(@');
            if (parts.length > 1) {
                // Truncate the name part but keep the handle
                const name = parts[0].trim();
                const handle = '@' + parts[1];
                if (name.length > 15) {
                    displayText = name.substring(0, 15) + '... ' + handle;
                }
            } else {
                displayText = displayText.substring(0, 25) + '...';
            }
        }
        
        // Only show text in dropdown for better performance
        return $(`
            <div class="player-option">
                <div class="player-option-text">${displayText}</div>
            </div>
        `);
    }
    
    // Format player selection for Select2
    function formatPlayerSelection(player) {
        if (!player.id) return player.text;
        
        // Only return text for the selected display (avatar is handled separately)
        return player.text;
    }
    
    // Load data for selected player
    async function loadPlayerData(playerHandle) {
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.style.display = 'flex';
        
        try {
            const mints = await fetchPlayerMints(playerHandle || DEFAULT_PLAYER);
            
            // Store the currently selected filter type before reinitializing table
            const activeFilterType = document.querySelector('.toggle-btn.active')?.getAttribute('data-filter');
            
            // Initialize the table with new data
            initializeDataTable(mints);
            
            // After table initialization, reapply the filter if one was active
            if (activeFilterType) {
                filterTableByType(activeFilterType);
            }
            
            // Also reapply hero filter if one is selected
            const selectedHero = $('#heroSelect').val();
            if (selectedHero) {
                filterTableByHero(selectedHero);
            }
            
        } catch (error) {
            console.error('Error loading player data:', error);
            alert('Error loading player data. Please try again.');
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }
    
    // Filter table by type
    function filterTableByType(type) {
        if (!mintsTable) return;
        
        if (type === 'all') {
            mintsTable.column(0).search('').draw();
        } else {
            // Use a custom search for type column
            mintsTable.column(0).search(type, false, false).draw();
        }
    }
    
    // Extract unique hero handles from data
    function extractUniqueHeroHandles(data) {
        const uniqueHandles = new Set();
        
        data.forEach(row => {
            try {
                const heroDetails = typeof row.hero_details === 'string' ? 
                    JSON.parse(row.hero_details) : row.hero_details;
                
                if (Array.isArray(heroDetails)) {
                    heroDetails.forEach(card => {
                        const heroHandle = card.hero_handle || card.hero_hande || '';
                        if (heroHandle) {
                            uniqueHandles.add(heroHandle);
                        }
                    });
                }
            } catch (e) {
                console.error('Error extracting hero handles:', e);
            }
        });
        
        // Convert to array and sort alphabetically
        return Array.from(uniqueHandles).sort((a, b) => a.localeCompare(b));
    }
    
    // Populate hero filter dropdown with unique hero handles
    function populateHeroFilter(data) {
        if (!data || !Array.isArray(data)) return;
        
        const heroSelect = $('#heroSelect');
        heroSelect.empty();
        heroSelect.append('<option value="">All Heroes</option>');
        
        // Extract unique hero handles from hero_details
        const uniqueHeroes = new Set();
        data.forEach(item => {
            try {
                const heroDetails = typeof item.hero_details === 'string' ? 
                    JSON.parse(item.hero_details) : item.hero_details;
                
                if (Array.isArray(heroDetails)) {
                    heroDetails.forEach(card => {
                        const heroHandle = card.hero_handle || card.hero_hande;
                        if (heroHandle) {
                            uniqueHeroes.add(heroHandle);
                        }
                    });
                }
            } catch (e) {
                console.error('Error parsing hero details:', e);
            }
        });
        
        // Add options for each unique hero handle
        Array.from(uniqueHeroes).sort().forEach(hero => {
            heroSelect.append(`<option value="${hero}">${hero}</option>`);
        });
        
        // Initialize Select2
        $('#heroSelect').select2({
            dropdownParent: $('.hero-filter'),
            placeholder: 'Select a hero',
            allowClear: true
        });
    }
    
    // Filter table by hero handle
    function filterTableByHero(heroHandle) {
        if (!mintsTable) return;
        
        console.log('Starting filter by hero:', heroHandle);
        
        // Clear any existing custom search filters
        while ($.fn.dataTable.ext.search.length > 0) {
            $.fn.dataTable.ext.search.pop();
        }
        
        if (heroHandle) {
            console.log('Setting up filter for hero:', heroHandle);
            
            // Add custom search function
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex, rowData) {
                if (!heroHandle) return true;
                
                try {
                    // Get hero_details
                    const heroDetails = typeof rowData.hero_details === 'string' ? 
                        JSON.parse(rowData.hero_details) : rowData.hero_details;
                    
                    // Debug output to see what's being processed
                    console.debug('Row hero details for filtering:', 
                        JSON.stringify(heroDetails).substring(0, 100) + '...');
                    
                    if (!Array.isArray(heroDetails) || heroDetails.length === 0) {
                        console.debug('No hero details found in row');
                        return false;
                    }
                    
                    // Check if any card has the selected hero handle (checking both correct and typo versions)
                    const result = heroDetails.some(card => {
                        const cardHeroHandle = (card.hero_handle || card.hero_hande || '').toLowerCase();
                        const match = cardHeroHandle === heroHandle.toLowerCase();
                        
                        // Log matching attempts for debugging
                        if (match) {
                            console.debug(`Found match for ${heroHandle} in card: ${cardHeroHandle}`);
                        }
                        
                        return match;
                    });
                    
                    return result;
                } catch (e) {
                    console.error('Error filtering by hero:', e, rowData);
                    return false;
                }
            });
            
            console.log('Filter function installed, redrawing table');
        } else {
            console.log('No hero selected, showing all rows');
        }
        
        // Redraw the table with the filter applied
        mintsTable.draw();
        
        // Log row count after filtering
        console.log(`Table now shows ${mintsTable.rows({search:'applied'}).count()} rows after filtering`);
    }
    
    // Custom search function for hero handles
    function searchHeroHandles(data, searchTerm) {
        if (!data || !searchTerm) return false;
        searchTerm = searchTerm.toLowerCase().trim();
        if (searchTerm === '') return true;
        
        try {
            // Parse hero_details from JSON if it's a string
            const heroCards = typeof data === 'string' ? JSON.parse(data) : data;
            
            if (!Array.isArray(heroCards) || heroCards.length === 0) {
                return false;
            }
            
            // Log the data for debugging
            console.debug('Searching in hero cards:', heroCards);
            
            // Search through hero handles - more thorough search
            for (const card of heroCards) {
                // Check both hero_handle and hero_hande fields (to handle typo in data)
                const heroHandle = (card.hero_handle || card.hero_hande || '').toLowerCase();
                console.debug(`Checking hero handle: ${heroHandle}`);
                
                // Remove @ symbol from search term if present
                const cleanSearchTerm = searchTerm.replace('@', '');
                const cleanHeroHandle = heroHandle.replace('@', '');
                
                // Check if the handle contains the search term or if it's a partial match
                if (cleanHeroHandle.includes(cleanSearchTerm) || 
                    (cleanHeroHandle.length > 0 && cleanSearchTerm.includes(cleanHeroHandle))) {
                    console.debug(`MATCH FOUND: ${cleanHeroHandle} matches ${cleanSearchTerm}`);
                    return true;
                }
            }
            
            return false;
        } catch (e) {
            console.error('Error searching hero handles:', e);
            return false;
        }
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', async function() {
        // Hide table until data is loaded
        document.getElementById('mintsTable').style.display = 'none';
        
        // Populate player dropdown
        await populatePlayerDropdown();
        
        // Check for saved state from bfcache
        const savedState = sessionStorage.getItem('tableState');
        let playerToLoad = DEFAULT_PLAYER;
        
        if (savedState) {
            try {
                const state = JSON.parse(savedState);
                if (state.playerHandle) {
                    playerToLoad = state.playerHandle;
                    console.log('Restoring state for player:', playerToLoad);
                }
            } catch (e) {
                console.error('Error parsing saved state:', e);
            }
        }
        
        // Load data for player (default or from saved state)
        await loadPlayerData(playerToLoad);
        
        // Show table
        document.getElementById('mintsTable').style.display = 'table';
        
        // Add event listeners for type filter buttons
        document.querySelectorAll('.toggle-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Update active button
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                // Filter table by type
                const filterType = this.getAttribute('data-filter');
                filterTableByType(filterType);
            });
        });
        
        // Initialize hero select with Select2
        $('#heroSelect').select2({
            theme: 'classic',
            placeholder: 'Select Hero',
            allowClear: true,
            width: '300px',
            dropdownCssClass: 'hero-select-dropdown',
            selectionCssClass: 'hero-selection'
        });
        
        // Add custom styles to match player dropdown
        $('<style>').text(`
            .hero-select-dropdown {
                background-color: #222 !important;
                border: 1px solid #444 !important;
            }
            
            .hero-select-dropdown .select2-results__options {
                background-color: #222 !important;
                color: #fff !important;
            }
            
            .hero-select-dropdown .select2-results__option {
                color: #fff !important;
                padding: 8px 12px !important;
            }
            
            .hero-select-dropdown .select2-results__option--highlighted {
                background-color: #333 !important;
            }
            
            .hero-select-dropdown .select2-results__option--selected {
                background-color: #3498db !important;
            }
            
            .hero-select-dropdown .select2-search__field {
                background-color: #333 !important;
                color: #fff !important;
                border: 1px solid #444 !important;
            }
            
            .hero-select-dropdown .select2-results__options::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            
            .hero-select-dropdown .select2-results__options::-webkit-scrollbar-track {
                background: #222;
            }
            
            .hero-select-dropdown .select2-results__options::-webkit-scrollbar-thumb {
                background: #444;
                border-radius: 4px;
            }
            
            .hero-select-dropdown .select2-results__options::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            
            #heroSelect + .select2-container .select2-selection {
                background-color: #333 !important;
                border: 1px solid #444 !important;
            }
            
            #heroSelect + .select2-container .select2-selection__rendered {
                color: #fff !important;
            }
            
            #heroSelect + .select2-container .select2-selection__arrow {
                background-color: #444 !important;
            }
            
            /* Fix for white background in selected hero */
            #heroSelect + .select2-container .select2-selection {
                background-color: #333 !important;
                border: 1px solid #444 !important;
            }
            
            #heroSelect + .select2-container .select2-selection__rendered {
                color: #fff !important;
                background-color: #333 !important;
            }
        `).appendTo('head');
        
        // Restore filters from saved state if available
        if (savedState) {
            try {
                const state = JSON.parse(savedState);
                
                // Restore type filter
                if (state.typeFilter && state.typeFilter !== 'all') {
                    const typeButton = document.querySelector(`.toggle-btn[data-filter="${state.typeFilter}"]`);
                    if (typeButton) {
                        document.querySelectorAll('.toggle-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        typeButton.classList.add('active');
                        filterTableByType(state.typeFilter);
                    }
                }
                
                // Restore hero filter
                if (state.heroFilter) {
                    setTimeout(() => {
                        $('#heroSelect').val(state.heroFilter).trigger('change');
                    }, 500); // Small delay to ensure Select2 is fully initialized
                }
            } catch (e) {
                console.error('Error restoring filters from saved state:', e);
            }
        }
        
        // Add this event listener after initializing the hero select
        $('#heroSelect').on('change', function() {
            const selectedHero = $(this).val();
            console.log('Hero selected:', selectedHero);
            filterTableByHero(selectedHero);
        });
    });
    
    // Store page state when user navigates away
    window.addEventListener('pagehide', function() {
        if (typeof mintsTable !== 'undefined' && mintsTable) {
            try {
                sessionStorage.setItem('tableState', JSON.stringify({
                    playerHandle: document.getElementById('playerSelect').value,
                    typeFilter: document.querySelector('.toggle-btn.active')?.getAttribute('data-filter') || 'all',
                    heroFilter: document.getElementById('heroSelect')?.value || ''
                }));
                console.log('State saved for back/forward cache');
            } catch (e) {
                console.error('Error saving state:', e);
            }
        }
    });
</script>
<!-- Move from head to end of body -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LXJ5Q7LKKE"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-LXJ5Q7LKKE', {
        'send_page_view': true,
        'cache_busting': true
    });
</script>
</body>
</html>