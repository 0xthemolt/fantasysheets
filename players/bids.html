<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Listings</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        @media (min-width: 992px) {
            .grid-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .hero-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .hero-card h3 {
            margin: 0 0 0.5rem 0;
            color: #333;
        }

        .hero-info {
            color: #666;
            margin: 0.25rem 0;
        }

        .hero-price {
            font-weight: bold;
            color: #2c5282;
            margin-top: 0.5rem;
        }



        .price-col {
            text-align: right;
        }

        .themolt-bid {
            background-color: #e6f7ff;
        }        .card-image {
            width: 20%;
            height: auto;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }

        .player-bid {
            color: #4ADE80 !important;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="results" class="grid-container"></div>

    <script>        async function fetchOrderbook(heroId, rarity) {
            const response = await fetch(`https://api-v2.fantasy.top/marketplace/bid-orders?heroId=${heroId}&rarity=${rarity}&includeOrderbook=true&includePersonalBids=true&includeHighestFiveBids=true`, {
                headers: {
                    'accept': 'application/json',
                    'x-api-key': 'cbc57228-5495-47b0-ae2f-b43ba6d5a9b6'
                }
            });
            return await response.json();
        }        const PLAYER_ADDRESS = '0x162F95a9364c891028d255467F616902A479681a';

        async function fetchBids() {
            const response = await fetch(`https://api-v2.fantasy.top/player/bids/${PLAYER_ADDRESS}`, {
                headers: {
                    'accept': 'application/json',
                    'x-api-key': 'cbc57228-5495-47b0-ae2f-b43ba6d5a9b6'
                }
            });
              const data = await response.json();
            
            // Deduplicate bids based on hero_id and rarity
            const uniqueHeroes = Array.from(new Map(
                data.map(item => [
                    `${item.hero_id}-${item.rarity}`,
                    item
                ])
            ).values());
            
            // Process each unique hero and fetch orderbook
            const processedData = {
                bids: await Promise.all(uniqueHeroes.map(async item => {
                    const orderbook = await fetchOrderbook(item.hero_id, item.rarity);
                    return {
                        bidder_handle: item.bidder_handle,
                        price: item.price,
                        expiration_time: item.expiration_time,
                        hero_id: item.hero_id,
                        rarity: item.rarity,
                        stars: item.hero.stars,
                        name: item.hero.name,
                        orderbook: orderbook
                    };
                }))
            };

            displayResults(processedData);
        }

        function getRarityName(rarityNumber) {
            switch(rarityNumber) {
                case 1: return 'legendary';
                case 2: return 'epic';
                case 3: return 'rare';
                case 4: return 'common';
                default: return 'unknown';
            }
        }

        function formatPrice(price) {
            return (parseInt(price) / 1000000000000000000).toFixed(4);
        }        function formatTimeUntilExpiration(expirationTime) {
            const expirationDate = new Date(parseInt(expirationTime) * 1000);
            const now = new Date();
            const diffMs = expirationDate - now;
            const diffHours = diffMs / (1000 * 60 * 60);
            const diffDays = diffHours / 24;

            if (diffMs <= 0) return { text: 'Expired', color: '#ff4444' };
            
            // Determine color based on thresholds
            let color;
            if (diffHours <= 6) {
                color = '#ff4444'; // Red for <= 6 hours
            } else if (diffHours < 24) {
                color = '#ffa500'; // Orange for < 24 hours
            } else if (diffDays >= 5) {
                color = '#44ff44'; // Green for > 5 days
            } else if (diffDays >= 3) {
                color = '#4444ff'; // Blue for >= 3 days
            } else {
                color = '#ffffff'; // Default white
            }
            
            // Format the expiration text
            let text;
            if (diffDays >= 1) {
                text = `${Math.floor(diffDays)}d ${Math.floor(diffHours % 24)}h`;
            } else if (diffHours >= 1) {
                text = `${Math.floor(diffHours)}h`;
            } else {
                const diffMinutes = Math.max(0, Math.floor(diffMs / (1000 * 60)));
                text = `${diffMinutes}m`;
            }

            return { text, color };
        }function displayResults(data) {            const grid = data.bids.map(item => {
                const topFiveBids = item.orderbook.highest_five_bids || [];                const bidRows = topFiveBids.map(bid => {
                    console.log('Comparing addresses:', {
                        trader: bid.trader,
                        player: PLAYER_ADDRESS,
                        traderLower: bid.trader?.toLowerCase(),
                        playerLower: PLAYER_ADDRESS.toLowerCase()
                    });
                    const isPlayerBid = bid.trader && bid.trader.toLowerCase() === PLAYER_ADDRESS.toLowerCase();
                    console.log('Is match?', isPlayerBid);                    const cellStyle = isPlayerBid ? 'style="color: #4ADE80 !important;"' : '';
                    const expiration = formatTimeUntilExpiration(bid.expiration_time);
                    return `
                    <tr>
                        <td ${cellStyle}>${bid.bidder_handle || 'Anonymous'}</td>
                        <td ${cellStyle} class="price-col">${formatPrice(bid.price)} ETH</td>
                        <td style="color: ${expiration.color} !important;">${expiration.text}</td>
                    </tr>
                    `;
                }).join('');

                return `
                <div class="hero-card">
                    <img 
                        class="card-image" 
                        src="https://r2.fantasy.top/v2/${getRarityName(item.rarity)}/${item.hero_id}_${item.stars}.png" 
                        alt="Hero Card"
                        onerror="this.src='../icons/ft_logo.webp'"
                    >
                    <h3>${item.name}</h3>
                    <div class="hero-info">ID: ${item.hero_id}</div>
                    <div class="hero-info">Rarity: ${item.rarity}</div>
                    <div class="hero-price">${formatPrice(item.price)} ETH</div>
                    
                    <table class="bids-table">
                        <thead>
                            <tr>
                                <th>Bidder</th>
                                <th>Price</th>
                                <th>Expires In</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bidRows}
                        </tbody>
                    </table>
                </div>
                `;
            }).join('');

            document.getElementById('results').innerHTML = grid;
        }

        // Fetch data when page loads
        fetchBids();
    </script>
</body>
</html>