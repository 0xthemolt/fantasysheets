<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LXJ5Q7LKKE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-LXJ5Q7LKKE');
    </script>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../styles.css?v=8e4c2f">
    <link rel="icon" type="image/png" href="../icons/favicon.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Cards</title>
    <!-- Add Supabase JS library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .grid-container {
            margin: 20px;
        }
        .matrix-header {
            display: grid;
            grid-template-columns: 100px repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .matrix-row {
            display: grid;
            grid-template-columns: 100px repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            align-items: start;
        }
        .star-label {
            display: flex;
            align-items: center;
        }
        .star-circle {
            display: inline-block;
            width: 31px;
            height: 31px;
            border-radius: 50%;
            text-align: center;
            line-height: 31px;
            color: black;
            font-weight: bold;
            font-size: 14px;
        }
        .card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            border-radius: 8px;
            min-height: 50px;
            background-color: #292828;
            border: none;
        }
        .card-image {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: none;
        }
        .card-wrapper {
            position: relative;
            display: inline-block;
            text-align: center;
        }
        .card-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff4444;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1;
        }
        .score-diff {
            font-size: 8px;
            color: white;
            margin-top: 4px;
            white-space: normal;
            line-height: 1.2;
        }
        .score-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 5px;
        }
        .score-item {
            margin-top: 2px;
            padding: 3px;
            background: #222222;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-size: 75%;
            width: 75%;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .score-item::after {
            content: none;
        }
        .score-label {
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .score-value {
            font-size: 12px;
            font-weight: bold;
        }
        .star-transition {
            font-size: 10px;
            margin-top: 2px;
            padding: 2px 4px;
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.1);
            display: inline-block;
            color: white;
        }
        .arrow {
            font-size: 12px;
            font-weight: bold;
            margin: 0 2px;
            color: white;
        }
        .export-button {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        .export-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="title-container"></div>
        <h1 class="title-header">
            <a href="index.html" class="home-link">
                <i class="fas fa-home"></i>
            </a>
            Player Cards
        </h1>
    </div>
    <div id="searchControls" style="margin: 20px 0; display: flex; align-items: center; flex-wrap: nowrap;">
        <input 
            type="text" 
            id="ownerSearch" 
            placeholder="Enter owner address"
            style="padding: 8px; flex: 1; max-width: 400px; margin-right: 10px;"
            value="0x162F95a9364c891028d255467F616902A479681a"
        >
        <button onclick="fetchCardData()" style="padding: 8px 16px; white-space: nowrap;">Search</button>
        <span id="totalCards" style="margin-left: 15px; color: #666; white-space: nowrap;"></span>
        <button id="exportButton" onclick="exportCardData()" class="export-button" style="margin-left: 20px; white-space: nowrap;">
            <i class="fas fa-file-export" style="margin-right: 5px;"></i> Export CSV
        </button>
    </div>


    <div id="loading">Loading...</div>
    <div id="cardsByStars" style="display: none;">
        <style>
            .grid-container {
                margin: 20px;
            }
            .matrix-header {
                display: grid;
                grid-template-columns: 100px repeat(4, 1fr);
                gap: 10px;
                margin-bottom: 10px;
                font-weight: bold;
            }
            .matrix-row {
                display: grid;
                grid-template-columns: 100px repeat(4, 1fr);
                gap: 10px;
                margin-bottom: 20px;
                align-items: start;
            }
            .star-label {
                display: flex;
                align-items: center;
            }
            .star-circle {
                display: inline-block;
                width: 31px;
                height: 31px;
                border-radius: 50%;
                text-align: center;
                line-height: 31px;
                color: black;
                font-weight: bold;
                font-size: 14px;
            }
            .card-container {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                padding: 10px;
                border-radius: 8px;
                min-height: 50px;
                background-color: #292828;
                border: none;
            }
            .card-image {
                width: 80px;
                height: 120px;
                object-fit: cover;
                border-radius: 8px;
                border: none;
            }
            .card-wrapper {
                position: relative;
                display: inline-block;
                text-align: center;
            }
            .card-count {
                position: absolute;
                top: -5px;
                right: -5px;
                background-color: #ff4444;
                color: white;
                border-radius: 4px;
                padding: 2px 6px;
                font-size: 12px;
                font-weight: bold;
                z-index: 1;
            }
            .score-diff {
                font-size: 8px;
                color: white;
                margin-top: 4px;
                white-space: normal;
                line-height: 1.2;
            }
        </style>
    </div>

    <script>
        // Add these global variables at the top of the script
        let heroMetadata = [];
        let heroesData = [];
        let starRangesData = []; // Variable to store star ranges from Supabase
        let heroStats = []; // Generalized variable to store hero stats from Supabase

        // Add this function to fetch hero stats from Supabase
        async function fetchHeroStatsFromSupabase() {
            try {
                console.log('Fetching hero stats from Supabase...');
                const supabaseUrl = 'https://hhcuqhvmzwmehdsaamhn.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoY3VxaHZtendtZWhkc2FhbWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzIwMTIsImV4cCI6MjA1MDU0ODAxMn0.xJNGoFLnpnmQGLj8RY_4VLmefPmFzuOyiVHLvFtPkkE';
                const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                
                const { data, error } = await supabaseClient
                    .from('hero_stat_history_current')
                    .select('hero_id, hero_handle, fantasy_score, stat_type')
                    .eq('stat_type', 'gliding_24h');
                
                if (error) {
                    throw new Error(`Supabase error: ${error.message}`);
                }
                
                heroStats = data || [];
                console.log(`Loaded ${heroStats.length} hero stats from Supabase`);
                
                return heroStats;
            } catch (error) {
                console.error('Error fetching hero stats:', error);
                return [];
            }
        }

        // Add this function to fetch star ranges from Supabase
        async function fetchStarRangesFromSupabase() {
            try {
                console.log('Fetching star ranges from Supabase...');
                const supabaseUrl = 'https://hhcuqhvmzwmehdsaamhn.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoY3VxaHZtendtZWhkc2FhbWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzIwMTIsImV4cCI6MjA1MDU0ODAxMn0.xJNGoFLnpnmQGLj8RY_4VLmefPmFzuOyiVHLvFtPkkE';
                const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                
                const { data, error } = await supabaseClient
                    .from('star_ranges')
                    .select('*');
                
                if (error) {
                    throw new Error(`Supabase error: ${error.message}`);
                }
                
                starRangesData = data || [];
                console.log(`Loaded ${starRangesData.length} star ranges from Supabase`);
                
                return starRangesData;
            } catch (error) {
                console.error('Error fetching star ranges:', error);
                return [];
            }
        }

        // Add this function to load the JSON data
        async function loadHeroData() {
            try {
                console.log('Starting to load hero data...');
                const response = await fetch('/hero_stats.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Store the data globally
                heroMetadata = data.metadata || [];
                heroesData = data.heroes || [];
                
                console.log(`Loaded ${heroMetadata.length} metadata entries and ${heroesData.length} hero entries`);
                
                // After loading data, trigger the initial card fetch
                fetchCardData();
            } catch (error) {
                console.error('Error loading hero data:', error);
                document.getElementById('loading').textContent = 'Error loading hero data: ' + error.message;
            }
        }

        // Helper functions
        const extractHeroStars = (card) => {
            return card.stars || 0;
        };

        const getStarColor = (number) => {
            const colorMap = {
                1: '#808080', // Gray
                2: '#FFFDD0', // Cream
                3: '#FFFAA0', // Pastel Yellow
                4: '#FFFF8F', // Canary Yellow
                5: '#FAFA33', // Lemon Yellow
                6: '#FFEA00', // Golden Yellow
                7: '#FFD700', // Bright Yellow
                8: '#FFC000'  // Gold
            };
            return colorMap[number] || 'grey';
        };

        const getRarityLabel = (rarity) => {
            const rarityMap = {
                4: 'Common',
                3: 'Rare',
                
                2: 'Epic',
                1: 'Legendary'
            };
            return rarityMap[rarity] || 'Unknown';
        };

        // function fixImageUrl(card) {
        //     // Clone the card to avoid modifying the original data
        //     const fixedCard = { ...card };
        //     
        //     // Fix specific hero_id cases
        //     if (card.hero_id === '3063147623') {
        //         fixedCard.picture = card.picture.replace('djenn', 'jenndefer');
        //     }   
        //     if (card.hero_id === '1423031747432783872') {
        //         fixedCard.picture = card.picture.replace('zagabond', 'ZAGABOND');
        //     }
        //
        //     return fixedCard;
        // }

        function organizeCardsIntoMatrix(data) {
            // First, group cards by their unique properties and count occurrences
            const cardGroups = data.reduce((acc, card) => {
                // Fix image URL before grouping
                // const fixedCard = fixImageUrl(card); // Removed this line
                const key = `${card.rarity}-${card.picture}`; // Updated to use card directly
                
                if (!acc[key]) {
                    acc[key] = {
                        ...card, // Use card directly
                        count: 1
                    };
                } else {
                    acc[key].count++;
                }
                return acc;
            }, {});

            // Convert grouped cards back to array
            const uniqueCards = Object.values(cardGroups);

            // Find all unique star values
            const uniqueStars = [...new Set(uniqueCards.map(card => extractHeroStars(card)))].sort((a, b) => b - a);
            
            // Create matrix structure
            const matrix = uniqueStars.map(stars => {
                return {
                    stars,
                    rarities: {
                        Legendary: [],
                        Epic: [],
                        Rare: [],
                        Common: []
                    }
                };
            });

            // Populate the matrix with unique cards
            uniqueCards.forEach(card => {
                const stars = extractHeroStars(card);
                const rarity = getRarityLabel(card.rarity);
                console.log(`Card Rarity: ${card.rarity}, Mapped Rarity: ${rarity}`); // Debugging line
                const rowIndex = matrix.findIndex(row => row.stars === stars);
                if (rowIndex !== -1) {
                    matrix[rowIndex].rarities[rarity].push(card);
                }
            });

            return matrix;
        }

        function renderMatrix(matrix) {
            const container = document.createElement('div');
            container.className = 'grid-container';

            // Update styles for count badge and add total count styles
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                .card-count {
                    background-color: #F36FDD;  // Changed from #ff4444 to #F36FDD
                }
                .total-count {
                    position: absolute;
                    bottom: 5px;
                    right: 5px;
                    background-color: #f0f0f0;
                    color: #333;
                    border-radius: 4px;
                    padding: 2px 6px;
                    font-size: 12px;
                    font-weight: bold;
                }
                .card-container {
                    position: relative;  // Added to position the total count
                }
                .score-container {
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                }
                .score-item {
                    margin-top: 2px;
                    padding: 3px;
                    background: #222222;
                    border-radius: 4px;
                    text-align: center;
                    font-weight: bold;
                    color: #fff;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                    font-size: 75%;
                    width: 75%;
                    margin-left: auto;
                    margin-right: auto;
                    position: relative;
                    overflow: hidden;
                    border: 1px solid rgba(255, 255, 255, 0.05);
                }
                .score-item::after {
                    content: none;
                }
            `;
            document.head.appendChild(styleElement);

            // First, determine which rarities have cards
            const activeRarities = ['Legendary', 'Epic', 'Rare', 'Common'].filter(rarity => {
                return matrix.some(row => row.rarities[rarity].length > 0);
            });

            // Create header row with only active rarities
            const header = document.createElement('div');
            header.className = 'matrix-header';
            header.innerHTML = `
                <div>Stars</div>
                ${activeRarities.map(rarity => `
                    <div style="color: ${getRarityColor(rarity)}">
                        ${rarity}
                    </div>
                `).join('')}
            `;
            
            // Update grid template columns based on number of active rarities
            const gridColumns = `100px repeat(${activeRarities.length}, 1fr)`;
            header.style.gridTemplateColumns = gridColumns;
            container.appendChild(header);

            // Create matrix rows
            matrix.forEach(row => {
                const matrixRow = document.createElement('div');
                matrixRow.className = 'matrix-row';
                matrixRow.style.gridTemplateColumns = gridColumns;

                // Star label cell
                const starLabel = document.createElement('div');
                starLabel.className = 'star-label';
                starLabel.style.flexDirection = 'column';
                starLabel.style.alignItems = 'center';

                const starCircle = document.createElement('div');
                starCircle.className = 'star-circle';
                starCircle.style.backgroundColor = getStarColor(row.stars);
                starCircle.textContent = row.stars;

                const rangeInfo = document.createElement('div');
                rangeInfo.style.fontSize = '12px';
                rangeInfo.style.marginTop = '4px';
                rangeInfo.style.color = '#666';

                // Use Supabase star ranges data if available
                const starRange = starRangesData.find(range => range.stars === row.stars);
                if (starRange) {
                    const topRange = Math.floor(starRange.top_range);
                    const bottomRange = Math.floor(starRange.bottom_range);
                    rangeInfo.textContent = `Range: ${topRange} - ${bottomRange}`;
                } else {
                    // Fallback to local metadata if Supabase data isn't available
                    const starMetadata = heroMetadata.find(meta => meta.stars === row.stars);
                    if (starMetadata) {
                        const topRange = Math.floor(starMetadata.top_range);
                        const bottomRange = Math.floor(starMetadata.bottom_range);
                        rangeInfo.textContent = `Range: ${topRange} - ${bottomRange}`;
                    }
                }

                starLabel.appendChild(starCircle);
                starLabel.appendChild(rangeInfo);
                matrixRow.appendChild(starLabel);

                // Only render cells for active rarities
                activeRarities.forEach(rarity => {
                    const cell = document.createElement('div');
                    cell.className = 'card-container';
                    
                    // Calculate total cards in this rarity+star combination
                    const totalCards = row.rarities[rarity].reduce((sum, card) => sum + card.card_number, 0);
                    
                    row.rarities[rarity].forEach(card => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'card-wrapper';

                        const countBadge = document.createElement('div');
                        countBadge.className = 'card-count';
                        countBadge.textContent = card.card_number;
                        wrapper.appendChild(countBadge);

                        const img = document.createElement('img');
                        card.picture = `${card.picture}_${card.stars}.png`; // Update picture URL to include stars
                        img.src = card.picture;
                        img.className = 'card-image';
                        img.alt = `${rarity} ${row.stars}-star card`;
                        wrapper.appendChild(img);

                        // New container for scores
                        const scoreContainer = document.createElement('div');
                        scoreContainer.className = 'score-container'; // Add a class for styling
                        
                        // Add 7D score
                        const sevenDayScore = document.createElement('div');
                        sevenDayScore.className = 'score-item';
                        
                        // Get raw score value
                        let sevenDayScoreValue = Math.floor(card.card_weighted_score);
                        
                        // Apply rarity-based adjustments for star range comparison
                        let adjustedSevenDayScore = sevenDayScoreValue;
                        if (rarity === 'Legendary') {
                            adjustedSevenDayScore = sevenDayScoreValue / 2.5;
                        } else if (rarity === 'Epic') {
                            adjustedSevenDayScore = sevenDayScoreValue / 2;
                        } else if (rarity === 'Rare') {
                            adjustedSevenDayScore = sevenDayScoreValue / 1.5;
                        }
                        
                        // Create two-line format with label on top and score below
                        const sevenDayLabel = document.createElement('div');
                        sevenDayLabel.className = 'score-label';
                        sevenDayLabel.textContent = '7D';
                        
                        const sevenDayValue = document.createElement('div');
                        sevenDayValue.className = 'score-value';
                        sevenDayValue.textContent = sevenDayScoreValue;
                        
                        sevenDayScore.appendChild(sevenDayLabel);
                        sevenDayScore.appendChild(sevenDayValue);
                        
                        // Check if score is within star range and color accordingly
                        if (starRange) {
                            const topRange = Math.floor(starRange.top_range);
                            const bottomRange = Math.floor(starRange.bottom_range);
                            
                            if (adjustedSevenDayScore >= bottomRange && adjustedSevenDayScore <= topRange) {
                                // Score matches current star level - no special styling needed
                                scoreContainer.appendChild(sevenDayScore);
                            } else {
                                // Score is outside range - find which star range it falls into
                                const matchingRange = starRangesData.find(range => 
                                    adjustedSevenDayScore >= Math.floor(range.bottom_range) && 
                                    adjustedSevenDayScore <= Math.floor(range.top_range)
                                );
                                
                                if (matchingRange) {
                                    // Compare matching range stars with current card stars
                                    if (matchingRange.stars > row.stars) {
                                        // Calculate the star difference
                                        const starDiff = matchingRange.stars - row.stars;
                                        
                                        if (starDiff === 1) {
                                            // Subtle improvement (+1 star)
                                            sevenDayScore.style.backgroundColor = 'rgba(0, 191, 255, 0.33)'; // Light blue with 67% opacity
                                        } else {
                                            // Significant improvement (+2 or more stars)
                                            sevenDayScore.style.backgroundColor = 'rgba(0, 109, 44, 0.33)'; // Dark green with 67% opacity
                                        }
                                        
                                        // Add an arrow indicator showing upward potential
                                        const arrowIndicator = document.createElement('div');
                                        arrowIndicator.className = 'star-transition';
                                        arrowIndicator.innerHTML = `${row.stars} <span class="arrow">→</span> ${matchingRange.stars}`;
                                        arrowIndicator.style.color = 'white';
                                        arrowIndicator.style.fontWeight = 'bold';
                                        arrowIndicator.style.backgroundColor = sevenDayScore.style.backgroundColor;
                                        
                                        sevenDayScore.appendChild(arrowIndicator);
                                    } else if (matchingRange.stars < row.stars) {
                                        // Calculate the star difference
                                        const starDiff = row.stars - matchingRange.stars;
                                        
                                        if (starDiff === 1) {
                                            // Subtle decline (-1 star)
                                            sevenDayScore.style.backgroundColor = 'rgba(255, 152, 0, 0.33)'; // Orange with 67% opacity
                                        } else {
                                            // Significant decline (-2 or more stars)
                                            sevenDayScore.style.backgroundColor = 'rgba(165, 15, 21, 0.33)'; // Dark red with 67% opacity
                                        }
                                        
                                        // Add an arrow indicator showing downward performance
                                        const arrowIndicator = document.createElement('div');
                                        arrowIndicator.className = 'star-transition';
                                        arrowIndicator.innerHTML = `${row.stars} <span class="arrow">→</span> ${matchingRange.stars}`;
                                        arrowIndicator.style.color = 'white';
                                        arrowIndicator.style.fontWeight = 'bold';
                                        arrowIndicator.style.backgroundColor = sevenDayScore.style.backgroundColor;
                                        
                                        sevenDayScore.appendChild(arrowIndicator);
                                    }
                                }
                                scoreContainer.appendChild(sevenDayScore);
                            }
                        } else {
                            scoreContainer.appendChild(sevenDayScore);
                        }
                        
                        // Only add to container if we didn't add it in the conditional logic above
                        if (!sevenDayScore.parentNode) {
                            scoreContainer.appendChild(sevenDayScore);
                        }
                        
                        // Add 24H score if available
                        const score24h = getHeroStat(card.hero_id, 'gliding_24h');
                        if (score24h !== null) {
                            const dayScore = document.createElement('div');
                            dayScore.className = 'score-item';
                            
                            // Get raw score value
                            const dayScoreValue = Math.floor(score24h);
                            
                            // Create two-line format with label on top and score below
                            const dayLabel = document.createElement('div');
                            dayLabel.className = 'score-label';
                            dayLabel.textContent = '24H';
                            
                            const dayValue = document.createElement('div');
                            dayValue.className = 'score-value';
                            dayValue.textContent = dayScoreValue;
                            
                            // Make text red if score is 200 or below, green if 800 or above
                            if (dayScoreValue <= 200) {
                                dayValue.style.color = 'red';
                            } else if (dayScoreValue >= 800) {
                                dayValue.style.color = 'green';
                            }
                            
                            dayScore.appendChild(dayLabel);
                            dayScore.appendChild(dayValue);
                            
                            scoreContainer.appendChild(dayScore);
                        }
                        
                        wrapper.appendChild(scoreContainer);

                        cell.appendChild(wrapper);
                    });

                    // Add total count if there are any cards
                    if (totalCards > 0) {
                        const totalCountBadge = document.createElement('div');
                        totalCountBadge.className = 'total-count';
                        totalCountBadge.textContent = `Total: ${totalCards}`;
                        cell.appendChild(totalCountBadge);
                    }

                    matrixRow.appendChild(cell);
                });

                container.appendChild(matrixRow);
            });

            return container;
        }

        async function fetchAllCardData(ownerAddress) {
            const BATCH_SIZE = 50;
            let allCards = [];
            let currentPage = 0;
            
            // Get first batch and total count
            const firstResponse = await fetch(
                `https://api-v2.fantasy.top/card/player/${ownerAddress}?pagination[page]=${currentPage}&pagination[limit]=${BATCH_SIZE}&orderBy=cards_score&groupCard=true`,
                {
                    method: "GET",
                    headers: {
                        "accept": "application/json",
                        "x-api-key": "cbc57228-5495-47b0-ae2f-b43ba6d5a9b6",
                        "Access-Control-Allow-Origin": "*",
                        "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
                        "Access-Control-Allow-Headers": "Origin, X-Requested-With, Content-Type, Accept, X-Api-Key"
                    }
                }
            );
            const firstData = await firstResponse.json();
            
            // Add first batch to results
            if (firstData.data) {
                allCards = [...firstData.data];
                console.log(`Added ${firstData.data.length} cards from page 1`);
            }
            
            // Fetch remaining batches using lastPage from metadata
            const lastPage = firstData.meta?.lastPage || 1;
            while (currentPage < lastPage) {
                currentPage++;
                const response = await fetch(
                    `https://api-v2.fantasy.top/card/player/${ownerAddress}?pagination[page]=${currentPage}&pagination[limit]=${BATCH_SIZE}&orderBy=cards_score&groupCard=true`,
                    {
                        method: "GET",
                        headers: {
                            "accept": "application/json",
                            "x-api-key": "cbc57228-5495-47b0-ae2f-b43ba6d5a9b6",
                            "Access-Control-Allow-Origin": "*",
                            "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
                            "Access-Control-Allow-Headers": "Origin, X-Requested-With, Content-Type, Accept, X-Api-Key"
                        }
                    }
                );
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    allCards = [...allCards, ...data.data];
                    console.log(`Added ${data.data.length} cards from page ${currentPage}`);
                }
            }

            // Display total cards count after fetching all pages
            const totalCards = allCards.reduce((sum, card) => sum + card.card_number, 0); // Updated to sum card_number values from allCards
            document.getElementById('totalCards').textContent = `(Total Cards: ${totalCards})`;
            
            console.log(`Total cards accumulated: ${allCards.length}`);
            return allCards;
        }

        function organizeCardsByScore(data) {
            if (!data) return [];
            
            // Group cards by unique hero (picture) and apply fixImageUrl first
            const uniqueCards = Object.values(data.reduce((acc, card) => {
                // const fixedCard = fixImageUrl(card); // Removed this line
                const key = card.picture;
                if (!acc[key]) {
                    acc[key] = {
                        ...card, // Use card directly
                        score: Math.floor(Math.random() * 1001), // Random score 0-1000
                        count: 1
                    };
                } else {
                    acc[key].count++;
                }
                return acc;
            }, {}));

            // Sort by score
            uniqueCards.sort((a, b) => b.score - a.score);

            // Group into ranges of 200
            const ranges = [];
            for (let i = 1000; i >= 0; i -= 200) {
                const rangeCards = {
                    range: `${i}-${Math.max(0, i-199)}`,
                    rarities: {
                        Legendary: [],
                        Epic: [],
                        Rare: [],
                        Common: []
                    }
                };
                
                uniqueCards
                    .filter(card => card.score <= i && card.score > Math.max(0, i-200))
                    .forEach(card => {
                        const rarity = getRarityLabel(card.rarity);
                        rangeCards.rarities[rarity].push(card);
                    });
                
                if (Object.values(rangeCards.rarities).some(arr => arr.length > 0)) {
                    ranges.push(rangeCards);
                }
            }

            return ranges;
        }

        function renderScoreMatrix(matrix) {
            // Similar to renderMatrix but with score ranges instead of stars
            const container = document.createElement('div');
            container.className = 'grid-container';

            // Determine active rarities
            const activeRarities = ['Legendary', 'Epic', 'Rare', 'Common'].filter(rarity => {
                return matrix.some(row => row.rarities[rarity].length > 0);
            });

            // Create header
            const header = document.createElement('div');
            header.className = 'matrix-header';
            header.innerHTML = `
                <div>Score Range</div>
                ${activeRarities.map(rarity => `<div>${rarity}</div>`).join('')}
            `;

            const gridColumns = `100px repeat(${activeRarities.length}, 1fr)`;
            header.style.gridTemplateColumns = gridColumns;
            container.appendChild(header);

            // Create rows
            matrix.forEach(row => {
                const matrixRow = document.createElement('div');
                matrixRow.className = 'matrix-row';
                matrixRow.style.gridTemplateColumns = gridColumns;

                // Score range label
                const rangeLabel = document.createElement('div');
                rangeLabel.className = 'star-label';
                rangeLabel.textContent = row.range;
                matrixRow.appendChild(rangeLabel);

                // Add cells for each rarity
                activeRarities.forEach(rarity => {
                    const cell = document.createElement('div');
                    cell.className = 'card-container';
                    
                    row.rarities[rarity].forEach(card => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'card-wrapper';

                        const countBadge = document.createElement('div');
                        countBadge.className = 'card-count';
                        countBadge.textContent = card.card_number;
                        wrapper.appendChild(countBadge);

                        const img = document.createElement('img');
                        console.log('Image URL:', card.picture); // Debug print the full URL
                        img.src = card.picture;
                        img.className = 'card-image';
                        img.alt = `${rarity} ${row.stars}-star card`;
                        wrapper.appendChild(img);

                        // New container for card_weighted_score
                        const scoreContainer = document.createElement('div');
                        scoreContainer.className = 'score-container'; // Add a class for styling
                        scoreContainer.textContent = `7D: ${Math.floor(card.card_weighted_score)}`; // Add "7D:" label before the score
                        wrapper.appendChild(scoreContainer); // Append the score container to the wrapper

                        cell.appendChild(wrapper);
                    });

                    matrixRow.appendChild(cell);
                });

                container.appendChild(matrixRow);
            });

            return container;
        }

        // Update fetchCardData to include error handling
        async function fetchCardData() {
            try {
                const ownerAddress = document.getElementById('ownerSearch').value.trim();
                const loadingDiv = document.getElementById('loading');
                const starView = document.getElementById('cardsByStars');
                
                if (!heroMetadata || !heroesData) {
                    throw new Error('Hero data not loaded yet');
                }
                
                loadingDiv.style.display = 'block';
                starView.style.display = 'none';
                
                // Remove the old headers setup and just call fetchAllCardData directly
                const allCards = await fetchAllCardData(ownerAddress);
                console.log(`Fetched ${allCards.length} cards`);
                
                window.currentCardData = allCards;
                loadingDiv.style.display = 'none';
                
                if (allCards.length > 0) {
                    starView.style.display = 'block';
                    const matrix = organizeCardsIntoMatrix(allCards);
                    const matrixElement = renderMatrix(matrix);
                    starView.innerHTML = '';
                    starView.appendChild(matrixElement);
                    // }
                } else {
                    loadingDiv.textContent = 'No cards found for this address';
                    loadingDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error in fetchCardData:', error);
                document.getElementById('loading').textContent = 'Error loading data: ' + error.message;
            }
        }

        // Add event listener for Enter key
        document.getElementById('ownerSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchCardData();
            }
        });

        // Update the initial load section
        document.addEventListener('DOMContentLoaded', function() {
            // Load all data sources
            Promise.all([
                loadHeroData(),
                fetchStarRangesFromSupabase(),
                fetchHeroStatsFromSupabase()
            ])
            .then(() => {
                console.log('All data loaded successfully');
                fetchCardData();
            })
            .catch(error => {
                console.error('Error loading initial data:', error);
                document.getElementById('loading').textContent = 'Error loading initial data: ' + error.message;
            });
        });

        const getRarityColor = (rarity) => {
            const colorMap = {
                'Common': '#48EE4B',
                'Rare': '#02E0F4',
                'Epic': '#CD2FD7',
                'Legendary': '#7F76F5'
            };
            return colorMap[rarity] || '#666666';
        };

        // Add these helper functions where convenient
        function getHeroMetadata(heroId) {
            return heroMetadata.find(meta => meta.hero_id === heroId);
        }

        function getHeroStats(heroId) {
            return heroesData.find(hero => hero.hero_id === heroId);
        }

        // Add these helper functions at the top of your script section
        function findScoreRanges(stars) {
            // Fixed ranges for both metrics
            return {
                sevenDayRange: { min: 0, max: 1000 },
                l3mtRange: { min: 0, max: 1000 }
            };
        }

        // Generalized helper function to get hero stats by hero_id and stat_type
        function getHeroStat(heroId, statType) {
            const statData = heroStats.find(item => item.hero_id === heroId && item.stat_type === statType);
            return statData ? statData.fantasy_score : null;
        }

        // Add this new function to export card data
        function exportCardData() {
            if (!window.currentCardData || window.currentCardData.length === 0) {
                alert('No card data available to export. Please search for cards first.');
                return;
            }
            
            // Create CSV header
            let csvContent = "hero_id,handle,rarity,card_number,stars,score,score_24h\n";
            
            // Process each card and add to CSV
            window.currentCardData.forEach(card => {
                // Get 24h score from Supabase data if available
                const score24h = getHeroStat(card.hero_id, 'gliding_24h') || '';
                
                // Map rarity number to text
                const rarityText = getRarityLabel(card.rarity);
                
                // Format hero_id as text by adding ="value" to prevent Excel from converting to scientific notation
                const formattedHeroId = `="${card.hero_id}"`;
                
                // Create CSV row
                const row = [
                    formattedHeroId,
                    card.handle || '',
                    rarityText,
                    card.card_number,
                    card.stars,
                    Math.floor(card.card_weighted_score),
                    score24h ? Math.floor(score24h) : ''
                ].join(',');
                
                csvContent += row + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            
            // Generate filename with current date
            const date = new Date();
            const dateStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            const address = document.getElementById('ownerSearch').value.trim().substring(0, 8); // First 8 chars of address
            
            link.setAttribute("download", `scout_cards_${address}_${dateStr}.csv`);
            document.body.appendChild(link);
            
            // Trigger download and clean up
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>