<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Listings</title>
    <link rel="stylesheet" href="../styles.css?v=8e4c2f">
    <link rel="icon" type="image/png" href="../icons/favicon.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .card-image {
            width: 30px;  /* This makes the image 80% smaller than original */
            height: auto; /* Maintains aspect ratio */
            vertical-align: middle;
        }
        .hero-cell {
            text-align: left;
            min-width: 150px;
        }
        table td {
            padding: 8px;
        }
        .profile-pic {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            vertical-align: middle;
            margin-right: 4px;
        }
        .seller-info {
            display: block;
            font-size: 0.8em;
            color: #777;
            margin-top: 2px;
            text-align: left;
        }
        .section-divider {
            border-left: 1px solid #ddd;
            padding-left: 12px;
        }
        .floor-container {
            display: flex;
            justify-content: flex-start;  /* Changed from space-between to flex-start */
            align-items: center;
            width: 100%;
            gap: 12px;  /* Added fixed gap instead of space-between */
        }
        
        .profile-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .floor-value {
            text-align: left;
            white-space: nowrap;
            flex-shrink: 0;  /* Prevents floor value from shrinking */
        }
        
        .price-diff {
            font-size: 0.8em;
            color: #777;
            margin-top: 2px;
        }
        
        .last-sale-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .last-sale-value {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .last-sale-time {
            font-size: 0.8em;
            color: #777;
        }

        .section-header {
            background-color: #2a2a2a;
            color: #aaa;
            padding: 8px;
            font-weight: bold;
            border-top: 1px solid #404040;
            border-bottom: 1px solid #404040;
        }
        .price-range {
            position: relative;
            height: 4px;
            background: #2a2a2a;
            border-radius: 2px;
            margin: 12px 0;
            width: 200px;
        }

        .price-range-fill {
            position: absolute;
            height: 100%;
            background: #333;
            border-radius: 2px;
        }

        .price-marker {
            position: absolute;
            width: 3px;
            height: 12px;
            transform: translateX(-50%);
            top: -4px;
        }

        .price-marker.floor {
            background: #48DA7E;
        }

        .price-marker.bid {
            background: #4A9EFF;
        }

        .price-marker.last {
            background: #7B61FF;  /* Sapphire color */
        }

        .range-values {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #777;
            margin-top: 4px;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            color: #aaa;
            font-size: 0.9em;
            justify-content: flex-end;  /* Right align the legend items */
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-marker {
            width: 3px;
            height: 12px;
            display: inline-block;
        }
        
        .legend-marker.floor { background: #48DA7E; }
        .legend-marker.bid { background: #4A9EFF; }
        .legend-marker.last { background: #7B61FF; }

        .score-cell {
            text-align: left;  /* Changed from center to left */
            white-space: nowrap;
            padding: 8px;
        }

        .score-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-start;  /* Changed from center to flex-start */
        }

        .score-value {
            display: block;
            font-size: 0.9em;
        }

        .rank-container {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 8px;
        }

        .rank-1 {
            background-color: #FFD700;  /* Gold */
            color: #000;
        }

        .rank-2 {
            background-color: #C0C0C0;  /* Silver */
            color: #000;
        }

        .rank-3 {
            background-color: #CD7F32;  /* Bronze */
            color: #fff;
        }

        .rank-other {
            background-color: #2d2d2d;
            color: #fff;
        }

        .rank-placeholder {
            visibility: hidden;
            width: 30px;  /* Adjust this value to match your rank container width */
            display: inline-block;
        }

        .listing-cell {
            text-align: right;  /* Changed from left to right */
            white-space: nowrap;
        }

        .listing-price {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .price-diff {
            display: block;
            text-align: right;  /* Ensure price diff is also right-aligned */
            font-size: 0.8em;
            color: #777;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <h1>Player Listings</h1>
    <div id="tableContainer"></div>

    <script>

        // Add Supabase client initialization at the top of your file
        const supabaseUrl = 'https://hhcuqhvmzwmehdsaamhn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoY3VxaHZtendtZWhkc2FhbWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzIwMTIsImV4cCI6MjA1MDU0ODAxMn0.xJNGoFLnpnmQGLj8RY_4VLmefPmFzuOyiVHLvFtPkkE';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Add this function near the top of your script section
        async function fetchSupabaseListingData() {
            try {
                const { data, error } = await supabaseClient
                    .from('listing_view')
                    .select(`
                        hero_id,
                        hero_handle,
                        rarity,
                        hero_rarity_index,
                        last_sale,
                        last_sale_time,
                        lowest_sale,
                        highest_sale,
                        score_24hr,
                        score_7d,
                        score_main,
                        trade_timeline,
                        bid_pct,
                        market_pct
                    `);

                if (error) {
                    console.error('Error fetching listing data:', error);
                    return null;
                }

                // Store the data in localStorage for later use
                localStorage.setItem('listingData', JSON.stringify(data));

                return data;
            } catch (error) {
                console.error('Error in fetchSupabaseListingData:', error);
                return null;
            }
        }

        // Add this function after the other fetch functions
        async function fetchPlayerData(addresses) {
            try {
                const { data, error } = await supabaseClient
                    .from('players')
                    .select('player_address,player_pfp_url,player_name')
                    .in('player_address', addresses);

                if (error) {
                    console.error('Error fetching player data:', error);
                    return null;
                }

                // Create a map for easy lookup
                const playerMap = new Map(
                    data.map(player => [player.player_address.toLowerCase(), player])
                );

                return playerMap;
            } catch (error) {
                console.error('Error in fetchPlayerData:', error);
                return null;
            }
        }

        async function fetchListingRank(hero_rarity_index) {
            try {
                const response = await fetch(`https://api-v2.fantasy.top/marketplace/sell-orders/${hero_rarity_index}?type=short`, {
                    headers: {
                        'accept': 'application/json',
                        'x-api-key': 'cbc57228-5495-47b0-ae2f-b43ba6d5a9b6'
                    }
                });
                const data = await response.json();
                
                // Sort orders by price and calculate dense rank
                if (data.orders && data.orders.length > 0) {
                    let currentRank = 1;
                    let currentPrice = data.orders[0].price;
                    let previousPrice = null;
                    
                    // Add rank property to each order
                    data.orders = data.orders.map((order, index) => {
                        if (previousPrice !== null && order.price !== previousPrice) {
                            currentRank = index + 1; // Skip ranks for ties
                        }
                        previousPrice = order.price;
                        return { ...order, dense_rank: currentRank };
                    });
                }
                
                return data.orders;
            } catch (error) {
                console.error('Error fetching listing rank:', error);
                return null;
            }
        }

        async function fetchListings() {
            try {
                // Fetch initial data
                const [apiResponse, supabaseData] = await Promise.all([
                    fetch('https://api-v2.fantasy.top/player/listings/0x162F95a9364c891028d255467F616902A479681a', {
                        headers: {
                            'accept': 'application/json',
                            'x-api-key': 'cbc57228-5495-47b0-ae2f-b43ba6d5a9b6'
                        }
                    }).then(res => res.json()),
                    fetchSupabaseListingData()
                ]);

                // Create map for Supabase data
                const supabaseMap = new Map(
                    supabaseData.map(item => [item.hero_rarity_index.toString(), item])
                );

                // Fetch rank data for each listing
                const rankPromises = apiResponse.map(listing => 
                    fetchListingRank(listing.hero_rarity_index)
                );
                const rankResults = await Promise.all(rankPromises);

                // Get unique top traders from rank results
                const topTraders = new Set(
                    rankResults
                        .flatMap(orders => {
                            console.log('Processing orders:', orders);
                            // Get the first order from each array (lowest price)
                            const firstOrder = orders?.[0];
                            console.log('First order:', firstOrder);
                            return firstOrder?.trader || [];
                        })
                        .filter(trader => trader)
                        .map(trader => trader.toLowerCase())
                );
                
                console.log('Top traders addresses:', Array.from(topTraders));

                // Fetch player data for top traders
                const playerData = await fetchPlayerData(Array.from(topTraders));
                console.log('Player data from Supabase:', Object.fromEntries(playerData || new Map()));

                // Log enriched listings for debugging
                const enrichedListings = apiResponse.map((listing, index) => {
                    const supabaseInfo = supabaseMap.get(listing.hero_rarity_index.toString());
                    const rankOrders = rankResults[index];
                    
                    // Find the order with matching token_id and get its dense_rank
                    const matchingOrder = rankOrders?.find(order => order.token_id === listing.token_id);
                    const rank = matchingOrder?.dense_rank || null;

                    // Get top trader info if available (get first order directly)
                    const topOrder = rankOrders?.[0];  // Changed this line
                    const topTraderAddress = topOrder?.trader?.toLowerCase();
                    const topTraderInfo = topTraderAddress ? playerData?.get(topTraderAddress) : null;
                    
                    console.log('Top trader info for listing:', {
                        address: topTraderAddress,
                        info: topTraderInfo,
                        orderDetails: topOrder // Add this to see full order details
                    });

                    return {
                        ...listing,
                        supabaseInfo: supabaseInfo || {},
                        rank: rank,
                        topTrader: topTraderInfo ? {
                            name: topTraderInfo.player_name,
                            pfpUrl: topTraderInfo.player_pfp_url
                        } : null
                    };
                });

                displayListings(enrichedListings);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function format_eth_tight(value) {
            if (value === null || value === undefined || isNaN(value)) return '-'; // Handle invalid values

            const num = parseFloat(value);
            if (num > 10) {
                return num.toFixed(0); // Format as ## for values greater than 10
            } else if (num > 1) {
                return num.toFixed(2); // Format as #.# for values greater than 1
            } else {
                return num.toFixed(3); // Format as #.## for values less than or equal to 1
            }
        }
        
        
        function format_eth(value) {
            if (value === null || value === undefined || isNaN(value)) return '-'; // Handle invalid values

            const num = parseFloat(value);
            if (num > 10) {
                return num.toFixed(2); // Format as ## for values greater than 10
            } else if (num > 1) {
                return num.toFixed(3); // Format as #.# for values greater than 1
            } else {
                return num.toFixed(5); // Format as #.## for values less than or equal to 1
            }
        }
        
        function getRarityName(rarityNumber) {
            switch(rarityNumber) {
                case 1: return 'legendary';
                case 2: return 'epic';
                case 3: return 'rare';
                case 4: return 'common';
                default: return 'unknown';
            }
        }

        function formatTimeUntilExpiration(expirationTime) {
            const now = Math.floor(Date.now() / 1000);
            const expTime = parseInt(expirationTime);
            const diffMinutes = Math.floor((expTime - now) / 60);
            
            if (diffMinutes <= 0) {
                return 'Expired';
            }
            
            if (diffMinutes <= 120) {  // 2 hours
                return `${diffMinutes}m`;
            } else if (diffMinutes <= 2880) {  // 48 hours
                const hours = Math.floor(diffMinutes / 60);
                return `${hours}h`;
            } else {
                const days = Math.floor(diffMinutes / 1440);
                return `${days}d`;
            }
        }

        function formatLastSaleTime(lastSaleTime) {
            if (!lastSaleTime) return '';
            
            const now = new Date();
            const saleTime = new Date(lastSaleTime);
            const diffMinutes = Math.floor((now - saleTime) / (1000 * 60));
            
            if (diffMinutes <= 120) {  // 2 hours
                return `${diffMinutes}m ago`;
            } else if (diffMinutes <= 2880) {  // 48 hours
                const hours = Math.floor(diffMinutes / 60);
                return `${hours}h ago`;
            } else {
                const days = Math.floor(diffMinutes / 1440);
                return `${days}d ago`;
            }
        }

        function calculatePosition(value, min, max) {
            if (!value || !min || !max) return 0;
            const position = ((parseFloat(value) - parseFloat(min)) / (parseFloat(max) - parseFloat(min))) * 100;
            return Math.min(Math.max(position, 0), 100); // Clamp between 0 and 100
        }

        function formatPricePercentage(percentage) {
            if (percentage >= 100) {
                return `${Math.round(percentage)}%`;  // ###%
            } else if (percentage >= 10) {
                return `${Math.round(percentage)}%`;  // ##%
            } else {
                return `${percentage.toFixed(2)}%`;   // #.##%
            }
        }

        function getPriceDiffColor(percentage) {
            if (percentage > 50) {
                return '#FF5733'; // Red for high difference
            } else if (percentage > 20) {
                return '#FFC300'; // Yellow for moderate difference
            } else {
                return '#48DA7E'; // Green for low difference
            }
        }

        // Add this function to your script section
        function getScoreColor(score) {
            // Handle invalid scores
            if (!score || score < 0) return '#777777';
            
            // Normalize score to 0-1 range
            const normalizedScore = Math.min(Math.max(score / 1000, 0), 1);
            
            // Define color stops for RYG (Red -> Yellow -> Green) gradient
            const colors = [
                { point: 0, color: [255, 50, 50] },    // Red
                { point: 0.5, color: [255, 255, 50] }, // Yellow
                { point: 1, color: [50, 255, 50] }     // Green
            ];
            
            // Find the two colors to interpolate between
            let lower = colors[0];
            let upper = colors[colors.length - 1];
            
            for (let i = 0; i < colors.length - 1; i++) {
                if (normalizedScore >= colors[i].point && normalizedScore <= colors[i + 1].point) {
                    lower = colors[i];
                    upper = colors[i + 1];
                    break;
                }
            }
            
            // Calculate interpolation factor
            const range = upper.point - lower.point;
            const factor = range === 0 ? 0 : (normalizedScore - lower.point) / range;
            
            // Interpolate RGB values
            const r = Math.round(lower.color[0] * (1 - factor) + upper.color[0] * factor);
            const g = Math.round(lower.color[1] * (1 - factor) + upper.color[1] * factor);
            const b = Math.round(lower.color[2] * (1 - factor) + upper.color[2] * factor);
            
            return `rgb(${r}, ${g}, ${b})`;
        }

        function calculateTotalPrice(listings) {
            return listings.reduce((sum, listing) => sum + parseFloat(listing.price_numeric), 0);
        }

        // Add this function to create the line chart
        function createPriceChart(tradeData) {
            if (!tradeData) return '';
            
            const width = 200;
            const height = 40;
            const padding = 4;
            const dotRadius = 2; // Size of the dots
            
            // Handle both string and object inputs
            const sortedData = (typeof tradeData === 'string' ? JSON.parse(tradeData) : tradeData)
                .sort((a, b) => new Date(a.date_hour) - new Date(b.date_hour));
            
            if (!sortedData.length) return '';
            
            // Get min/max values for scaling
            const timeRange = {
                min: new Date(sortedData[0].date_hour),
                max: new Date(sortedData[sortedData.length - 1].date_hour)
            };
            
            const priceRange = {
                min: Math.min(...sortedData.map(d => d.min_price)),
                max: Math.max(...sortedData.map(d => d.max_price))
            };
            
            // Scale functions
            const scaleX = (date) => {
                const percent = (new Date(date) - timeRange.min) / (timeRange.max - timeRange.min);
                return padding + percent * (width - 2 * padding);
            };
            
            const scaleY = (price) => {
                const percent = (price - priceRange.min) / (priceRange.max - priceRange.min);
                return height - padding - percent * (height - 2 * padding);
            };
            
            // Create dots for each method
            const marketData = sortedData.filter(d => d.method === 'market');
            const bidData = sortedData.filter(d => d.method === 'bid');
            
            const createDots = (data, color) => {
                if (!data.length) return '';
                return data.map(d => 
                    `<circle 
                        cx="${scaleX(d.date_hour)}" 
                        cy="${scaleY(d.max_price)}" 
                        r="${dotRadius}" 
                        fill="${color}"
                    />`
                ).join('');
            };
            
            return `
                <svg width="${width}" height="${height}" style="background: #2a2a2a; border-radius: 2px;">
                    ${createDots(marketData, '#7B61FF')}
                    ${createDots(bidData, '#48DA7E')}
                </svg>
            `;
        }

        // Add this function to create the donut chart
        function createDonutChart(bid_pct, market_pct) {
            // Convert decimal values to percentages and ensure they're numbers
            bid_pct = Math.round((Number(bid_pct) || 0) * 100);
            market_pct = Math.round((Number(market_pct) || 0) * 100);
            
            // Check if we have any data to show
            if (bid_pct === 0 && market_pct === 0) return '';
            
            const size = 40;
            const strokeWidth = 4;
            const radius = (size - strokeWidth) / 2;
            const center = size / 2;
            
            // Calculate angles (based on percentages that now range from 0-100)
            const total = bid_pct + market_pct;
            if (total === 0) return '';
            
            const bidAngle = (bid_pct / total) * 360;
            const marketAngle = (market_pct / total) * 360;
            
            const circumference = 2 * Math.PI * radius;
            const bidDash = (bidAngle / 360) * circumference;
            const marketDash = (marketAngle / 360) * circumference;

            // Determine highest percentage and its color (values are already in percentage form)
            const highestPct = Math.max(bid_pct, market_pct);
            const highestColor = bid_pct >= market_pct ? "#48DA7E" : "#7B61FF";

            return `
                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="margin-left: 8px;">
                    ${bid_pct > 0 ? `
                        <circle 
                            cx="${center}" 
                            cy="${center}" 
                            r="${radius}"
                            fill="none"
                            stroke="#48DA7E"
                            stroke-width="${strokeWidth}"
                            stroke-dasharray="${bidDash} ${circumference}"
                            transform="rotate(-90, ${center}, ${center})"
                        />
                    ` : ''}
                    ${market_pct > 0 ? `
                        <circle 
                            cx="${center}" 
                            cy="${center}" 
                            r="${radius}"
                            fill="none"
                            stroke="#7B61FF"
                            stroke-width="${strokeWidth}"
                            stroke-dasharray="${marketDash} ${circumference}"
                            transform="rotate(${bidAngle - 90}, ${center}, ${center})"
                        />
                    ` : ''}
                    <text 
                        x="${center}" 
                        y="${center}" 
                        text-anchor="middle" 
                        dominant-baseline="middle" 
                        fill="${highestColor}"
                        style="font-size: 12px; font-weight: bold;"
                    >${highestPct}</text>
                </svg>
            `;
        }

        function displayListings(listings) {
            const ethIcon = `<svg width="16" height="16" viewBox="0 0 256 417" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" style="vertical-align: middle;">
                <path fill="#8A92B2" d="M127.961 0l-2.795 9.5v275.668l2.795 2.79 127.962-75.638z"></path>
                <path fill="#62688F" d="M127.962 0L0 212.32l127.962 75.639V154.158z"></path>
                <path fill="#454A75" d="M127.961 312.187l-1.575 1.92v98.199l1.575 4.6L256 236.587z"></path>
                <path fill="#62688F" d="M127.962 416.905v-104.72L0 236.585z"></path>
                <path fill="#8A92B2" d="M127.961 287.958l127.96-75.637-127.96-58.162z"></path>
                <path fill="#62688F" d="M0 212.32l127.96 75.638v-133.8z"></path>
            </svg>`;

            // Update the legend
            const legend = `
                <div class="legend">
                    <div class="legend-item">
                        <svg width="20" height="2">
                            <line x1="0" y1="1" x2="20" y2="1" stroke="#48DA7E" stroke-width="2"/>
                        </svg>
                        <span>Bid Prices</span>
                    </div>
                    <div class="legend-item">
                        <svg width="20" height="2">
                            <line x1="0" y1="1" x2="20" y2="1" stroke="#7B61FF" stroke-width="2"/>
                        </svg>
                        <span>Market Prices</span>
                    </div>
                </div>
            `;

            // Split listings into floor and non-floor prices
            const floorListings = listings.filter(listing => 
                parseFloat(listing.price_numeric) <= parseFloat(listing.floor_price)
            );
            const otherListings = listings.filter(listing => 
                parseFloat(listing.price_numeric) > parseFloat(listing.floor_price)
            );

            const createTableRows = (listings) => listings.map(listing => `
                <tr>
                    <td>
                        <img 
                            class="card-image" 
                            src="https://r2.fantasy.top/v2/${getRarityName(listing.rarity)}/${listing.hero_id}_${listing.heroes.stars}.png" 
                            alt="Hero Card"
                            onerror="this.src='../icons/ft_logo.webp'"
                        >
                    </td>
                    <td class="hero-cell">
                        ${listing.heroes.name}
                        <a href="https://x.com/${listing.heroes.handle}" target="_blank" style="margin-left: 4px; text-decoration: none;">
                            <i class="fa-brands fa-x-twitter" style="font-size: 0.8em; color: #777;"></i>
                        </a>
                    </td>
                    <td class="score-cell">
                        <div class="score-container">
                            <span class="score-value score-24h" title="24 hour score">
                                <span style="color: ${getScoreColor(listing.supabaseInfo.score_24hr)}">
                                    24h: ${listing.supabaseInfo.score_24hr ? Math.round(listing.supabaseInfo.score_24hr) : '-'}
                                </span>
                            </span>
                            <span class="score-value score-7d" title="7 day score">
                                <span style="color: ${getScoreColor(listing.supabaseInfo.score_7d)}">
                                    7d: ${listing.supabaseInfo.score_7d ? Math.round(listing.supabaseInfo.score_7d) : '-'}
                                </span>
                            </span>
                            <span class="score-value score-main" title="Main score">
                                <span style="color: ${getScoreColor(listing.supabaseInfo.score_main)}">
                                    Main: ${listing.supabaseInfo.score_main ? Math.round(listing.supabaseInfo.score_main) : '-'}
                                </span>
                            </span>                      
                        </div>
                    </td>
                    <td>${formatTimeUntilExpiration(listing.expiration_time)}</td>
                    <td class="listing-cell">
                        <span class="rank-container ${listing.rank ? (
                            listing.rank === 1 ? 'rank-1' : 
                            listing.rank === 2 ? 'rank-2' : 
                            listing.rank === 3 ? 'rank-3' : 
                            'rank-other'
                        ) : 'rank-placeholder'}">${listing.rank ? `#${listing.rank}` : ''}</span>
                        <span class="listing-price">
                            ${format_eth(listing.price_numeric)}${ethIcon}
                        </span>
                    </td>
                    <td class="section-divider">
                        <div class="floor-container">
                            <div class="floor-value">
                                ${format_eth(listing.floor_price)} ${ethIcon}
                            </div>
                            <div class="profile-container">
                                ${listing.topTrader ? `
                                    <img 
                                        class="profile-pic" 
                                        src="${listing.topTrader.pfpUrl}" 
                                        alt="Profile"
                                        onerror="this.src='../icons/ft_logo.webp'"
                                    >
                                    <span class="seller-info">
                                        ${listing.topTrader.name ? 
                                            (listing.topTrader.name.length > 15 ? 
                                            listing.topTrader.name.substring(0, 15) + '...' : 
                                            listing.topTrader.name) 
                                            : ''}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </td>
                    <td class="section-divider">
                        <div class="last-sale-container">
                            ${listing.supabaseInfo.last_sale ? `
                                <div class="last-sale-value">
                                    ${format_eth(listing.supabaseInfo.last_sale)} ${ethIcon}
                                </div>
                                <div class="last-sale-time" title="${new Date(listing.supabaseInfo.last_sale_time).toUTCString()}">
                                    ${formatLastSaleTime(listing.supabaseInfo.last_sale_time)}
                                </div>
                            ` : '-'}
                        </div>
                    </td>
                    <td class="section-divider">
                        ${listing.supabaseInfo.trade_timeline ? createPriceChart(listing.supabaseInfo.trade_timeline) : ''}
                        ${createDonutChart(
                            listing.supabaseInfo.bid_pct || 0, 
                            listing.supabaseInfo.market_pct || 0
                        )}
                    </td>
                </tr>
            `).join('');

            const table = `
                ${legend}
                <table>
                    <thead>
                        <tr>
                            <th>Card</th>
                            <th class="hero-cell">Hero</th>
                            <th class="score-cell" title="Performance Score 24h/7d">Score</th>
                            <th>Time Left</th>
                            <th>Price</th>
                            <th class="section-divider">Floor</th>
                            <th class="section-divider">Last Sale</th>  <!-- Add this line -->
                            <th class="section-divider">Price Range L7D / L14D</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${floorListings.length > 0 ? `
                            <tr>
                                <td colspan="8" class="section-header">
                                    My Floor Price Listings (${floorListings.length}) - Total: ${format_eth(calculateTotalPrice(floorListings))} ${ethIcon}
                                </td>
                            </tr>
                            ${createTableRows(floorListings)}
                        ` : ''}
                        ${otherListings.length > 0 ? `
                            <tr>
                                <td colspan="8" class="section-header" style="margin-top: 20px;">
                                    Other Listings (${otherListings.length}) - Total: ${format_eth(calculateTotalPrice(otherListings))} ${ethIcon}
                                </td>
                            </tr>
                            ${createTableRows(otherListings)}
                        ` : ''}
                    </tbody>
                </table>
            `;
            
            document.getElementById('tableContainer').innerHTML = table;
        }

        // Fetch data when page loads
        fetchListings();
    </script>
</body>
</html>