<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Cards</title>
    <!-- Add Supabase JS library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .grid-container {
            margin: 20px;
        }
        .matrix-header {
            display: grid;
            grid-template-columns: 100px repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .matrix-row {
            display: grid;
            grid-template-columns: 100px repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            align-items: start;
        }
        .star-label {
            display: flex;
            align-items: center;
        }
        .star-circle {
            display: inline-block;
            width: 31px;
            height: 31px;
            border-radius: 50%;
            text-align: center;
            line-height: 31px;
            color: black;
            font-weight: bold;
            font-size: 14px;
        }
        .card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            border-radius: 8px;
            min-height: 50px;
            background-color: #292828;
            border: none;
        }
        .card-image {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: none;
        }
        .card-wrapper {
            position: relative;
            display: inline-block;
            text-align: center;
        }
        .card-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff4444;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1;
        }
        .score-diff {
            font-size: 8px;
            color: white;
            margin-top: 4px;
            white-space: normal;
            line-height: 1.2;
        }
        .score-container {
            margin-top: 5px;
            padding: 3px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 75%;
            width: 75%;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            overflow: hidden;
        }
        .score-container::before {
            content: "";
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
        }
        .score-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2px 0;
            position: relative;
        }
        .score-star-indicator {
            width: 20px;
            height: 20px;
            line-height: 20px;
            font-size: 10px;
            margin-left: 5px;
            position: relative;
            z-index: 2;
        }
        .score-item {
            flex: 1;
        }
        .score-label {
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .score-value {
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Scout Cards</h1>
    <div style="margin: 20px 0;">
        <input 
            type="text" 
            id="ownerSearch" 
            placeholder="Enter owner address"
            style="padding: 8px; width: 400px; margin-right: 10px;"
            value="0x162F95a9364c891028d255467F616902A479681a"
        >
        <button onclick="fetchCardData()" style="padding: 8px 16px;">Search</button>
        <span id="totalCards" style="margin-left: 15px; color: #666;"></span>
    </div>


    <div id="loading">Loading...</div>
    <div id="cardsByStars" style="display: none;">
        <style>
            .grid-container {
                margin: 20px;
            }
            .matrix-header {
                display: grid;
                grid-template-columns: 100px repeat(4, 1fr);
                gap: 10px;
                margin-bottom: 10px;
                font-weight: bold;
            }
            .matrix-row {
                display: grid;
                grid-template-columns: 100px repeat(4, 1fr);
                gap: 10px;
                margin-bottom: 20px;
                align-items: start;
            }
            .star-label {
                display: flex;
                align-items: center;
            }
            .star-circle {
                display: inline-block;
                width: 31px;
                height: 31px;
                border-radius: 50%;
                text-align: center;
                line-height: 31px;
                color: black;
                font-weight: bold;
                font-size: 14px;
            }
            .card-container {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                padding: 10px;
                border-radius: 8px;
                min-height: 50px;
                background-color: #292828;
                border: none;
            }
            .card-image {
                width: 80px;
                height: 120px;
                object-fit: cover;
                border-radius: 8px;
                border: none;
            }
            .card-wrapper {
                position: relative;
                display: inline-block;
                text-align: center;
            }
            .card-count {
                position: absolute;
                top: -5px;
                right: -5px;
                background-color: #ff4444;
                color: white;
                border-radius: 4px;
                padding: 2px 6px;
                font-size: 12px;
                font-weight: bold;
                z-index: 1;
            }
            .score-diff {
                font-size: 8px;
                color: white;
                margin-top: 4px;
                white-space: normal;
                line-height: 1.2;
            }
        </style>
    </div>

    <script>
        // Add these global variables at the top of the script
        let heroMetadata = [];
        let heroesData = [];
        let starRangesData = []; // Variable to store star ranges from Supabase
        let heroStats = []; // Generalized variable to store hero stats from Supabase

        // Add this function to fetch hero stats from Supabase
        async function fetchHeroStatsFromSupabase() {
            try {
                console.log('Fetching hero stats from Supabase...');
                const supabaseUrl = 'https://hhcuqhvmzwmehdsaamhn.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoY3VxaHZtendtZWhkc2FhbWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzIwMTIsImV4cCI6MjA1MDU0ODAxMn0.xJNGoFLnpnmQGLj8RY_4VLmefPmFzuOyiVHLvFtPkkE';
                const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                
                const { data, error } = await supabaseClient
                    .from('hero_stat_history_current')
                    .select('hero_id, hero_handle, fantasy_score, stat_type')
                    .eq('stat_type', 'gliding_24h');
                
                if (error) {
                    throw new Error(`Supabase error: ${error.message}`);
                }
                
                heroStats = data || [];
                console.log(`Loaded ${heroStats.length} hero stats from Supabase`);
                
                return heroStats;
            } catch (error) {
                console.error('Error fetching hero stats:', error);
                return [];
            }
        }

        // Add this function to fetch star ranges from Supabase
        async function fetchStarRangesFromSupabase() {
            try {
                console.log('Fetching star ranges from Supabase...');
                const supabaseUrl = 'https://hhcuqhvmzwmehdsaamhn.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoY3VxaHZtendtZWhkc2FhbWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzIwMTIsImV4cCI6MjA1MDU0ODAxMn0.xJNGoFLnpnmQGLj8RY_4VLmefPmFzuOyiVHLvFtPkkE';
                const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                
                const { data, error } = await supabaseClient
                    .from('star_ranges')
                    .select('*');
                
                if (error) {
                    throw new Error(`Supabase error: ${error.message}`);
                }
                
                starRangesData = data || [];
                console.log(`Loaded ${starRangesData.length} star ranges from Supabase`);
                
                return starRangesData;
            } catch (error) {
                console.error('Error fetching star ranges:', error);
                return [];
            }
        }

        // Add this function to load the JSON data
        async function loadHeroData() {
            try {
                console.log('Starting to load hero data...');
                const response = await fetch('/hero_stats.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Store the data globally
                heroMetadata = data.metadata || [];
                heroesData = data.heroes || [];
                
                console.log(`Loaded ${heroMetadata.length} metadata entries and ${heroesData.length} hero entries`);
                
                // After loading data, trigger the initial card fetch
                fetchCardData();
            } catch (error) {
                console.error('Error loading hero data:', error);
                document.getElementById('loading').textContent = 'Error loading hero data: ' + error.message;
            }
        }

        // Helper functions
        const extractHeroStars = (card) => {
            return card.stars || 0;
        };

        const getStarColor = (number) => {
            const colorMap = {
                1: '#808080', // Gray
                2: '#FFFDD0', // Cream
                3: '#FFFAA0', // Pastel Yellow
                4: '#FFFF8F', // Canary Yellow
                5: '#FAFA33', // Lemon Yellow
                6: '#FFEA00', // Golden Yellow
                7: '#FFD700', // Bright Yellow
                8: '#FFC000'  // Gold
            };
            return colorMap[number] || 'grey';
        };

        const getRarityLabel = (rarity) => {
            const rarityMap = {
                4: 'Common',
                3: 'Rare',
                
                2: 'Epic',
                1: 'Legendary'
            };
            return rarityMap[rarity] || 'Unknown';
        };

        // function fixImageUrl(card) {
        //     // Clone the card to avoid modifying the original data
        //     const fixedCard = { ...card };
        //     
        //     // Fix specific hero_id cases
        //     if (card.hero_id === '3063147623') {
        //         fixedCard.picture = card.picture.replace('djenn', 'jenndefer');
        //     }   
        //     if (card.hero_id === '1423031747432783872') {
        //         fixedCard.picture = card.picture.replace('zagabond', 'ZAGABOND');
        //     }
        //
        //     return fixedCard;
        // }

        function organizeCardsIntoMatrix(data) {
            // First, group cards by their unique properties and count occurrences
            const cardGroups = data.reduce((acc, card) => {
                // Fix image URL before grouping
                // const fixedCard = fixImageUrl(card); // Removed this line
                const key = `${card.rarity}-${card.picture}`; // Updated to use card directly
                
                if (!acc[key]) {
                    acc[key] = {
                        ...card, // Use card directly
                        count: 1
                    };
                } else {
                    acc[key].count++;
                }
                return acc;
            }, {});

            // Convert grouped cards back to array
            const uniqueCards = Object.values(cardGroups);

            // Find all unique star values
            const uniqueStars = [...new Set(uniqueCards.map(card => extractHeroStars(card)))].sort((a, b) => b - a);
            
            // Create matrix structure
            const matrix = uniqueStars.map(stars => {
                return {
                    stars,
                    rarities: {
                        Legendary: [],
                        Epic: [],
                        Rare: [],
                        Common: []
                    }
                };
            });

            // Populate the matrix with unique cards
            uniqueCards.forEach(card => {
                const stars = extractHeroStars(card);
                const rarity = getRarityLabel(card.rarity);
                console.log(`Card Rarity: ${card.rarity}, Mapped Rarity: ${rarity}`); // Debugging line
                const rowIndex = matrix.findIndex(row => row.stars === stars);
                if (rowIndex !== -1) {
                    matrix[rowIndex].rarities[rarity].push(card);
                }
            });

            return matrix;
        }

        function renderMatrix(matrix) {
            const container = document.createElement('div');
            container.className = 'grid-container';

            // Update styles for count badge and add total count styles
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                .card-count {
                    background-color: #F36FDD;  // Changed from #ff4444 to #F36FDD
                }
                .total-count {
                    position: absolute;
                    bottom: 5px;
                    right: 5px;
                    background-color: #f0f0f0;
                    color: #333;
                    border-radius: 4px;
                    padding: 2px 6px;
                    font-size: 12px;
                    font-weight: bold;
                }
                .card-container {
                    position: relative;  // Added to position the total count
                }
                .score-container {
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                }
                .score-item {
                    margin-top: 2px;
                    padding: 3px;
                    background-color: rgba(255, 255, 255, 0.8);
                    border-radius: 4px;
                    text-align: center;
                    font-weight: bold;
                    color: #333;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                    font-size: 75%;
                    width: 75%;
                    margin-left: auto;
                    margin-right: auto;
                    position: relative;
                    overflow: hidden;
                }
                .score-item::before {
                    content: "";
                    position: absolute;
                    top: -10px;
                    left: -10px;
                    right: -10px;
                    bottom: -10px;
                }
            `;
            document.head.appendChild(styleElement);

            // First, determine which rarities have cards
            const activeRarities = ['Legendary', 'Epic', 'Rare', 'Common'].filter(rarity => {
                return matrix.some(row => row.rarities[rarity].length > 0);
            });

            // Create header row with only active rarities
            const header = document.createElement('div');
            header.className = 'matrix-header';
            header.innerHTML = `
                <div>Stars</div>
                ${activeRarities.map(rarity => `
                    <div style="color: ${getRarityColor(rarity)}">
                        ${rarity}
                    </div>
                `).join('')}
            `;
            
            // Update grid template columns based on number of active rarities
            const gridColumns = `100px repeat(${activeRarities.length}, 1fr)`;
            header.style.gridTemplateColumns = gridColumns;
            container.appendChild(header);

            // Create matrix rows
            matrix.forEach(row => {
                const matrixRow = document.createElement('div');
                matrixRow.className = 'matrix-row';
                matrixRow.style.gridTemplateColumns = gridColumns;

                // Star label cell
                const starLabel = document.createElement('div');
                starLabel.className = 'star-label';
                starLabel.style.flexDirection = 'column';
                starLabel.style.alignItems = 'center';

                const starCircle = document.createElement('div');
                starCircle.className = 'star-circle';
                starCircle.style.backgroundColor = getStarColor(row.stars);
                starCircle.textContent = row.stars;

                const rangeInfo = document.createElement('div');
                rangeInfo.style.fontSize = '12px';
                rangeInfo.style.marginTop = '4px';
                rangeInfo.style.color = '#666';

                // Use Supabase star ranges data if available
                const starRange = starRangesData.find(range => range.stars === row.stars);
                if (starRange) {
                    const topRange = Math.floor(starRange.top_range);
                    const bottomRange = Math.floor(starRange.bottom_range);
                    rangeInfo.textContent = `Range: ${topRange} - ${bottomRange}`;
                } else {
                    // Fallback to local metadata if Supabase data isn't available
                    const starMetadata = heroMetadata.find(meta => meta.stars === row.stars);
                    if (starMetadata) {
                        const topRange = Math.floor(starMetadata.top_range);
                        const bottomRange = Math.floor(starMetadata.bottom_range);
                        rangeInfo.textContent = `Range: ${topRange} - ${bottomRange}`;
                    }
                }

                starLabel.appendChild(starCircle);
                starLabel.appendChild(rangeInfo);
                matrixRow.appendChild(starLabel);

                // Only render cells for active rarities
                activeRarities.forEach(rarity => {
                    const cell = document.createElement('div');
                    cell.className = 'card-container';
                    
                    // Calculate total cards in this rarity+star combination
                    const totalCards = row.rarities[rarity].reduce((sum, card) => sum + card.card_number, 0);
                    
                    row.rarities[rarity].forEach(card => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'card-wrapper';

                        const countBadge = document.createElement('div');
                        countBadge.className = 'card-count';
                        countBadge.textContent = card.card_number;
                        wrapper.appendChild(countBadge);

                        const img = document.createElement('img');
                        card.picture = `${card.picture}_${card.stars}.png`; // Update picture URL to include stars
                        img.src = card.picture;
                        img.className = 'card-image';
                        img.alt = `${rarity} ${row.stars}-star card`;
                        wrapper.appendChild(img);

                        // New container for scores
                        const scoreContainer = document.createElement('div');
                        scoreContainer.className = 'score-container'; // Add a class for styling
                        
                        // Add 7D score
                        const sevenDayScore = document.createElement('div');
                        sevenDayScore.className = 'score-item';
                        
                        // Get raw score value
                        let sevenDayScoreValue = Math.floor(card.card_weighted_score);
                        
                        // Apply rarity-based adjustments for star range comparison
                        let adjustedSevenDayScore = sevenDayScoreValue;
                        if (rarity === 'Legendary') {
                            adjustedSevenDayScore = sevenDayScoreValue / 2.5;
                        } else if (rarity === 'Epic') {
                            adjustedSevenDayScore = sevenDayScoreValue / 2;
                        } else if (rarity === 'Rare') {
                            adjustedSevenDayScore = sevenDayScoreValue / 1.5;
                        }
                        
                        // Create two-line format with label on top and score below
                        const sevenDayLabel = document.createElement('div');
                        sevenDayLabel.className = 'score-label';
                        sevenDayLabel.textContent = '7D';
                        
                        const sevenDayValue = document.createElement('div');
                        sevenDayValue.className = 'score-value';
                        sevenDayValue.textContent = sevenDayScoreValue;
                        
                        sevenDayScore.appendChild(sevenDayLabel);
                        sevenDayScore.appendChild(sevenDayValue);
                        
                        // Check if score is within star range and color accordingly
                        if (starRange) {
                            const topRange = Math.floor(starRange.top_range);
                            const bottomRange = Math.floor(starRange.bottom_range);
                            const midPoint = bottomRange + (topRange - bottomRange) / 2;
                            
                            if (adjustedSevenDayScore >= bottomRange && adjustedSevenDayScore <= topRange) {
        
                                // Create star circle indicator for the current star level
                                const starIndicator = document.createElement('div');
                                starIndicator.className = 'star-circle score-star-indicator';
                                starIndicator.style.backgroundColor = getStarColor(row.stars);
                                starIndicator.textContent = row.stars;
                                
                                // Create wrapper to hold score and indicator
                                const scoreWrapper = document.createElement('div');
                                scoreWrapper.className = 'score-wrapper';
                                scoreWrapper.appendChild(sevenDayScore);
                                scoreWrapper.appendChild(starIndicator);
                                
                                scoreContainer.appendChild(scoreWrapper);
                            } else {
                                // Score is outside range - find which star range it falls into
                                const matchingRange = starRangesData.find(range => 
                                    adjustedSevenDayScore >= Math.floor(range.bottom_range) && 
                                    adjustedSevenDayScore <= Math.floor(range.top_range)
                                );
                                
                                if (matchingRange) {
                                    // Create star circle indicator
                                    const starIndicator = document.createElement('div');
                                    starIndicator.className = 'star-circle score-star-indicator';
                                    starIndicator.style.backgroundColor = getStarColor(matchingRange.stars);
                                    starIndicator.textContent = matchingRange.stars;
                                    // Create wrapper to hold score and indicator
                                    const scoreWrapper = document.createElement('div');
                                    scoreWrapper.className = 'score-wrapper';
                                    scoreWrapper.appendChild(sevenDayScore);
                                    scoreWrapper.appendChild(starIndicator);
                                    
                                    scoreContainer.appendChild(scoreWrapper);
                                } else {
                                    scoreContainer.appendChild(sevenDayScore);
                                }
                            }
                        } else {
                            scoreContainer.appendChild(sevenDayScore);
                        }
                        
                        // Only add to container if we didn't add it in the conditional logic above
                        if (!sevenDayScore.parentNode) {
                            scoreContainer.appendChild(sevenDayScore);
                        }
                        
                        // Add 24H score if available
                        const score24h = getHeroStat(card.hero_id, 'gliding_24h');
                        if (score24h !== null) {
                            const dayScore = document.createElement('div');
                            dayScore.className = 'score-item';
                            
                            // Get raw score value
                            const dayScoreValue = Math.floor(score24h);
                            
                            // Apply rarity-based adjustments for star range comparison
                            let adjustedDayScore = dayScoreValue;
                            
                            // Create two-line format with label on top and score below
                            const dayLabel = document.createElement('div');
                            dayLabel.className = 'score-label';
                            dayLabel.textContent = '24H';
                            
                            const dayValue = document.createElement('div');
                            dayValue.className = 'score-value';
                            dayValue.textContent = dayScoreValue;
                            
                            dayScore.appendChild(dayLabel);
                            dayScore.appendChild(dayValue);
                            
                            // Check if score is within star range and color accordingly
                            if (starRange) {
                                const topRange = Math.floor(starRange.top_range);
                                const bottomRange = Math.floor(starRange.bottom_range);
                                const midPoint = bottomRange + (topRange - bottomRange) / 2;
                                
                                if (adjustedDayScore >= bottomRange && adjustedDayScore <= topRange) {
                            
                                    // Create wrapper to hold score only
                                    const scoreWrapper = document.createElement('div');
                                    scoreWrapper.className = 'score-wrapper';
                                    scoreWrapper.appendChild(dayScore);
                                    
                                    scoreContainer.appendChild(scoreWrapper);
                                } else {
                                    // Score is outside range - find which star range it falls into
                                    const matchingRange = starRangesData.find(range => 
                                        adjustedDayScore >= Math.floor(range.bottom_range) && 
                                        adjustedDayScore <= Math.floor(range.top_range)
                                    );
                                    
                                    if (matchingRange) {
                                        // Create wrapper to hold score only
                                        const scoreWrapper = document.createElement('div');
                                        scoreWrapper.className = 'score-wrapper';
                                        scoreWrapper.appendChild(dayScore);
                                        
                                        scoreContainer.appendChild(scoreWrapper);
                                    } else {
                                        scoreContainer.appendChild(dayScore);
                                    }
                                }
                            } else {
                                scoreContainer.appendChild(dayScore);
                            }
                            
                            // Only add to container if we didn't add it in the conditional logic above
                            if (!dayScore.parentNode) {
                                scoreContainer.appendChild(dayScore);
                            }
                        }
                        
                        wrapper.appendChild(scoreContainer);

                        cell.appendChild(wrapper);
                    });

                    // Add total count if there are any cards
                    if (totalCards > 0) {
                        const totalCountBadge = document.createElement('div');
                        totalCountBadge.className = 'total-count';
                        totalCountBadge.textContent = `Total: ${totalCards}`;
                        cell.appendChild(totalCountBadge);
                    }

                    matrixRow.appendChild(cell);
                });

                container.appendChild(matrixRow);
            });

            return container;
        }

        async function fetchAllCardData(ownerAddress) {
            const BATCH_SIZE = 50;
            let allCards = [];
            let currentPage = 0;
            
            // Get first batch and total count
            const firstResponse = await fetch(
                `https://api-v2.fantasy.top/card/player/${ownerAddress}?pagination[page]=${currentPage}&pagination[limit]=${BATCH_SIZE}&orderBy=cards_score&groupCard=true`,
                {
                    method: "GET",
                    headers: {
                        "accept": "application/json",
                        "x-api-key": "cbc57228-5495-47b0-ae2f-b43ba6d5a9b6",
                        "Access-Control-Allow-Origin": "*",
                        "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
                        "Access-Control-Allow-Headers": "Origin, X-Requested-With, Content-Type, Accept, X-Api-Key"
                    }
                }
            );
            const firstData = await firstResponse.json();
            
            // Add first batch to results
            if (firstData.data) {
                allCards = [...firstData.data];
                console.log(`Added ${firstData.data.length} cards from page 1`);
            }
            
            // Fetch remaining batches using lastPage from metadata
            const lastPage = firstData.meta?.lastPage || 1;
            while (currentPage < lastPage) {
                currentPage++;
                const response = await fetch(
                    `https://api-v2.fantasy.top/card/player/${ownerAddress}?pagination[page]=${currentPage}&pagination[limit]=${BATCH_SIZE}&orderBy=cards_score&groupCard=true`,
                    {
                        method: "GET",
                        headers: {
                            "accept": "application/json",
                            "x-api-key": "cbc57228-5495-47b0-ae2f-b43ba6d5a9b6",
                            "Access-Control-Allow-Origin": "*",
                            "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
                            "Access-Control-Allow-Headers": "Origin, X-Requested-With, Content-Type, Accept, X-Api-Key"
                        }
                    }
                );
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    allCards = [...allCards, ...data.data];
                    console.log(`Added ${data.data.length} cards from page ${currentPage}`);
                }
            }

            // Display total cards count after fetching all pages
            const totalCards = allCards.reduce((sum, card) => sum + card.card_number, 0); // Updated to sum card_number values from allCards
            document.getElementById('totalCards').textContent = `(Total Cards: ${totalCards})`;
            
            console.log(`Total cards accumulated: ${allCards.length}`);
            return allCards;
        }

        function organizeCardsByScore(data) {
            if (!data) return [];
            
            // Group cards by unique hero (picture) and apply fixImageUrl first
            const uniqueCards = Object.values(data.reduce((acc, card) => {
                // const fixedCard = fixImageUrl(card); // Removed this line
                const key = card.picture;
                if (!acc[key]) {
                    acc[key] = {
                        ...card, // Use card directly
                        score: Math.floor(Math.random() * 1001), // Random score 0-1000
                        count: 1
                    };
                } else {
                    acc[key].count++;
                }
                return acc;
            }, {}));

            // Sort by score
            uniqueCards.sort((a, b) => b.score - a.score);

            // Group into ranges of 200
            const ranges = [];
            for (let i = 1000; i >= 0; i -= 200) {
                const rangeCards = {
                    range: `${i}-${Math.max(0, i-199)}`,
                    rarities: {
                        Legendary: [],
                        Epic: [],
                        Rare: [],
                        Common: []
                    }
                };
                
                uniqueCards
                    .filter(card => card.score <= i && card.score > Math.max(0, i-200))
                    .forEach(card => {
                        const rarity = getRarityLabel(card.rarity);
                        rangeCards.rarities[rarity].push(card);
                    });
                
                if (Object.values(rangeCards.rarities).some(arr => arr.length > 0)) {
                    ranges.push(rangeCards);
                }
            }

            return ranges;
        }

        function renderScoreMatrix(matrix) {
            // Similar to renderMatrix but with score ranges instead of stars
            const container = document.createElement('div');
            container.className = 'grid-container';

            // Determine active rarities
            const activeRarities = ['Legendary', 'Epic', 'Rare', 'Common'].filter(rarity => {
                return matrix.some(row => row.rarities[rarity].length > 0);
            });

            // Create header
            const header = document.createElement('div');
            header.className = 'matrix-header';
            header.innerHTML = `
                <div>Score Range</div>
                ${activeRarities.map(rarity => `<div>${rarity}</div>`).join('')}
            `;

            const gridColumns = `100px repeat(${activeRarities.length}, 1fr)`;
            header.style.gridTemplateColumns = gridColumns;
            container.appendChild(header);

            // Create rows
            matrix.forEach(row => {
                const matrixRow = document.createElement('div');
                matrixRow.className = 'matrix-row';
                matrixRow.style.gridTemplateColumns = gridColumns;

                // Score range label
                const rangeLabel = document.createElement('div');
                rangeLabel.className = 'star-label';
                rangeLabel.textContent = row.range;
                matrixRow.appendChild(rangeLabel);

                // Add cells for each rarity
                activeRarities.forEach(rarity => {
                    const cell = document.createElement('div');
                    cell.className = 'card-container';
                    
                    row.rarities[rarity].forEach(card => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'card-wrapper';

                        const countBadge = document.createElement('div');
                        countBadge.className = 'card-count';
                        countBadge.textContent = card.card_number;
                        wrapper.appendChild(countBadge);

                        const img = document.createElement('img');
                        console.log('Image URL:', card.picture); // Debug print the full URL
                        img.src = card.picture;
                        img.className = 'card-image';
                        img.alt = `${rarity} ${row.stars}-star card`;
                        wrapper.appendChild(img);

                        // New container for card_weighted_score
                        const scoreContainer = document.createElement('div');
                        scoreContainer.className = 'score-container'; // Add a class for styling
                        scoreContainer.textContent = `7D: ${Math.floor(card.card_weighted_score)}`; // Add "7D:" label before the score
                        wrapper.appendChild(scoreContainer); // Append the score container to the wrapper

                        cell.appendChild(wrapper);
                    });

                    matrixRow.appendChild(cell);
                });

                container.appendChild(matrixRow);
            });

            return container;
        }

        // Update fetchCardData to include error handling
        async function fetchCardData() {
            try {
                const ownerAddress = document.getElementById('ownerSearch').value.trim();
                const loadingDiv = document.getElementById('loading');
                const starView = document.getElementById('cardsByStars');
                
                if (!heroMetadata || !heroesData) {
                    throw new Error('Hero data not loaded yet');
                }
                
                loadingDiv.style.display = 'block';
                starView.style.display = 'none';
                
                // Remove the old headers setup and just call fetchAllCardData directly
                const allCards = await fetchAllCardData(ownerAddress);
                console.log(`Fetched ${allCards.length} cards`);
                
                window.currentCardData = allCards;
                loadingDiv.style.display = 'none';
                
                if (allCards.length > 0) {
                    starView.style.display = 'block';
                    const matrix = organizeCardsIntoMatrix(allCards);
                    const matrixElement = renderMatrix(matrix);
                    starView.innerHTML = '';
                    starView.appendChild(matrixElement);
                    // }
                } else {
                    loadingDiv.textContent = 'No cards found for this address';
                    loadingDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error in fetchCardData:', error);
                document.getElementById('loading').textContent = 'Error loading data: ' + error.message;
            }
        }

        // Add event listener for Enter key
        document.getElementById('ownerSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchCardData();
            }
        });

        // Update the initial load section
        document.addEventListener('DOMContentLoaded', function() {
            // Load all data sources
            Promise.all([
                loadHeroData(),
                fetchStarRangesFromSupabase(),
                fetchHeroStatsFromSupabase()
            ])
            .then(() => {
                console.log('All data loaded successfully');
                fetchCardData();
            })
            .catch(error => {
                console.error('Error loading initial data:', error);
                document.getElementById('loading').textContent = 'Error loading initial data: ' + error.message;
            });
        });

        const getRarityColor = (rarity) => {
            const colorMap = {
                'Common': '#48EE4B',
                'Rare': '#02E0F4',
                'Epic': '#CD2FD7',
                'Legendary': '#7F76F5'
            };
            return colorMap[rarity] || '#666666';
        };

        // Add these helper functions where convenient
        function getHeroMetadata(heroId) {
            return heroMetadata.find(meta => meta.hero_id === heroId);
        }

        function getHeroStats(heroId) {
            return heroesData.find(hero => hero.hero_id === heroId);
        }

        // Add these helper functions at the top of your script section
        function findScoreRanges(stars) {
            // Fixed ranges for both metrics
            return {
                sevenDayRange: { min: 0, max: 1000 },
                l3mtRange: { min: 0, max: 1000 }
            };
        }

        // Generalized helper function to get hero stats by hero_id and stat_type
        function getHeroStat(heroId, statType) {
            const statData = heroStats.find(item => item.hero_id === heroId && item.stat_type === statType);
            return statData ? statData.fantasy_score : null;
        }

    </script>
</body>
</html>