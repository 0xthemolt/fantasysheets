<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Season Last 4 Avg Scores</title>
    <link rel="stylesheet" href="../styles.css?v=8e4c2f">
    <link rel="icon" type="image/png" href="../icons/favicon.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .tournament-table th {
            cursor: pointer;
            user-select: none;
            padding: 8px;
        }

        .average-column {
            border-left: 2px solid #444;
            padding-left: 16px !important;
        }

        .average-header {
            font-weight: 600;
            color: #888;
        }

        .cut-line td {
            position: relative;
            border-top: 2px dashed #ff4444;
        }
        
        .cut-indicator {
            color: #ff4444;
            font-size: 0.8em;
            margin-left: 4px;
        }

        .removed-indicator {
            color: #ff4444;
            margin-left: 4px;
            font-size: 0.8em;
        }

        .exempt-indicator {
            color: #3498db;
            font-size: 0.8em;
            margin-left: 4px;
        }

        .exempt-line td {
            position: relative;
            border-top: 2px dashed #3498db;
        }

        .line-label {
            position: absolute;
            top: -14px;
            width: 100%;  /* Use full width of the table */
            left: 0;      /* Align to left edge */
            text-align: center;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1;
        }

        .cut-line-label {
            color: #ff4444;
        }

        .exempt-line-label {
            color: #3498db;
        }

        .rank-cell {
            width: 30px;  /* Reduce from 40px */
            text-align: center;
            color: #666;
            padding-right: 4px !important;  /* Add tight padding */
        }

        .hero-cell {
            display: flex;
            align-items: center;
            padding-left: 4px;  /* Add left padding to maintain small gap */
        }

        .hero-image {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .tournament-table td {
            padding: 8px 4px;  /* Reduce default cell padding */
        }

        .toggle-container {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .search-box {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
            background-color: #fff;
            color: #333;
        }

        .search-box::placeholder {
            color: #999;
        }

        .data-freshness {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            margin-left: 28px;
            margin-bottom: 10px;
            display: flex;
            gap: 5px;
            align-items: center;
        }

        
        /* Add these styles to your existing <style> section */
        body {
            margin: 0;
            padding: 15px;
            min-width: fit-content;  /* Ensure body is at least as wide as content */
            overflow-x: auto;        /* Allow horizontal scrolling */
        }

        table {
            width: max-content;      /* Let table take its natural width */
            min-width: 100%;        /* But at least as wide as viewport */
        }

        #tableContainer {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;  /* Add this */
        }

        .tournament-table {
            position: relative;  /* Add this */
            width: 100%;
        }

    </style>
</head>
<body>
    <div class="title-container">
        <h1 class="title-header">
            <a href="../index.html" class="home-link">
                <i class="fas fa-home"></i>
            </a>
            Season / Last 4 Avg Score
        </h1>
    </div>
    <div class="data-freshness">
        <span>Scores: Live</span></span>
    </div>
    <div class="toggle-container">
        <input type="text" 
               id="heroSearch" 
               class="search-box" 
               placeholder="Search heroes...">
        <label class="toggle-switch">
            <input type="checkbox" id="showOutgoingToggle">
            Show Bottom 15 Heroes (at risk)
        </label>
    </div>
    <div id="tableContainer">
        <table class="tournament-table">
            <thead>
                <tr>
                    <th>Hero</th>
                    <!-- Tournament columns will be added dynamically -->
                    <th class="number-cell average-header">Average</th>
                </tr>
            </thead>
            <tbody id="heroTableBody"></tbody>
        </table>
    </div>

    <script>
        // Define tournament numbers
        const tournamentNumbers = [51, 50, 49, 48];

        const EXEMPT_HEROES = ['frankdegods'];
        const TEAM_HEROES = ['0xMikado', 'travisbickle0x', '0xKipit'];

        async function fetchTournamentData() {
            try {
                const tournamentPromises = tournamentNumbers.map(tournamentNumber => 
                    fetch(`https://api-v2.fantasy.top/hero/stats?pagination.page=1&pagination.limit=200&order_by.fantasy_score=desc&tournament_number=${tournamentNumber}&search=%25%25&tactic_only=false`, {
                        headers: {
                            'accept': 'application/json',
                            'x-api-key': 'cbc57228-5495-47b0-ae2f-b43ba6d5a9b6'
                        }
                    }).then(response => response.json())
                );

                const tournamentResults = await Promise.all(tournamentPromises);

                let combinedData = {};

                tournamentResults.forEach((tournament, index) => {
                    const tournamentNumber = tournamentNumbers[index];
                    tournament.data.forEach(hero => {
                        const heroKey = hero.handle; // Use handle as unique identifier
                        if (!combinedData[heroKey]) {
                            combinedData[heroKey] = {
                                handle: hero.handle,
                                name: hero.name,
                                profile_image: hero.profile_image_url_https,
                                tournaments: {},
                                avgScore: 0,
                                totalTournaments: 0
                            };
                        }
                        combinedData[heroKey].tournaments[tournamentNumber] = {
                            fantasy_score: parseFloat(hero.fantasy_score),
                            rank: hero.current_rank
                        };
                        combinedData[heroKey].totalTournaments++;
                    });
                });

                // Calculate averages
                Object.values(combinedData).forEach(hero => {
                    const scores = Object.values(hero.tournaments).map(t => t.fantasy_score);
                    hero.avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
                });

                window.seasonData = combinedData;
                console.log('Season data loaded:', Object.keys(combinedData).length, 'heroes');
                return combinedData;

            } catch (error) {
                console.error('Error fetching tournament data:', error);
                return null;
            }
        }

        // Add color cache for performance
        const colorCache = new Map();

        // Add lerp function
        function lerp(start, end, amt) {
            return start * (1 - amt) + end * amt;
        }

        function getColorForRank(value, maxValue = 1000, higherIsBetter = true) {
            const cacheKey = `${value}_${maxValue}_${higherIsBetter}`;
            if (colorCache.has(cacheKey)) {
                return colorCache.get(cacheKey);
            }

            let ratio;
            if (higherIsBetter) {
                ratio = Math.min(value / maxValue, 1);
            } else {
                // For ranks - lower is better
                ratio = 1 - (Math.min(value / maxValue, 1));
            }

            if (ratio < 0.5) {
                // Red to Orange/Gold transition
                const r = Math.round(lerp(215, 230, ratio * 2));
                const g = Math.round(lerp(48, 140, ratio * 2));  // Reduced from 224 to 140
                const b = Math.round(lerp(39, 0, ratio * 2));    // Changed to 0 for more saturation
                const color = `rgb(${r}, ${g}, ${b})`;
                colorCache.set(cacheKey, color);
                return color;
            } else {
                // Orange/Gold to Green transition
                const r = Math.round(lerp(230, 44, (ratio - 0.5) * 2));
                const g = Math.round(lerp(140, 162, (ratio - 0.5) * 2));
                const b = Math.round(lerp(0, 95, (ratio - 0.5) * 2));
                const color = `rgb(${r}, ${g}, ${b})`;
                colorCache.set(cacheKey, color);
                return color;
            }
        }

        function sortData(data, column, ascending = false) {
            return Object.values(data).sort((a, b) => {
                // First check if either hero is exempt
                const aIsExempt = EXEMPT_HEROES.includes(a.handle) || TEAM_HEROES.includes(a.handle);
                const bIsExempt = EXEMPT_HEROES.includes(b.handle) || TEAM_HEROES.includes(b.handle);

                // If exempt status differs, exempt heroes go to bottom
                if (aIsExempt !== bIsExempt) {
                    return aIsExempt ? 1 : -1;
                }

                // If both are exempt or both are not, sort normally
                let aValue, bValue;
                
                if (column === 'average') {
                    aValue = a.avgScore;
                    bValue = b.avgScore;
                } else if (column === 'handle') {
                    aValue = a.handle.toLowerCase();
                    bValue = a.handle.toLowerCase();
                    return ascending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                } else {
                    aValue = a.tournaments[column]?.fantasy_score || 0;
                    bValue = a.tournaments[column]?.fantasy_score || 0;
                }
                
                return ascending ? aValue - bValue : bValue - aValue;
            });
        }

        // Add fuzzy search function
        function fuzzyMatch(str, pattern) {
            pattern = pattern.toLowerCase();
            str = str.toLowerCase();
            
            let patternIdx = 0;
            let strIdx = 0;
            
            while (strIdx < str.length && patternIdx < pattern.length) {
                if (str[strIdx] === pattern[patternIdx]) {
                    patternIdx++;
                }
                strIdx++;
            }
            
            return patternIdx === pattern.length;
        }

        function displayTournamentData(data, sortColumn = 'average', ascending = false) {
            const tableHead = document.querySelector('.tournament-table thead tr');
            const tableBody = document.getElementById('heroTableBody');
            
            // Clear entire header first
            tableHead.innerHTML = '';
            
            // Add rank header
            const rankHeader = document.createElement('th');
            rankHeader.textContent = '#';
            rankHeader.className = 'rank-cell';
            tableHead.appendChild(rankHeader);
            
            // Add hero header
            const heroHeader = document.createElement('th');
            heroHeader.textContent = 'Hero';
            heroHeader.dataset.sort = 'handle';
            heroHeader.addEventListener('click', () => handleSort('handle'));
            tableHead.appendChild(heroHeader);
            
            // Sort tournament numbers in ascending order
            const sortedTournaments = tournamentNumbers.sort((a, b) => a - b);
            
            // Add tournament number columns
            sortedTournaments.forEach(num => {
                const th = document.createElement('th');
                th.textContent = `T${num}`;
                th.className = 'number-cell';
                th.dataset.sort = num.toString();
                th.addEventListener('click', () => handleSort(num.toString()));
                tableHead.appendChild(th);
            });

            // Add average column header
            const averageHeader = document.createElement('th');
            averageHeader.textContent = 'Average';
            averageHeader.className = 'number-cell average-column average-header';
            averageHeader.dataset.sort = 'average';
            averageHeader.addEventListener('click', () => handleSort('average'));
            tableHead.appendChild(averageHeader);

            // Get all fantasy scores for color scaling
            const allScores = Object.values(data).flatMap(hero => 
                Object.values(hero.tournaments).map(t => t.fantasy_score)
            );
            const maxScore = Math.max(...allScores);

            // Sort and create rows
            const sortedData = sortData(data, sortColumn, ascending);
            tableBody.innerHTML = '';

            // Filter out exempt and team heroes for bottom 15 calculation
            const nonExemptHeroes = sortedData.filter(hero => 
                !EXEMPT_HEROES.includes(hero.handle) && 
                !TEAM_HEROES.includes(hero.handle)
            );

            // Calculate bottom 15 index based on non-exempt heroes
            const bottom15Index = nonExemptHeroes.length - 15;

            const searchTerm = document.getElementById('heroSearch').value;
            const showOnlyOutgoing = document.getElementById('showOutgoingToggle').checked;

            const heroesToDisplay = sortedData.filter(hero => {
                // First apply search filter if there's a search term
                if (searchTerm) {
                    const matchesSearch = 
                        fuzzyMatch(hero.name, searchTerm) || 
                        fuzzyMatch(hero.handle, searchTerm);
                    if (!matchesSearch) return false;
                }

                // Then apply the outgoing filter if enabled
                if (showOnlyOutgoing) {
                    const nonExemptIndex = nonExemptHeroes.findIndex(h => h.handle === hero.handle);
                    return nonExemptIndex >= bottom15Index && 
                           !EXEMPT_HEROES.includes(hero.handle) && 
                           !TEAM_HEROES.includes(hero.handle);
                }
                
                return true;
            });

            // Calculate ranks based on average score (before any sorting)
            const ranksByAverage = Object.values(data)
                .sort((a, b) => b.avgScore - a.avgScore)
                .reduce((acc, hero, index) => {
                    acc[hero.handle] = index + 1;
                    return acc;
                }, {});

            heroesToDisplay.forEach((hero, index) => {
                const row = document.createElement('tr');
                
                const isPossiblyExempt = EXEMPT_HEROES.includes(hero.handle);
                const isExempt = TEAM_HEROES.includes(hero.handle);
                
                // Calculate real position in non-exempt list
                const nonExemptIndex = nonExemptHeroes.findIndex(h => h.handle === hero.handle);
                
                const isBottomFifteen = currentSort.column === 'average' && 
                                       !currentSort.ascending && 
                                       nonExemptIndex >= bottom15Index &&
                                       !isPossiblyExempt && 
                                       !isExempt;

                // Add rank cell first
                const rankCell = document.createElement('td');
                rankCell.className = 'rank-cell';
                rankCell.textContent = ranksByAverage[hero.handle];
                row.appendChild(rankCell);

                // Add cut line before first bottom 15 non-exempt hero
                if (isBottomFifteen && 
                    !nonExemptHeroes.slice(0, nonExemptIndex).some(h => 
                        nonExemptHeroes.indexOf(h) >= bottom15Index
                    )) {
                    row.classList.add('cut-line');
                    const label = document.createElement('span');
                    label.className = 'line-label cut-line-label';
                    label.textContent = 'Bottom 15 Cut Line';
                    rankCell.appendChild(label);
                }

                // Add exempt line before first exempt hero
                if ((isPossiblyExempt || isExempt) && 
                    !sortedData.slice(0, index).some(h => 
                        EXEMPT_HEROES.includes(h.handle) || 
                        TEAM_HEROES.includes(h.handle)
                    )) {
                    row.classList.add('exempt-line');
                    const label = document.createElement('span');
                    label.className = 'line-label exempt-line-label';
                    label.textContent = 'Protected / Exempt';
                    rankCell.appendChild(label);
                }

                // Hero cell with image and name
                const heroCell = document.createElement('td');
                heroCell.innerHTML = `
                    <div class="hero-cell">
                        <img src="${hero.profile_image}" alt="${hero.name}" class="hero-image">
                        <span>${hero.name}</span>
                        ${isBottomFifteen ? 
                            '<i class="fas fa-times-circle removed-indicator" title="Likely to be removed"></i>' : ''}
                        ${isPossiblyExempt ? 
                            '<i class="fas fa-question-circle exempt-indicator" title="Exempt?"></i>' : ''}
                        ${isExempt ? 
                            `<img src="../icons/ft_logo.webp" class="exempt-indicator" title="Exempt" style="width: 12px; height: 12px;">` : ''}
                    </div>
                `;
                row.appendChild(heroCell);

                // Tournament scores
                sortedTournaments.forEach(tournamentNum => {
                    const td = document.createElement('td');
                    td.className = 'number-cell';
                    const tournamentData = hero.tournaments[tournamentNum];
                    if (tournamentData) {
                        td.innerHTML = `
                            <span style="background-color: ${getColorForRank(tournamentData.fantasy_score, maxScore, true)}; 
                                        border-radius: 4px; 
                                        padding: 4px 8px; 
                                        color: white; 
                                        font-weight: 500;">
                                ${Math.round(tournamentData.fantasy_score)}
                            </span>
                        `;
                    } else {
                        td.textContent = '-';
                    }
                    row.appendChild(td);
                });

                // Average score
                const avgCell = document.createElement('td');
                avgCell.className = 'number-cell average-column';
                avgCell.innerHTML = `
                    <span style="background-color: ${getColorForRank(hero.avgScore, maxScore, true)}; 
                                border-radius: 4px; 
                                padding: 4px 8px; 
                                color: white; 
                                font-weight: 500;">
                        ${Math.round(hero.avgScore)}
                    </span>
                `;
                row.appendChild(avgCell);

                tableBody.appendChild(row);
            });
        }

        // Add sort handling
        let currentSort = { column: 'average', ascending: false };

        function handleSort(column) {
            if (currentSort.column === column) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = column;
                currentSort.ascending = column === 'handle';  // Default ascending for name sorting
            }
            displayTournamentData(window.seasonData, currentSort.column, currentSort.ascending);
        }

        // Update the DOMContentLoaded event handler
        document.addEventListener('DOMContentLoaded', async () => {
            const data = await fetchTournamentData();
            if (data) {
                // Add toggle event listener
                document.getElementById('showOutgoingToggle').addEventListener('change', () => {
                    displayTournamentData(window.seasonData, currentSort.column, currentSort.ascending);
                });

                // Add search event listener
                document.getElementById('heroSearch').addEventListener('input', () => {
                    displayTournamentData(window.seasonData, currentSort.column, currentSort.ascending);
                });
                
                displayTournamentData(data, 'average', false);
            }
        });
    </script>
</body>
</html>